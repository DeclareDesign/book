<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Research Design in the Social Sciences - 13&nbsp; Designing in code</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../library/" rel="next">
<link href="../declaration-diagnosis-redesign/design-example.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style type="text/css" media="print">
    body { visibility: hidden; display: none }
</style>
<script type="text/javascript">
    function createCookie(name, value, days) {
        var expires;
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (7 * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toGMTString();
        }
        else {
            expires = "";
        }
        document.cookie = name + "=" + value + expires + "; path=/";
    }
    
    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=");
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) {
                    c_end = document.cookie.length;
                }
                return unescape(document.cookie.substring(c_start, c_end));
            }
        }
        return "";
    }
    window.onload = () => {
      if (getCookie('popupShown') != 'yes') {
        const myModal = new bootstrap.Modal('#exampleModal');
        myModal.show();
        createCookie('popupShown', 'yes', 1)
      }
    }
</script><script src="../site_libs/kePrint-0.0.1/kePrint.js"></script><link href="../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../declaration-diagnosis-redesign/declaring-designs.html">Declaration, Diagnosis, Redesign</a></li><li class="breadcrumb-item"><a href="../declaration-diagnosis-redesign/declaration-in-code.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Designing in code</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Research Design in the Social Sciences</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../authors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About the authors</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../acknowledgements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgements</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../introduction/preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../introduction/what-is-a-research-design.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">What is a research design?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../introduction/research-design-principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Research design principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../introduction/getting-started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Declaration, Diagnosis, Redesign</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/declaring-designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Declaring designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/specifying-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Specifying the model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/defining-inquiry.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Defining the inquiry</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/crafting-research-strategy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Crafting a data strategy</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/choosing-answer-strategy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Choosing an answer strategy</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/redesigning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Redesigning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/diagnosing-designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Diagnosing designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/design-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Design example</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/declaration-in-code.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Designing in code</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../library/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Research design library</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/observational-descriptive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Observational : descriptive</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/observational-causal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Observational : causal</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/experimental-descriptive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Experimental : descriptive</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/experimental-causal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Experimental : causal</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/complex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Complex designs</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../lifecycle/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Research design lifecycle</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lifecycle/planning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Planning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lifecycle/realization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Realization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lifecycle/integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Integration</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../epilogue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Epilogue</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../errata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Errata</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar"><div class="quarto-margin-header"><div class="margin-header-item">
<p align="center">
<a style="color: black; text-decoration: none; font-size: 17px" target="_new" href="https://press.princeton.edu/books/paperback/9780691199573/research-design-in-the-social-sciences"> <img style="border: 1px solid darkgray; margin-bottom: 5px" width="100px" src="../figures/cover.jpg"><br>Preorder book</a>
</p>
</div></div>
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
    <ul>
<li>
<a href="#model-code" id="toc-model-code" class="nav-link active" data-scroll-target="#model-code"><span class="header-section-number">13.1</span> Model</a>
    <ul class="collapse">
<li><a href="#units" id="toc-units" class="nav-link" data-scroll-target="#units"><span class="header-section-number">13.1.1</span> Units</a></li>
    <li><a href="#sec-ch13s1ss2" id="toc-sec-ch13s1ss2" class="nav-link" data-scroll-target="#sec-ch13s1ss2"><span class="header-section-number">13.1.2</span> Unit characteristics</a></li>
    <li><a href="#potential-outcomes" id="toc-potential-outcomes" class="nav-link" data-scroll-target="#potential-outcomes"><span class="header-section-number">13.1.3</span> Potential outcomes</a></li>
    </ul>
</li>
    <li>
<a href="#inquiry-code" id="toc-inquiry-code" class="nav-link" data-scroll-target="#inquiry-code"><span class="header-section-number">13.2</span> Inquiry</a>
    <ul class="collapse">
<li><a href="#inquiries-among-subsets-of-units" id="toc-inquiries-among-subsets-of-units" class="nav-link" data-scroll-target="#inquiries-among-subsets-of-units"><span class="header-section-number">13.2.1</span> Inquiries among subsets of units</a></li>
    <li><a href="#inquiries-with-continuous-potential-outcomes" id="toc-inquiries-with-continuous-potential-outcomes" class="nav-link" data-scroll-target="#inquiries-with-continuous-potential-outcomes"><span class="header-section-number">13.2.2</span> Inquiries with continuous potential outcomes</a></li>
    <li><a href="#multiple-inquiries" id="toc-multiple-inquiries" class="nav-link" data-scroll-target="#multiple-inquiries"><span class="header-section-number">13.2.3</span> Multiple inquiries</a></li>
    </ul>
</li>
    <li>
<a href="#data-strategy-code" id="toc-data-strategy-code" class="nav-link" data-scroll-target="#data-strategy-code"><span class="header-section-number">13.3</span> Data strategy</a>
    <ul class="collapse">
<li><a href="#sampling" id="toc-sampling" class="nav-link" data-scroll-target="#sampling"><span class="header-section-number">13.3.1</span> Sampling</a></li>
    <li><a href="#treatment-assignment" id="toc-treatment-assignment" class="nav-link" data-scroll-target="#treatment-assignment"><span class="header-section-number">13.3.2</span> Treatment assignment</a></li>
    <li><a href="#measurement" id="toc-measurement" class="nav-link" data-scroll-target="#measurement"><span class="header-section-number">13.3.3</span> Measurement</a></li>
    </ul>
</li>
    <li>
<a href="#sec-ch13s4" id="toc-sec-ch13s4" class="nav-link" data-scroll-target="#sec-ch13s4"><span class="header-section-number">13.4</span> Answer strategy</a>
    <ul class="collapse">
<li><a href="#statistical-modeling-functions" id="toc-statistical-modeling-functions" class="nav-link" data-scroll-target="#statistical-modeling-functions"><span class="header-section-number">13.4.1</span> Statistical modeling functions</a></li>
    <li><a href="#tidying-statistical-modelling-function-output" id="toc-tidying-statistical-modelling-function-output" class="nav-link" data-scroll-target="#tidying-statistical-modelling-function-output"><span class="header-section-number">13.4.2</span> Tidying statistical modelling function output</a></li>
    <li><a href="#custom-answer-strategies" id="toc-custom-answer-strategies" class="nav-link" data-scroll-target="#custom-answer-strategies"><span class="header-section-number">13.4.3</span> Custom answer strategies</a></li>
    </ul>
</li>
    <li><a href="#declaration-code" id="toc-declaration-code" class="nav-link" data-scroll-target="#declaration-code"><span class="header-section-number">13.5</span> Declaration</a></li>
    <li>
<a href="#diagnosis-code" id="toc-diagnosis-code" class="nav-link" data-scroll-target="#diagnosis-code"><span class="header-section-number">13.6</span> Diagnosis</a>
    <ul class="collapse">
<li><a href="#sec-ch13s6ss1" id="toc-sec-ch13s6ss1" class="nav-link" data-scroll-target="#sec-ch13s6ss1"><span class="header-section-number">13.6.1</span> Working directly with the simulations data frame</a></li>
    </ul>
</li>
    <li><a href="#redesign-code" id="toc-redesign-code" class="nav-link" data-scroll-target="#redesign-code"><span class="header-section-number">13.7</span> Redesign</a></li>
    </ul>
<ul><li><a class="navlink nav-link" href="https://doi.org/10.7910/DVN/HYVPO5" data-scroll-target="https\://doi.org/10.7910/DVN/HYVPO5">Replication code and data</a></li></ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body" style="text-align: center">
        <img width="400px" src="https://book.declaredesign.org/figures/cover.jpg" style="margin-bottom: 15px"><br>
        Available for preorder from Princeton University Press
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <!--<button type="button" class="btn btn-primary">Buy book</button>-->
        <a href="https://www.amazon.com/Research-Design-Social-Sciences-Declaration/dp/0691199574/?&amp;_encoding=UTF8&amp;tag=declaredesign-20&amp;linkCode=ur2&amp;linkId=84be1f952d1d7aaaa5be867eade93474&amp;camp=1789&amp;creative=9325" target="_blank" class="btn btn-info" role="button">Amazon</a>
        <a href="https://press.princeton.edu/books/paperback/9780691199573/research-design-in-the-social-sciences" target="_blank" class="btn btn-info" role="button">Princeton University Press</a>
      </div>
    </div>
  </div>
</div>

<header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-ch13" class="quarto-section-identifier"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Designing in code</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>The software package <code>DeclareDesign</code> provides tools for declaration, diagnosis, and redesign in code using the <code>R</code> statistical package. We introduce each step of the process sequentially in this chapter. The first goal is to get you started using the software for many common types of designs and to illustrate how the software works for a few less common ones. The second aim is to deepen understanding of the four elements of research design and our algorithm for selecting one. By working through each part in code, you get a second shot at grappling with how to build and assess research designs.</p>
<section id="model-code" class="level2" data-number="13.1"><h2 data-number="13.1" class="anchored" data-anchor-id="model-code">
<span class="header-section-number">13.1</span> Model</h2>
<p>In this section, we describe how to declare models in practice in the <code>DeclareDesign</code> code language. We start with declarations of units and the hierarchical structures that contain them, then move on to declarations of the characteristics of units. An important feature of models is the set of potential outcomes associated with each unit, so we spend some time describing a few approaches for thinking about them. This section is meant as a reference guide so it covers common settings and a few uncommon ones as well.</p>
<section id="units" class="level3" data-number="13.1.1"><h3 data-number="13.1.1" class="anchored" data-anchor-id="units">
<span class="header-section-number">13.1.1</span> Units</h3>
<p>The model is first defined by the units under study. If there are 1,000 people who live in a city that you wish to learn about, but you don’t know anything else about them, you can declare:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu">declare_model</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Units often sit within multiple, sometimes overlapping geographic and social hierarchies. Households live on blocks that make up neighborhoods. Workers have jobs at firms and also often are represented by unions that sometimes represent workers in multiple firms (a non-nested hierarchy). These hierarchies are important to declare in the model as they often form the basis for why units are similar and different. Within <code>declare_model</code>, we define hierarchy using <code>add_level</code>, which adds a new level of hierarchy. This model declaration creates 100 households of varying size, then creates the appropriate number of individuals within households.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    households <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="fl">100</span>, </span>
<span>      N_members <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>, <span class="va">N</span>, </span>
<span>                         prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.25</span>, <span class="fl">0.25</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    individuals <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="va">N_members</span>, </span>
<span>      age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">18</span><span class="op">:</span><span class="fl">90</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Panel data have a different structure. For example, in a country-year panel dataset, we observe every country in every year. To create data with this structure, we first declare a country-level dataset, then a years-level dataset, then we join them. The join is accomplished in <code>cross_levels</code> call, which defines the variables we join by with <code>by = join_using(countries, years)</code>. In <code>cross_levels</code>, we also create the observation-level outcome variable, which is a function in this case of a country shock, a year shock, an observation shock, and a time trend.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    countries <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="fl">196</span>, </span>
<span>      country_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    years <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="fl">100</span>, </span>
<span>      time_trend <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span>,</span>
<span>      year_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, </span>
<span>      nest <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span>,</span>
<span>    observation <span class="op">=</span> <span class="fu">cross_levels</span><span class="op">(</span></span>
<span>      by <span class="op">=</span> <span class="fu">join_using</span><span class="op">(</span><span class="va">countries</span>, <span class="va">years</span><span class="op">)</span>,</span>
<span>      observation_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>      Y <span class="op">=</span> <span class="fl">0.01</span> <span class="op">*</span> <span class="va">time_trend</span> <span class="op">+</span> <span class="va">country_shock</span> <span class="op">+</span> <span class="va">year_shock</span> <span class="op">+</span> <span class="va">observation_shock</span> </span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="sec-ch13s1ss2" class="level3" data-number="13.1.2"><h3 data-number="13.1.2" class="anchored" data-anchor-id="sec-ch13s1ss2">
<span class="header-section-number">13.1.2</span> Unit characteristics</h3>
<p>We can describe the characteristics of units with either by supplying existing data or generating simulated data.</p>
<p>Here is an example of the simulation approach. We imagine 100 units with a characteristic <code>X</code> that is uniformly distributed between 0 and 100.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>, </span>
<span>    X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can use any of the enormous number of data simulation functions available in R for this purpose. Here we gather six functions we tend to use in our own declarations, but they are by no means exhaustive. Each function has arguments that govern exactly how the data are created; we chose arbitrary values here to show how they work. <a href="#fig-ch13num1">Figure&nbsp;<span>13.1</span></a> shows what these six look like for a 1,000 unit model.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    X1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, mean <span class="op">=</span> <span class="fl">5</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    X2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    X3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    X4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, size <span class="op">=</span> <span class="fl">5</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    X5 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html">rlnorm</a></span><span class="op">(</span><span class="va">N</span>, meanlog <span class="op">=</span> <span class="fl">0</span>, sdlog <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    X6 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-ch13num1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="../figures/figure-13-1.svg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;13.1: Six kinds of characteristics of units</figcaption></figure>
</div>
<p>Binary variables are very important in the socials science, but they can be particularly tricky to make, so we’ll spend a little more time on them. In a common way of thinking, binary variables are translations from a latent, continuous variable into an observed binary outcomes.</p>
<p>We can draw binary outcomes in one of three ways. First, we can simulate a binary outcomes using the <code>rbinom</code> function as we have already seen. The function <code>rbinom(N, size = 1, prob = 0.5)</code> flips 1 coin for each of <code>N</code> subjects with a constant latent probability of success across units.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M1</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">1000</span>, </span>
<span>    Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you believe the latent probability varies across units, you might want to set up latent variable first before the call to <code>rbinom</code>. A major reason to do it this way is to build in correlation between the binary outcome <code>Y</code> and some other variable, like <code>X</code> in this model declaration.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M2</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">1000</span>, </span>
<span>    latent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">latent</span><span class="op">)</span>,</span>
<span>    X <span class="op">=</span> <span class="va">latent</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A third way to create binary variable skips the call to <code>rbinom</code> altogether and creates a binary variable by assessing whether the latent variable exceeds some threshold, here <code>0.75</code>. A major reason to do this is when we want to control the sources of randomness. The latent variable is random because of the call to the <code>runif</code> function. If we pass the resulting latent probabilities to <code>rbinom</code> as in <code>M2</code>, then we add a <em>second</em> layer of randomness, the coin flips. If one layer is enough, then <code>M3</code> might be a more appropriate model declaration.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M3</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">1000</span>, </span>
<span>    latent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>    Y <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">latent</span> <span class="op">&gt;</span> <span class="fl">0.75</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="building-in-correlations-between-simulated-variables" class="level4" data-number="13.1.2.1"><h4 data-number="13.1.2.1" class="anchored" data-anchor-id="building-in-correlations-between-simulated-variables">
<span class="header-section-number">13.1.2.1</span> Building in correlations between simulated variables</h4>
<p>Most social science variables are interrelated. The correlations between variables may affect the quality of a research design in many ways. If we control for a variable in a regression to improve power, how much power we gain depends on the correlation between that variable and the outcome.</p>
<p>Here we walk through two main ways to create correlated variables. The first way is simply to make one variable a function of another:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M1</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    X1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>    X2 <span class="op">=</span> <span class="va">X1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The second way draws on an explicit draw from a <em>multivariate</em> distribution. The <code>mvrnorm</code> function in the <code>MASS</code> package generates draws from the multivariate normal distribution. We have to give it two means (<code>mu</code>) and a variance-covariance matrix (<code>Sigma</code>). The <code>draw_multivariate</code> function is a wrapper that makes these functions (that return more than one column of data!) play nicely with <code>declare_model</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    <span class="fu">draw_multivariate</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">X1</span>, <span class="va">X2</span><span class="op">)</span> <span class="op">~</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>      mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>      Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.3</span>, <span class="fl">0.3</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="building-in-correlations-within-clusters" class="level4" data-number="13.1.2.2"><h4 data-number="13.1.2.2" class="anchored" data-anchor-id="building-in-correlations-within-clusters">
<span class="header-section-number">13.1.2.2</span> Building in correlations within clusters</h4>
<p>A second important form of correlation is correlation within clusters, described by the intra-cluster correlation coefficient (ICC). When ICC is low, the within-cluster differences are similar across clusters. When it is high, clusters are more homogeneous within themselves and more heterogeneous across themselves. For more on clustered designs for surveys and for experiments, see <a href="../library/observational-descriptive.html#sec-ch15s2"><span>Section&nbsp;15.2</span></a> and <a href="../library/experimental-causal.html#sec-ch18s3"><span>Section&nbsp;18.3</span></a>.</p>
<p>We can introduce ICC using the <code>draw_normal_icc</code> function:</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span>households <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>,</span>
<span>                individuals <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span></span>
<span>                  N <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                  X <span class="op">=</span> <span class="fu">draw_normal_icc</span><span class="op">(</span></span>
<span>                    mean <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                    clusters <span class="op">=</span> <span class="va">households</span>,</span>
<span>                    ICC <span class="op">=</span> <span class="fl">0.65</span></span>
<span>                  <span class="op">)</span></span>
<span>                <span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="drawing-on-baseline-data" class="level4" data-number="13.1.2.3"><h4 data-number="13.1.2.3" class="anchored" data-anchor-id="drawing-on-baseline-data">
<span class="header-section-number">13.1.2.3</span> Drawing on baseline data</h4>
<p>In some cases, you will be in possession of baseline data about the units you plan to study. In the model, you can replace simulations with these data, as long as your goal is to make inferences just about those units you have data for. If you have a census of the dwelling characteristics of all houses in Philadelphia and you plan to conduct a survey of homeowner attitudes toward a new tax based on a sample stratified by dwelling type, you don’t need to simulate data for the dwelling characteristics. They are known. You will still need to simulate the data on attitudes, which you have not yet collected.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">baseline_data</span>,</span>
<span>    attitudes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="drawing-on-data-about-similar-units" class="level4" data-number="13.1.2.4"><h4 data-number="13.1.2.4" class="anchored" data-anchor-id="drawing-on-data-about-similar-units">
<span class="header-section-number">13.1.2.4</span> Drawing on data about similar units</h4>
<p>More commonly, you may have data on similar units from past studies or from a pilot study of your own. In these cases, you will not want to take their data as fixed, but resample from the data to simulate the population you are now drawing from. For example, if your baseline data is a random sample of households in Philadelphia, you may want to resample from that data to construct a simulated population of Philadelphia from which you can sample.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">baseline_data</span>, </span>
<span>    N <span class="op">=</span> <span class="fl">619505</span>, </span>
<span>    handler <span class="op">=</span> <span class="va">resample_data</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Drawing on past data holds several advantages. The natural correlations with clusters and across background characteristics are already built-in to your data. Using past data makes declaring your model easier, and in some cases can provide more realistic simulation of the data you end up collecting.</p>
</section><section id="unknown-heterogeneity" class="level4" data-number="13.1.2.5"><h4 data-number="13.1.2.5" class="anchored" data-anchor-id="unknown-heterogeneity">
<span class="header-section-number">13.1.2.5</span> Unknown heterogeneity</h4>
<p>Most declarations include unobserved variables, or unknown heterogeneity. These <code>U</code>s represent the lurking variables that confound our inferences and the variation in outcomes not correlated with observed values. In virtually every declaration in the book, we include a <code>U</code> term to represent these unobserved values.</p>
<p>At the point of declaration we face problems immediately: how much heterogeneity do we introduce, where, and of what kind?</p>
<p><code>M1</code> shows how to make rather benign unknown heterogeneity. <code>U</code> is normally distributed and only affects <code>Y</code>. The observed binary variable <code>X</code> is independent of <code>U</code> and affects <code>Y</code> in its own way.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>    X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    Y <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>M2</code> is more worrisome. <code>U</code> now affects <code>X</code> as well, by affecting the probability of <code>X</code> equaling one. See <a href="../library/observational-causal.html#sec-ch16s2"><span>Section&nbsp;16.2</span></a> for designs that face this sort of problem.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>    X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Y <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A further question for <code>U</code> is how much it should vary. This question is tougher to answer. <code>U</code> is an important source of variation in outcomes, so it needs to be calibrated in a way that the simulated data look like the data you expect to generate or encounter in the world. So our best advice here is to follow <a href="../introduction/research-design-principles.html#exm-designagnostically">Principle&nbsp;<span>3.2</span></a>: Design agnostically to figure out which ones seem reasonable.</p>
</section></section><section id="potential-outcomes" class="level3" data-number="13.1.3"><h3 data-number="13.1.3" class="anchored" data-anchor-id="potential-outcomes">
<span class="header-section-number">13.1.3</span> Potential outcomes</h3>
<p>We declare “potential” outcomes when describing counterfactual quantities.</p>
<p>The most straightforward way to declare potential outcomes is to make one variable per potential outcome. Here the two potential outcomes come from coin flip distributions with different success probabilities.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    Y_Z_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    Y_Z_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>potential_outcomes</code> function can do the same thing, but using R’s “formula” syntax, allowing us to write down potential outcomes in a “regression-like” way.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>, </span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">M</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By default, <code>potential_outcomes</code> imagines you are making two potential outcomes with respect to a treatment variable <code>Z</code> that can take on two values, 0 and 1.</p>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-modelposdraw" class="anchored">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Table&nbsp;13.1: One draw of two potential outcomes</caption>
<thead><tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">ID</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Y_Z_0</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Y_Z_1</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">001</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;">002</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">003</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;">004</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">005</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>But we can use <code>potential_outcomes</code> to describe multiple treatment conditions:</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>, </span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span></span>
<span>      <span class="va">Y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, </span>
<span>      conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">M</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-modelposdraw2" class="anchored">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Table&nbsp;13.2: One draw of three potential outcomes</caption>
<thead><tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">ID</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Y_Z_0</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Y_Z_1</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Y_Z_2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">001</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">002</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="odd">
<td style="text-align: center;">003</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;">004</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="odd">
<td style="text-align: center;">005</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>Or to describe multiple treatment factors (see <a href="../library/experimental-causal.html#sec-ch18s5"><span>Section&nbsp;18.5</span></a> on factorial experiments):</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>, </span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span></span>
<span>      <span class="va">Y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">Z1</span> <span class="op">+</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">Z2</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">Z1</span> <span class="op">*</span> <span class="va">Z2</span><span class="op">)</span>, </span>
<span>      conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, Z2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">M</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-modelposdraw3" class="anchored">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Table&nbsp;13.3: One draw of four potential outcomes</caption>
<thead><tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">ID</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Y_Z1_0_Z2_0</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Y_Z1_1_Z2_0</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Y_Z1_0_Z2_1</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Y_Z1_1_Z2_1</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">001</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">002</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">003</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;">004</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="odd">
<td style="text-align: center;">005</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<section id="effect-sizes" class="level4" data-number="13.1.3.1"><h4 data-number="13.1.3.1" class="anchored" data-anchor-id="effect-sizes">
<span class="header-section-number">13.1.3.1</span> Effect sizes</h4>
<p>We often want to consider a range of plausible effect sizes, for example when estimating the minimum detectable effect of a design. A strategy we commonly use is to sample the treatment effect in the model declaration itself, and then draw the potential outcomes using that single number. When we diagnose many times, then we will get many different treatment effects (here, <code>tau</code>), which we can then summarize in a diagnosis. <a href="#sec-ch13s6ss1"><span>Section&nbsp;13.6.1</span></a> describes how to create a plot of the power across values of <code>tau</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>, </span>
<span>    tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, </span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">tau</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Where do our expectations about effect sizes, and the minimal plausible effect size, come from? We may conduct meta-analysis of past studies when there are more than one sufficiently relevant estimates of the same effect, or a systematic review or literature review when they are less comparable but we may want to find a range (see <a href="../library/experimental-causal.html#sec-ch18s3"><span>Section&nbsp;18.3</span></a> for a discussion of meta-analysis). We may be tempted to conduct a pilot study to estimate the effect size. We need to be careful when doing so what to infer and how much to update from small pilot studies, as we discuss in <a href="../lifecycle/planning.html#sec-ch21s4"><span>Section&nbsp;21.4</span></a>, but we can often shrink our uncertainty about them. In the absence of pilot studies or past studies to draw on, we need to make educated guesses and understand under what true effect sizes our design will perform well and when it will not following <a href="../introduction/research-design-principles.html#exm-designholistically">Principle&nbsp;<span>3.1</span></a>: Design holistically.</p>
</section><section id="effect-heterogeneity" class="level4" data-number="13.1.3.2"><h4 data-number="13.1.3.2" class="anchored" data-anchor-id="effect-heterogeneity">
<span class="header-section-number">13.1.3.2</span> Effect heterogeneity</h4>
<p>Sometimes, the inquiry centers on treatment effect heterogeneity by subgroups. This heterogeneity has to be present in the model in order for the simulation to pick it up. Here we declare effect heterogeneity according to a binary covariate <code>X</code>. This example really shows off the utility of the formula syntax in the <code>potential_outcomes</code> function. We can write in our expectations about heterogeneity as if they were regression coefficients. Here, the “interaction term” is equal to <code>0.1</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>, </span>
<span>    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, </span>
<span>    X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span>  <span class="fl">0.3</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="fl">0.2</span><span class="op">*</span><span class="va">X</span> <span class="op">+</span> <span class="fl">0.1</span><span class="op">*</span><span class="va">Z</span><span class="op">*</span><span class="va">X</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="correlation-between-potential-outcomes" class="level4" data-number="13.1.3.3"><h4 data-number="13.1.3.3" class="anchored" data-anchor-id="correlation-between-potential-outcomes">
<span class="header-section-number">13.1.3.3</span> Correlation between potential outcomes</h4>
<p>Treated and untreated potential outcomes are typically highly correlated. When treatment effects are exactly homogeneous, the correlation is equal to 1. Rarely are potential outcomes <em>negatively</em> correlated, but it can occur. The sign and magnitude of the correlation especially affects the standard errors of estimates for causal effects (for more discussion of the correlation of potential outcomes in experiments and also standard error estimators, see <a href="redesigning.html#sec-ch10s3ss1"><span>Section&nbsp;11.3.1</span></a>).</p>
<p>We described some complexities of generating binary variables above. They transfer over to the generation of correlated potential outcomes in special ways. In the declarations below, <code>M1</code> generates uncorrelated potential outcomes, because the draws from <code>rbinom</code> are independent of one another. In <code>M2</code>, we still use <code>rbinom</code>, but with a transformation of the normally-distributed variable into a probability via <code>pnorm</code>. This allows the potential outcomes to be correlated because they are both influence by the same latent variable. Finally, in <code>M3</code>, we generate highly correlated potential outcomes because we peel off the layer of randomness introduced by <code>rbinom</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M1</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>, </span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">M2</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    latent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, </span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">latent</span> <span class="op">+</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">M3</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>, </span>
<span>    latent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, </span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">latent</span> <span class="op">+</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">&gt;</span> <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section></section><section id="inquiry-code" class="level2" data-number="13.2"><h2 data-number="13.2" class="anchored" data-anchor-id="inquiry-code">
<span class="header-section-number">13.2</span> Inquiry</h2>
<p>An inquiry is a summary function of events generated by a model. When we declare inquiries in code, we declare this summary function. Here, we declare a causal inquiry, the <code>mean</code> of the differences in two potential outcomes described in the model:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu">declare_model</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu">declare_inquiry</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Descriptive inquiries can be declared in a similar way: they are just functions of outcomes rather than potential outcomes.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu">declare_model</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu">declare_inquiry</span><span class="op">(</span>mean_Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="inquiries-among-subsets-of-units" class="level3" data-number="13.2.1"><h3 data-number="13.2.1" class="anchored" data-anchor-id="inquiries-among-subsets-of-units">
<span class="header-section-number">13.2.1</span> Inquiries among subsets of units</h3>
<p>We often want to learn about an inquiry defined among a subgroup of units. For example, if we are interested in the conditional average treatment effect (CATE) among units with X = 1, we can use the subset argument.</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>    X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span>  <span class="fl">0.3</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">X</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">I</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>CATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span>,</span>
<span>                  subset <span class="op">=</span> <span class="va">X</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Equivalently, we could use R’s <code>[]</code> syntax for subsetting:</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu">declare_inquiry</span><span class="op">(</span>CATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span><span class="op">[</span><span class="va">X</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">[</span><span class="va">X</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="inquiries-with-continuous-potential-outcomes" class="level3" data-number="13.2.2"><h3 data-number="13.2.2" class="anchored" data-anchor-id="inquiries-with-continuous-potential-outcomes">
<span class="header-section-number">13.2.2</span> Inquiries with continuous potential outcomes</h3>
<p>“Non-decomposable” inquiries are not as simple as an average over the units in the model. A common example arises with continuous potential outcomes. The regression discontinuity design described in <a href="../library/observational-causal.html#sec-ch16s5"><span>Section&nbsp;16.5</span></a> has an inquiry that is defined by two continuous functions of the running variable. The control function is a polynomial function representing the potential outcome under control and the treatment function is a different polynomial representing treated potential outcomes. The inquiry is the difference in the two functions evaluated at the cut-off point on the running variable. We declare it as follows:</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cutoff</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">control</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">4</span>, raw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="op">-</span><span class="fl">0.8</span>, <span class="fl">0.5</span>, <span class="fl">1.0</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="va">treatment</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">4</span>, raw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="op">-</span><span class="fl">1.5</span>, <span class="fl">0.5</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.15</span><span class="op">}</span></span>
<span></span>
<span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu">declare_inquiry</span><span class="op">(</span>LATE <span class="op">=</span> <span class="fu">treatment</span><span class="op">(</span><span class="va">cutoff</span><span class="op">)</span> <span class="op">-</span> <span class="fu">control</span><span class="op">(</span><span class="va">cutoff</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="multiple-inquiries" class="level3" data-number="13.2.3"><h3 data-number="13.2.3" class="anchored" data-anchor-id="multiple-inquiries">
<span class="header-section-number">13.2.3</span> Multiple inquiries</h3>
<p>In some designs, we are interested in the value of an inquiry for many units or for many types of units.</p>
<p>We can enumerate them one-by-one, to describe the average treatment effect, two conditional average treatment effects, and the difference between them.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu">declare_inquiry</span><span class="op">(</span></span>
<span>  ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span><span class="op">[</span><span class="va">X</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">[</span><span class="va">X</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  CATE_X0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span><span class="op">[</span><span class="va">X</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">[</span><span class="va">X</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  CATE_X1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span><span class="op">[</span><span class="va">X</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">[</span><span class="va">X</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  Difference_in_CATEs <span class="op">=</span> <span class="va">CATE_X1</span> <span class="op">-</span> <span class="va">CATE_X0</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the multilevel regression and poststratification (MRP) design in <a href="../library/observational-descriptive.html#sec-ch15s3"><span>Section&nbsp;15.3</span></a>, we want to know what the average opinion is in each state.</p>
<p>We declare an inquiry at the county level below. We rely on <code>group_by</code> and <code>summarize</code> from <code>dplyr</code> to write a function <code>MRP_inquiry</code> that uses a pipeline to group the data into counties and take the average of individual values. Now, our design targets an inquiry for each state.</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    counties <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">5</span>, county_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    individuals <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">50</span>, Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, mean <span class="op">=</span> <span class="va">county_mean</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">MRP_inquiry</span> <span class="op">&lt;-</span> </span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">data</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu">group_by</span><span class="op">(</span><span class="va">counties</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu">summarize</span><span class="op">(</span>mean_Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu">declare_inquiry</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">MRP_inquiry</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We discuss further in <a href="#sec-ch13s4"><span>Section&nbsp;13.4</span></a> how to link inquiries to answer strategies, including the case of multiple inquiries.</p>
</section></section><section id="data-strategy-code" class="level2" data-number="13.3"><h2 data-number="13.3" class="anchored" data-anchor-id="data-strategy-code">
<span class="header-section-number">13.3</span> Data strategy</h2>
<p>The three data strategy functions, <code>declare_sampling</code>, <code>declare_assignment</code>, and <code>declare_measurement</code> share most features in common. All three all add variables to the running data frame. <code>declare_sampling</code> is special in that it has a filter argument that determines which (if any) of the units should be dropped from the data and which should be retained as the sample. <code>declare_assignment</code>, and <code>declare_measurement</code> work in the exact same way as one another. The reason we separate them is to insist on the features of the data strategy, not for a deep programming reason.</p>
<section id="sampling" class="level3" data-number="13.3.1"><h3 data-number="13.3.1" class="anchored" data-anchor-id="sampling">
<span class="header-section-number">13.3.1</span> Sampling</h3>
<p>Declaring a sampling procedure involves constructing a variable indicating whether a unit is sampled or not and then filtering to sampled units. By default, you should create a variable <code>S</code> and <code>declare_sampling</code> will filter to sampled units by selecting those for which <code>S == 1</code>. You can rename your sampling variable or you can create more sampling variable to develop multistage sampling procedures, though you will need to alter the <code>filter</code> argument to reflect your changed procedure.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu">declare_sampling</span><span class="op">(</span>S <span class="op">=</span> <span class="fu">complete_rs</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For a multistage sample of districts then villages then households, we start out with all the data and sample at each stage then combine the three sampling indicators to form the final indicator <code>S</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">D</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_sampling</span><span class="op">(</span></span>
<span>    <span class="co"># sample 20 districts</span></span>
<span>    S_districts <span class="op">=</span> <span class="fu">cluster_rs</span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">districts</span>, n <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>    <span class="co"># within each district, sample 50 villages</span></span>
<span>    S_villages  <span class="op">=</span> <span class="fu">strata_and_cluster_rs</span><span class="op">(</span></span>
<span>      strata <span class="op">=</span> <span class="va">districts</span>,</span>
<span>      clusters <span class="op">=</span> <span class="va">villages</span>,</span>
<span>      strata_n <span class="op">=</span> <span class="fl">10</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># within each village select 25 households</span></span>
<span>    S_households  <span class="op">=</span> <span class="fu">strata_and_cluster_rs</span><span class="op">(</span></span>
<span>      strata <span class="op">=</span> <span class="va">villages</span>,</span>
<span>      clusters <span class="op">=</span> <span class="va">households</span>,</span>
<span>      strata_n <span class="op">=</span> <span class="fl">25</span></span>
<span>    <span class="op">)</span>,</span>
<span>    S <span class="op">=</span> <span class="va">S_districts</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">S_villages</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">S_households</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>    filter <span class="op">=</span> <span class="va">S</span> <span class="op">==</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You could also perform each of these steps in separate calls, and the data will be filtered appropriately step-to-step.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">D</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_sampling</span><span class="op">(</span>S <span class="op">=</span> <span class="fu">cluster_rs</span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">districts</span>, n <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_sampling</span><span class="op">(</span>S <span class="op">=</span> <span class="fu">strata_and_cluster_rs</span><span class="op">(</span></span>
<span>    strata <span class="op">=</span> <span class="va">districts</span>,</span>
<span>    clusters <span class="op">=</span> <span class="va">villages</span>,</span>
<span>    strata_n <span class="op">=</span> <span class="fl">10</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_sampling</span><span class="op">(</span>S <span class="op">=</span> <span class="fu">strata_and_cluster_rs</span><span class="op">(</span></span>
<span>    strata <span class="op">=</span> <span class="va">villages</span>,</span>
<span>    clusters <span class="op">=</span> <span class="va">households</span>,</span>
<span>    strata_n <span class="op">=</span> <span class="fl">25</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For many sampling designs, the probabilities of inclusion are not constant across units. We often need to adjust the answer strategy by reweighting the data according to the inverse of the inclusion probabilities. For common sampling designs in <code>randomizr</code>, we provide a built-in function for calculating these. If you roll your own sampling function, you will need to calculate them yourself. Here we show how to include probabilities from a stratified sampling design.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_sampling</span><span class="op">(</span></span>
<span>    S <span class="op">=</span> <span class="fu">strata_rs</span><span class="op">(</span>strata <span class="op">=</span> <span class="va">X</span>, strata_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    S_inclusion_probability <span class="op">=</span></span>
<span>      <span class="fu">strata_rs_probabilities</span><span class="op">(</span>strata <span class="op">=</span> <span class="va">X</span>,</span>
<span>                              strata_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="treatment-assignment" class="level3" data-number="13.3.2"><h3 data-number="13.3.2" class="anchored" data-anchor-id="treatment-assignment">
<span class="header-section-number">13.3.2</span> Treatment assignment</h3>
<p>The declaration of treatment assignment procedures works similarly to sampling, but we don’t drop any units. Treatment assignment probabilities often come into play just like sampling inclusion probabilities. You can use <code>randomizr</code> to calculate them for many common designs in a similar fashion, except that for treatment assignment in order to know with what probability you were assigned to the condition you are in we have to know what condition you are in. To obtain condition assignment probabilities we can declare:</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">D</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span></span>
<span>    Z <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span><span class="va">N</span>, m <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>    Z_condition_probability <span class="op">=</span> </span>
<span>      <span class="fu">obtain_condition_probabilities</span><span class="op">(</span>assignment <span class="op">=</span> <span class="va">Z</span>, m <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="measurement" class="level3" data-number="13.3.3"><h3 data-number="13.3.3" class="anchored" data-anchor-id="measurement">
<span class="header-section-number">13.3.3</span> Measurement</h3>
<p>Measurement procedures can be declared with <code>declare_measurement</code>. A common use is to generate an observed measurement from a latent value:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu">declare_model</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, latent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu">declare_measurement</span><span class="op">(</span>observed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">latent</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="revealing-potential-outcomes" class="level4" data-number="13.3.3.1"><h4 data-number="13.3.3.1" class="anchored" data-anchor-id="revealing-potential-outcomes">
<span class="header-section-number">13.3.3.1</span> Revealing potential outcomes</h4>
<p>The most common use of <code>declare_measurement</code> in this book, however, is for the “revelation” of potential outcomes according to treatment assignments. We build potential outcomes in <code>declare_model</code>, randomly assign in <code>declare_assignment</code>, then reveal outcomes in <code>declare_measurement</code>. We use the <code>reveal_outcomes</code> function to pick out the right potential outcome to reveal for each unit.</p>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">M</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span><span class="va">N</span>, m <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="index-creation" class="level4" data-number="13.3.3.2"><h4 data-number="13.3.3.2" class="anchored" data-anchor-id="index-creation">
<span class="header-section-number">13.3.3.2</span> Index creation</h4>
<p>Many designs use multiple measures of the same outcome, which are then combined into an index. For example, here’s a design with three measures of <code>Y</code> that we will combine using factor analysis. Here we use the <code>fa</code> function from the <code>psych</code> package which can be installed with <code>install.packages('psych')</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://personality-project.org/r/psych/">psych</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span></span>
<span>    index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/psych/man/fa.html">fa</a></span><span class="op">(</span></span>
<span>      r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">Y_1</span>, <span class="va">Y_2</span>, <span class="va">Y_3</span><span class="op">)</span>,</span>
<span>      nfactors <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      rotate <span class="op">=</span> <span class="st">"varimax"</span></span>
<span>    <span class="op">)</span><span class="op">$</span><span class="va">scores</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section></section><section id="sec-ch13s4" class="level2" data-number="13.4"><h2 data-number="13.4" class="anchored" data-anchor-id="sec-ch13s4">
<span class="header-section-number">13.4</span> Answer strategy</h2>
<p>An answer strategy is a function that provides answers to an inquiry. Declaring one in code involves selecting that function and linking the answer or answers it returns to one or more inquiries.</p>
<p>The functions we declare in <code>DeclareDesign</code> for answer strategies differ from those for the other elements of research design to reflect the two-step nature of many answer strategies. Often, first a statistical model (e.g., a linear regression) is fit to data, and then summaries of that model fit (e.g., the coefficient on a variable <code>X</code>, its standard error, <em>t</em>-statistic, p-value, and confidence interval) are combined to form an answer and its associated measures of uncertainty.</p>
<section id="statistical-modeling-functions" class="level3" data-number="13.4.1"><h3 data-number="13.4.1" class="anchored" data-anchor-id="statistical-modeling-functions">
<span class="header-section-number">13.4.1</span> Statistical modeling functions</h3>
<p>In <code>DeclareDesign</code>, we call these two steps <code>.method</code> and <code>.summary</code> (these arguments are preceded by <code>.</code>’s to avoid argument conflicts). The <code>.method</code> argument in <code>declare_estimator</code> can take almost any modelling function in <code>R</code> (e.g., <code>lm</code> for linear regression) and <code>.summary</code> consists of a summary function that calculates statistics from the fit such as <code>tidy</code> or <code>glance</code>. You can write your own model or model summary. When your answer strategy does not fit this two-step structure, you can (as with all <code>declare_</code> functions) write your own handler.</p>
<p>We break down each part of a standard answer strategy declaration using the example of a linear regression of the effect of a variable <code>Z</code> on an outcome <code>Y</code> in Declaration @ref(def:declaration-13-1}. The first argument in our <code>declare_estimator</code> step defines the method we will use, here <code>lm_robust</code> which is our function in the <code>estimatr</code> package for running linear regressions with robust standard errors. The second is the main argument for <code>lm_robust</code>, the formula for the regression specification, in this case Y on Z with no controls.</p>
<div id="def-ch13num1" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 13.1 </strong></span>Linear regression design</p>
<div class="cell" data-file="scripts_declarations/declaration_13.1.R">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">declaration_13.1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>                <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span></span>
<span>    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,</span>
<span>    .method <span class="op">=</span> <span class="va">lm_robust</span>,</span>
<span>    .summary <span class="op">=</span> <span class="va">tidy</span>,</span>
<span>    term <span class="op">=</span> <span class="st">"Z"</span>,</span>
<span>    inquiry <span class="op">=</span> <span class="st">"ATE"</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"OLS"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span class="math inline">\(~\)</span></p>
</div>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">draw_estimates</span><span class="op">(</span><span class="va">declaration_13.1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-linregest" class="anchored">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Table&nbsp;13.4: The estimate from one draw of the linear regression design</caption>
<thead><tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">estimator</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">estimate</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">std.error</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">statistic</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">p.value</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">conf.high</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">df</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">outcome</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">inquiry</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: center;">Z</td>
<td style="text-align: center;">OLS</td>
<td style="text-align: center;">0.03</td>
<td style="text-align: center;">0.2</td>
<td style="text-align: center;">0.16</td>
<td style="text-align: center;">0.87</td>
<td style="text-align: center;">-0.36</td>
<td style="text-align: center;">0.43</td>
<td style="text-align: center;">98</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">ATE</td>
</tr></tbody>
</table>
</div>


</div>
</div>
</section><section id="tidying-statistical-modelling-function-output" class="level3" data-number="13.4.2"><h3 data-number="13.4.2" class="anchored" data-anchor-id="tidying-statistical-modelling-function-output">
<span class="header-section-number">13.4.2</span> Tidying statistical modelling function output</h3>
<p>Let’s unpack the <code>.summary</code> argument. In this case we sent the <code>tidy</code> function from the <code>broom</code> package (the default). Understanding what <code>tidy</code> does opens a window into the way we match estimates and estimands. The tidy function takes many model fit objects and returns a data frame in which rows represent estimates and columns represent statistics about that estimate. The columns typically include the estimate itself (<code>estimate</code>), an estimated standard error (<code>std.error</code>), a test statistic of some kind reported by the model function such as a <em>t</em>-statistic or <em>Z</em>-statistic (<code>statistic</code>), a p-value based on the test statistic (<code>p.value</code>), a confidence interval (<code>conf.low</code>, <code>conf.high</code>), and the degrees of freedom of the test statistic if relevant (<code>df</code>).</p>
<p>A key column in the output of tidy is <code>term</code>, which represents which coefficient (term) is being described in that row. The term column uniquely identifies the row. We will often need to use the term column in conjunction with the name of the estimator to link estimates to estimands when there are more than one. If in the regression we pull out two coefficients (e.g., for treatment indicator 1 and for treatment indicator 2), we need to be able to link those to separate inquiries representing the true effect of treatment 1 and the true effect of treatment 2. Term is our tool for doing so. The default is for term to pick the first coefficient that is not the intercept, so for the regression <code>Y ~ Z</code> there will be an intercept and then the coefficient on <code>Z</code> which is what will be picked.</p>
<p>The <code>inquiry</code> argument defines which inquiry or inquiries the estimates will be linked to. In this case, we link to a single inquiry, the ATE. You can also declare an estimator that shoots at multiple inquiries: <code>declare_estimator(Y ~ Z, .method = lm_robust, term = "Z", inquiry = c("ATE", "ATT"))</code> - useful for learning how well an estimator does for different targets. When we run the answer strategy on data, we get two additional pieces of information tacked on to the model summary data frame: the name of the estimator, which comes from the <code>label</code> argument, and the inquiry. The unit of analysis of a diagnosis is the inquiry-estimator pair, so if you link an estimator to multiple inquiries, then there will be a row for each inquiry.</p>
<p>We can use other summary functions to obtain other summaries of the fitted model. For example <code>glance</code> will provide model fit statistics such as the r-squared:</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, </span>
<span>                       .method <span class="op">=</span> <span class="va">lm_robust</span>, </span>
<span>                       .summary <span class="op">=</span> <span class="va">glance</span><span class="op">)</span></span>
<span></span>
<span><span class="va">declaration_13.1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">draw_data</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">A</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-modelfitstats" class="anchored">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Table&nbsp;13.5: The model fit statistics from one draw of the linear regression design</caption>
<thead><tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">r.squared</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">adj.r.squared</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">statistic</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">p.value</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">df.residual</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">nobs</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">se_type</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: center;">0</td>
<td style="text-align: center;">-0.01</td>
<td style="text-align: center;">0.16</td>
<td style="text-align: center;">0.69</td>
<td style="text-align: center;">98</td>
<td style="text-align: center;">100</td>
<td style="text-align: center;">HC2</td>
</tr></tbody>
</table>
</div>


</div>
</div>
<p>When neither <code>tidy</code> nor <code>glance</code> works well for your answer strategy, you can write your own summary function. Below, we build up a tidy function for the <code>lm</code> model from scratch. (One is already built-in to the <code>broom</code> package, but we do so here to illustrate how you can write your own for a function that does not already have one.) Before you start to write your own summary function, check whether one exists on the <a href="https://broom.tidymodels.org/articles/available-methods.html">Broom Web site</a>.</p>
<p>There are three sets for a tidy function:</p>
<ol type="1">
<li><p>Pull out statistics from the model fit object. You can extract out any statistics and transform them in any relevant way.</p></li>
<li><p>Return a data frame (or <code>tibble</code>).</p></li>
<li><p>Name your estimates in a common format that works across all tidy functions. The estimate column should be called “estimate”, the standard error column “std.error”, etc., as described earlier. However, if you want to add other statistics from the model fit that you will diagnose, you can and you can name them whatever you want.</p></li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tidy_lm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># calculate estimates by grabbing the coefficients from the model fit</span></span>
<span>  <span class="va">estimate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">lm</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># get the names of the coefficients (e.g., "(Intercept)", "Z")</span></span>
<span>  <span class="co">#   we will call these "term" to represent regression terms</span></span>
<span>  <span class="va">term</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">estimates</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># calculate the standard error by grabbing the variance-covariance</span></span>
<span>  <span class="co">#   matrix, then pulling the diagonal elements of it and taking the </span></span>
<span>  <span class="co">#   square root to transform from variances to standard errors</span></span>
<span>  <span class="va">std.error</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html">vcov</a></span><span class="op">(</span><span class="va">lm</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># return a tibble with term, estimate, and std.error</span></span>
<span>  <span class="fu">tibble</span><span class="op">(</span>term <span class="op">=</span> <span class="va">term</span>, estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>, std.error <span class="op">=</span> <span class="va">std.error</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">declare_estimator</span><span class="op">(</span></span>
<span>  <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,</span>
<span>  .method <span class="op">=</span> <span class="va">lm</span>,</span>
<span>  .summary <span class="op">=</span> <span class="va">tidy_lm</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In other cases, you may want to build on functions that inter-operate with the <code>broom</code> functions to do specialized summary tasks like calculating marginal effects or predicted effects. The <code>margins</code> function from the <code>margins</code> package calculates marginal effects and the <code>predictions</code> package from the <code>predictions</code> package are especially useful and work well with the <code>tidy</code> workflow. To calculate marginal effects, run margins and then tidy as your model summary:</p>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tidy_margins</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="fu">margins</span><span class="op">(</span><span class="va">x</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">declare_estimator</span><span class="op">(</span></span>
<span>  <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span>,</span>
<span>  .method <span class="op">=</span> <span class="va">glm</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span><span class="st">"logit"</span><span class="op">)</span>,</span>
<span>  .summary <span class="op">=</span> <span class="va">tidy_margins</span>,</span>
<span>  term <span class="op">=</span> <span class="st">"Z"</span></span>
<span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="custom-answer-strategies" class="level3" data-number="13.4.3"><h3 data-number="13.4.3" class="anchored" data-anchor-id="custom-answer-strategies">
<span class="header-section-number">13.4.3</span> Custom answer strategies</h3>
<p>If your answer strategy does not use a <code>.method</code> function, you’ll need to provide a function that takes <code>data</code> as an input and returns a data frame with the estimate. Set the handler to be <code>label_estimator(your_function_name)</code> to take advantage of DeclareDesign’s mechanism for matching inquiries to estimators. When you use <code>label_estimator</code>, you can provide an inquiry, and DeclareDesign will keep track of which estimates match each inquiry. (It simply adds a column to your tidy estimates data frame for the name of the estimator and the inquiry.) For example, to calculate the mean of an outcome, you could write your own estimator in this way:</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">my_estimator</span> <span class="op">&lt;-</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="fu">declare_estimator</span><span class="op">(</span>handler <span class="op">=</span> <span class="fu">label_estimator</span><span class="op">(</span><span class="va">my_estimator</span><span class="op">)</span>,</span>
<span>                  label <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>                  inquiry <span class="op">=</span> <span class="st">"Y_bar"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Often you may want to construct a test as part of your answer strategy that does not target an inquiry. Our <code>declare_test</code> function works just like <code>declare_estimator</code> except you need not include an inquiry. The <code>label_test</code> infrastructure works just like <code>label_estimator</code> for custom test functions.</p>
</section></section><section id="declaration-code" class="level2" data-number="13.5"><h2 data-number="13.5" class="anchored" data-anchor-id="declaration-code">
<span class="header-section-number">13.5</span> Declaration</h2>
<p>To construct a research <em>design</em> object that we can operate on — diagnose it, redesign it, draw data from it, etc. — we add research design elements together with the <code>+</code> operator. In <a href="#def-ch13num2">Declaration&nbsp;<span>13.2</span></a>, we first create each design step separately, then concatenate the steps. This style of declaration is useful when you want to mix-and-match design elements. Usually, though, we just add steps together without creating the each step first.</p>
<div id="def-ch13num2" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 13.2 </strong></span>Declaration of two-arm randomized experiment</p>
<div class="cell" data-file="scripts_declarations/declaration_13.2.R">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>                X <span class="op">=</span> <span class="va">U</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span>  <span class="fl">0.2</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">inquiry</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sampling</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_sampling</span><span class="op">(</span>S <span class="op">=</span> <span class="fu">simple_rs</span><span class="op">(</span><span class="va">N</span>, prob <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>, </span>
<span>                   filter <span class="op">=</span> <span class="va">S</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">assignment</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">measurement</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">answer_strategy</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, inquiry <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"DIM"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span>, inquiry <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"OLS"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># as separate elements</span></span>
<span><span class="va">declaration_13.2</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">model</span> <span class="op">+</span></span>
<span>  <span class="va">inquiry</span> <span class="op">+</span></span>
<span>  <span class="va">sampling</span> <span class="op">+</span></span>
<span>  <span class="va">assignment</span> <span class="op">+</span></span>
<span>  <span class="va">measurement</span> <span class="op">+</span></span>
<span>  <span class="va">answer_strategy</span></span>
<span></span>
<span><span class="co"># equivalently, and more compactly:</span></span>
<span><span class="va">declaration_13.2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>                X <span class="op">=</span> <span class="va">U</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span>  <span class="fl">0.2</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_sampling</span><span class="op">(</span>S <span class="op">=</span> <span class="fu">simple_rs</span><span class="op">(</span><span class="va">N</span>, prob <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>                   filter <span class="op">=</span> <span class="va">S</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, inquiry <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"DIM"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span>, inquiry <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"OLS"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Order matters in declaring designs. We can think of the order of the declaration as the temporal order in which the elements are realized. Below, since the inquiry comes before sampling and assignment, the inquiry is a <em>population</em> inquiry, the population average treatment effect.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>PATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">sampling</span> <span class="op">+</span></span>
<span>  <span class="va">assignment</span> <span class="op">+</span></span>
<span>  <span class="va">measurement</span> <span class="op">+</span></span>
<span>  <span class="va">answer_strategy</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could instead define our inquiry as a <em>sample</em> average treatment effect by putting the inquiry after sampling:</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model</span> <span class="op">+</span></span>
<span>  <span class="va">sampling</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>SATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">assignment</span> <span class="op">+</span></span>
<span>  <span class="va">measurement</span> <span class="op">+</span> </span>
<span>  <span class="va">answer_strategy</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="diagnosis-code" class="level2" data-number="13.6"><h2 data-number="13.6" class="anchored" data-anchor-id="diagnosis-code">
<span class="header-section-number">13.6</span> Diagnosis</h2>
<p>Once a design is declared in code, diagnosing it is usually the easy part. <code>diagnose_design</code> handles all the details and bookkeeping for you. In this section, we outline how to conduct a diagnosis using our default tools for standard diagnoses and also how you might operate directly on the simulations for more complicated analyses.</p>
<div id="lem-ch10num6" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 13.1 </strong></span>Diagnosis of two-arm randomized experiment</p>
<p>Here we use <code>diagnose_design</code> to diagnose the design. By default, we conduct 500 simulations and characterize simulation error with 100 bootstraps of the diagnosands. <code>reshape_diagnosis</code> prepares the output for nice printing.</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diagnosis_13.1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">declaration_13.2</span>,</span>
<span>                  sims <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                  bootstrap_sims <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu">reshape_diagnosis</span><span class="op">(</span><span class="va">diagnosis_13.1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-diagnosis13s1" class="anchored">
<table data-quarto-postprocess="true" class="table table-sm table-striped small">
<caption>Table&nbsp;13.6: Design diagnosis of two-arm randomized experiment</caption>
<thead><tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">Design</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Inquiry</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Estimator</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Outcome</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Term</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">N Sims</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Mean Estimand</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Mean Estimate</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Bias</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">SD Estimate</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">RMSE</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Power</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Coverage</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">DIM</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">2000</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">-0.00</td>
<td style="text-align: center;">0.14</td>
<td style="text-align: center;">0.14</td>
<td style="text-align: center;">0.29</td>
<td style="text-align: center;">0.96</td>
</tr>
<tr class="even">
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">(0.00)</td>
<td style="text-align: center;">(0.00)</td>
<td style="text-align: center;">(0.00)</td>
<td style="text-align: center;">(0.00)</td>
<td style="text-align: center;">(0.00)</td>
<td style="text-align: center;">(0.01)</td>
<td style="text-align: center;">(0.00)</td>
</tr>
<tr class="odd">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">OLS</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">2000</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">-0.00</td>
<td style="text-align: center;">0.06</td>
<td style="text-align: center;">0.06</td>
<td style="text-align: center;">0.87</td>
<td style="text-align: center;">0.95</td>
</tr>
<tr class="even">
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">(0.00)</td>
<td style="text-align: center;">(0.00)</td>
<td style="text-align: center;">(0.00)</td>
<td style="text-align: center;">(0.00)</td>
<td style="text-align: center;">(0.00)</td>
<td style="text-align: center;">(0.01)</td>
<td style="text-align: center;">(0.00)</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>We can “tidy” the results of the diagnosis for easier printing and plotting of the results. Here, each row is an estimate of a diagnosand and then uncertainty statistics such as the standard error and 95% confidence interval around the diagnosand estimate.</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">diagnosis_13.1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-diagnosis131tidy" class="anchored">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Table&nbsp;13.7: Tidied diagnosis of two-arm randomized experiment</caption>
<thead><tr class="header">
<th style="text-align: center;" data-quarto-table-cell-role="th">design</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">inquiry</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">estimator</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">outcome</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">diagnosand</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">estimate</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">std.error</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">conf.low</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">conf.high</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">DIM</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">mean_estimand</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">0.20</td>
</tr>
<tr class="even">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">DIM</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">mean_estimate</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.19</td>
<td style="text-align: center;">0.20</td>
</tr>
<tr class="odd">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">DIM</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">bias</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">-0.01</td>
<td style="text-align: center;">0.00</td>
</tr>
<tr class="even">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">DIM</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">sd_estimate</td>
<td style="text-align: center;">0.14</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.13</td>
<td style="text-align: center;">0.14</td>
</tr>
<tr class="odd">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">DIM</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">rmse</td>
<td style="text-align: center;">0.14</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.13</td>
<td style="text-align: center;">0.14</td>
</tr>
<tr class="even">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">DIM</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">power</td>
<td style="text-align: center;">0.29</td>
<td style="text-align: center;">0.01</td>
<td style="text-align: center;">0.27</td>
<td style="text-align: center;">0.31</td>
</tr>
<tr class="odd">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">DIM</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">coverage</td>
<td style="text-align: center;">0.96</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.95</td>
<td style="text-align: center;">0.97</td>
</tr>
<tr class="even">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">OLS</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">mean_estimand</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">0.20</td>
</tr>
<tr class="odd">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">OLS</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">mean_estimate</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.20</td>
<td style="text-align: center;">0.20</td>
</tr>
<tr class="even">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">OLS</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">bias</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.00</td>
</tr>
<tr class="odd">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">OLS</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">sd_estimate</td>
<td style="text-align: center;">0.06</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.06</td>
<td style="text-align: center;">0.06</td>
</tr>
<tr class="even">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">OLS</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">rmse</td>
<td style="text-align: center;">0.06</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.06</td>
<td style="text-align: center;">0.06</td>
</tr>
<tr class="odd">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">OLS</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">power</td>
<td style="text-align: center;">0.87</td>
<td style="text-align: center;">0.01</td>
<td style="text-align: center;">0.86</td>
<td style="text-align: center;">0.89</td>
</tr>
<tr class="even">
<td style="text-align: center;">declaration_13.2</td>
<td style="text-align: center;">ATE</td>
<td style="text-align: center;">OLS</td>
<td style="text-align: center;">Y</td>
<td style="text-align: center;">Z</td>
<td style="text-align: center;">coverage</td>
<td style="text-align: center;">0.95</td>
<td style="text-align: center;">0.00</td>
<td style="text-align: center;">0.94</td>
<td style="text-align: center;">0.96</td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
</div>
<section id="sec-ch13s6ss1" class="level3" data-number="13.6.1"><h3 data-number="13.6.1" class="anchored" data-anchor-id="sec-ch13s6ss1">
<span class="header-section-number">13.6.1</span> Working directly with the simulations data frame</h3>
<p>In some cases, it is useful to operate directly on the simulations produced by <code>diagnose_design</code>. For example, we might want to calculate diagnosands manually or plot simulations.</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">simulations_df</span> <span class="op">&lt;-</span> <span class="fu">get_simulations</span><span class="op">(</span><span class="va">diagnosis_13.1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once we have the simulations, we can summarize them using <code>dplyr</code> tools:</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">simulations_df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">design</span>, <span class="va">inquiry</span>, <span class="va">estimator</span>, <span class="va">term</span>, <span class="va">outcome</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span></span>
<span>    bias <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimate</span> <span class="op">-</span> <span class="va">estimand</span><span class="op">)</span>,</span>
<span>    rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">estimate</span> <span class="op">-</span> <span class="va">estimand</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    power <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">p.value</span> <span class="op">&lt;=</span> <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    coverage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimand</span> <span class="op">&lt;=</span> <span class="va">conf.high</span> <span class="op">&amp;</span> <span class="va">estimand</span> <span class="op">&gt;=</span> <span class="va">conf.low</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plotting simulations using <code>ggplot2</code> is often a great way to gain a deeper sense of the properties of the design.</p>
<p>The answer strategy for <a href="#def-ch13num1">Declaration&nbsp;<span>13.1</span></a> includes two estimators, so our aim here is to create histograms of the sampling distribution for each of them. This goal is best accomplished using <code>geom_histogram</code>, then faceting by estimator using <code>facet_wrap</code>. We often want to overlay the true value of the estimand on these plots, which we do here with <code>geom_vline</code>. Notice that in order to do, we had to create a <code>summary_df</code> that includes the value of the estimand. The resulting plot shows that both the adjusted and unadjusted estimators are unbiased, but that the sampling distribution of the adjusted estimator is tighter.</p>
<div class="cell">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># first create summary for vertical lines</span></span>
<span><span class="va">summary_df</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">simulations_df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">estimator</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">summarize</span><span class="op">(</span>estimand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">estimand</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># then plot simulations</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">simulations_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>                 bins <span class="op">=</span> <span class="fl">40</span>, fill <span class="op">=</span> <span class="st">"#72B4F3"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_vline</span><span class="op">(</span>data <span class="op">=</span> <span class="va">summary_df</span>,</span>
<span>             <span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">estimand</span><span class="op">)</span>,</span>
<span>             lty <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"#C6227F"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, y <span class="op">=</span> <span class="fl">300</span>, x <span class="op">=</span> <span class="fl">0</span>, label <span class="op">=</span> <span class="st">"Estimand"</span>,</span>
<span>           color <span class="op">=</span> <span class="st">"#C6227F"</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">estimator</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Estimate"</span>, y <span class="op">=</span> <span class="st">"Count of simulations"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-ch13num2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="../figures/figure-13-2.svg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;13.2: Example visualization of a diagnosis</figcaption></figure>
</div>
<p>Diagnosing over model uncertainty is a crucial part of diagnosis. We want to understand when our design performs well and when it does not. A classical example of this in wide practice is the power curve. In a power curve, we display the power of a design (the probability of achieving statistical significance) along different possible effect sizes. In this setting, plotting the simulations directly with an indicator for whether that simulation’s estimate is statistically significant is the easiest way to learn about the properties of the design.</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">design</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">200</span>,</span>
<span>    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.0</span>, <span class="fl">0.5</span><span class="op">)</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, inquiry <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">simulations_df</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">design</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">get_simulations</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>significant <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">p.value</span> <span class="op">&lt;=</span> <span class="fl">0.05</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">simulations_df</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">stat_smooth</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">estimand</span>, <span class="va">significant</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">'loess'</span>, color <span class="op">=</span> <span class="st">"#3564ED"</span>, fill <span class="op">=</span> <span class="st">"#72B4F3"</span>, formula <span class="op">=</span> <span class="st">'y ~ x'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.8</span>, color <span class="op">=</span> <span class="st">"#C6227F"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">0.85</span>, label <span class="op">=</span> <span class="st">"Conventional power threshold = 0.8"</span>, hjust <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"#C6227F"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_cartesian</span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Model parameter: true effect size"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Diagnosand: statistical power"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-ch13num3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="../figures/figure-13-3.svg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;13.3: Example visualization of a diagnosis</figcaption></figure>
</div>
</section></section><section id="redesign-code" class="level2" data-number="13.7"><h2 data-number="13.7" class="anchored" data-anchor-id="redesign-code">
<span class="header-section-number">13.7</span> Redesign</h2>
<p>This chapter already displays the main computational approaches to redesign. The basic principle is that we need to create a list of designs which then get passed to <code>simulate_designs</code> or <code>diagnose_designs</code>. (The plural versions of these functions are identical to their singular counterparts, we just provide both to allow the code to speak for itself a little more easily).</p>
<p>You can make lists of designs to redesign across directly with <code>list</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">designs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">design1</span>, <span class="va">design2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>More often, you’ll vary designs over a parameter with <code>redesign</code>. Here, we’re imagining we’ve already declared a <code>design</code> that has an <code>N</code> parameter that we allow to have 3 values.</p>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">designs</span> <span class="op">&lt;-</span> <span class="fu">redesign</span><span class="op">(</span><span class="va">design</span>, N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">200</span>, <span class="fl">300</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Whichever way you use to create <code>designs</code>, you can then diagnose all of the designs in the list with:</p>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">designs</span> <span class="op">&lt;-</span> <span class="fu">diagnose_designs</span><span class="op">(</span><span class="va">designs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../declaration-diagnosis-redesign/design-example.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Design example</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../library/" class="pagination-link">
        <span class="nav-page-text">Research design library</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>