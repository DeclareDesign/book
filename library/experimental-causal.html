<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>18&nbsp; Experimental : causal – Research Design in the Social Sciences</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../library/complex.html" rel="next">
<link href="../library/experimental-descriptive.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-a34d670291f06f286357e447776a572a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-MMK8CF9JC0"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-MMK8CF9JC0', { 'anonymize_ip': true});
</script><style type="text/css" media="print">
    body { visibility: hidden; display: none }
</style>
<script type="text/javascript">
    function createCookie(name, value, days) {
        var expires;
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (7 * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toGMTString();
        }
        else {
            expires = "";
        }
        document.cookie = name + "=" + value + expires + "; path=/";
    }
    
    function getCookie(c_name) {
        if (document.cookie.length > 0) {
            c_start = document.cookie.indexOf(c_name + "=");
            if (c_start != -1) {
                c_start = c_start + c_name.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) {
                    c_end = document.cookie.length;
                }
                return unescape(document.cookie.substring(c_start, c_end));
            }
        }
        return "";
    }
    window.onload = () => {
      if (getCookie('popupShown') != 'yes') {
        const myModal = new bootstrap.Modal('#exampleModal');
        myModal.show();
        createCookie('popupShown', 'yes', 1)
      }
    }
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../library/">Research design library</a></li><li class="breadcrumb-item"><a href="../library/experimental-causal.html"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Experimental : causal</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Research Design in the Social Sciences</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../authors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About the authors</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../acknowledgements.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Acknowledgements</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../introduction/preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../introduction/what-is-a-research-design.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">What is a research design?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../introduction/research-design-principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Research design principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../introduction/getting-started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Declaration, diagnosis, redesign</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/declaring-designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Declaring designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/specifying-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Specifying the model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/defining-inquiry.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Defining the inquiry</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/crafting-data-strategy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Crafting a data strategy</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/choosing-answer-strategy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Choosing an answer strategy</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/diagnosing-designs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Diagnosing designs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/redesigning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Redesigning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/design-example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Design example</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../declaration-diagnosis-redesign/declaration-in-code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Designing in code</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../library/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Research design library</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/observational-descriptive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Observational : descriptive</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/observational-causal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Observational : causal</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/experimental-descriptive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Experimental : descriptive</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/experimental-causal.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Experimental : causal</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/complex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Complex designs</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../lifecycle/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Research design lifecycle</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lifecycle/planning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Planning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lifecycle/realization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Realization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lifecycle/integration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Integration</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../epilogue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Epilogue</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../student-teacher.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Student and teacher resources</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../errata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Errata</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar"><div class="quarto-margin-header"><div class="margin-header-item">
<p align="center">
<a style="color: black; text-decoration: none; font-size: 17px" target="_new" href="https://press.princeton.edu/books/paperback/9780691199573/research-design-in-the-social-sciences"> <img style="border: 1px solid darkgray; margin-bottom: 5px" width="100px" src="../figures/cover.jpg"><br>Buy book</a>
</p>
</div></div>
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#sec-ch18s1" id="toc-sec-ch18s1" class="nav-link active" data-scroll-target="#sec-ch18s1"><span class="header-section-number">18.1</span> Two-arm randomized experiments</a>
  <ul class="collapse">
<li><a href="#using-covariates-to-increase-precision" id="toc-using-covariates-to-increase-precision" class="nav-link" data-scroll-target="#using-covariates-to-increase-precision"><span class="header-section-number">18.1.1</span> Using covariates to increase precision</a></li>
  <li><a href="#can-controlling-for-covariates-hurt-precision" id="toc-can-controlling-for-covariates-hurt-precision" class="nav-link" data-scroll-target="#can-controlling-for-covariates-hurt-precision"><span class="header-section-number">18.1.2</span> Can controlling for covariates hurt precision?</a></li>
  <li><a href="#design-examples" id="toc-design-examples" class="nav-link" data-scroll-target="#design-examples"><span class="header-section-number">18.1.3</span> Design examples</a></li>
  </ul>
</li>
  <li>
<a href="#block-randomized-experiments" id="toc-block-randomized-experiments" class="nav-link" data-scroll-target="#block-randomized-experiments"><span class="header-section-number">18.2</span> Block-randomized experiments</a>
  <ul class="collapse">
<li><a href="#why-does-blocking-help" id="toc-why-does-blocking-help" class="nav-link" data-scroll-target="#why-does-blocking-help"><span class="header-section-number">18.2.1</span> Why does blocking help?</a></li>
  <li><a href="#design-examples-1" id="toc-design-examples-1" class="nav-link" data-scroll-target="#design-examples-1"><span class="header-section-number">18.2.2</span> Design examples</a></li>
  </ul>
</li>
  <li>
<a href="#sec-ch18s3" id="toc-sec-ch18s3" class="nav-link" data-scroll-target="#sec-ch18s3"><span class="header-section-number">18.3</span> Cluster-randomized experiments</a>
  <ul class="collapse">
<li><a href="#design-examples-2" id="toc-design-examples-2" class="nav-link" data-scroll-target="#design-examples-2"><span class="header-section-number">18.3.1</span> Design examples</a></li>
  </ul>
</li>
  <li>
<a href="#sec-ch18s4" id="toc-sec-ch18s4" class="nav-link" data-scroll-target="#sec-ch18s4"><span class="header-section-number">18.4</span> Subgroup designs</a>
  <ul class="collapse">
<li><a href="#design-examples-3" id="toc-design-examples-3" class="nav-link" data-scroll-target="#design-examples-3"><span class="header-section-number">18.4.1</span> Design examples</a></li>
  </ul>
</li>
  <li>
<a href="#sec-ch18s5" id="toc-sec-ch18s5" class="nav-link" data-scroll-target="#sec-ch18s5"><span class="header-section-number">18.5</span> Factorial experiments</a>
  <ul class="collapse">
<li><a href="#avoiding-misleading-inferences" id="toc-avoiding-misleading-inferences" class="nav-link" data-scroll-target="#avoiding-misleading-inferences"><span class="header-section-number">18.5.1</span> Avoiding misleading inferences</a></li>
  <li><a href="#design-examples-4" id="toc-design-examples-4" class="nav-link" data-scroll-target="#design-examples-4"><span class="header-section-number">18.5.2</span> Design examples</a></li>
  </ul>
</li>
  <li>
<a href="#sec-ch18s6" id="toc-sec-ch18s6" class="nav-link" data-scroll-target="#sec-ch18s6"><span class="header-section-number">18.6</span> Encouragement designs</a>
  <ul class="collapse">
<li><a href="#changes-to-the-model" id="toc-changes-to-the-model" class="nav-link" data-scroll-target="#changes-to-the-model"><span class="header-section-number">18.6.1</span> Changes to the model</a></li>
  <li><a href="#changes-to-the-inquiry" id="toc-changes-to-the-inquiry" class="nav-link" data-scroll-target="#changes-to-the-inquiry"><span class="header-section-number">18.6.2</span> Changes to the inquiry</a></li>
  <li><a href="#changes-to-the-data-strategy" id="toc-changes-to-the-data-strategy" class="nav-link" data-scroll-target="#changes-to-the-data-strategy"><span class="header-section-number">18.6.3</span> Changes to the data strategy</a></li>
  <li><a href="#changes-to-the-answer-strategy" id="toc-changes-to-the-answer-strategy" class="nav-link" data-scroll-target="#changes-to-the-answer-strategy"><span class="header-section-number">18.6.4</span> Changes to the answer strategy</a></li>
  <li><a href="#design-examples-5" id="toc-design-examples-5" class="nav-link" data-scroll-target="#design-examples-5"><span class="header-section-number">18.6.5</span> Design examples</a></li>
  </ul>
</li>
  <li>
<a href="#sec-ch18s7" id="toc-sec-ch18s7" class="nav-link" data-scroll-target="#sec-ch18s7"><span class="header-section-number">18.7</span> Placebo-controlled experiments</a>
  <ul class="collapse">
<li><a href="#design-examples-6" id="toc-design-examples-6" class="nav-link" data-scroll-target="#design-examples-6"><span class="header-section-number">18.7.1</span> Design examples</a></li>
  </ul>
</li>
  <li>
<a href="#stepped-wedge-experiments" id="toc-stepped-wedge-experiments" class="nav-link" data-scroll-target="#stepped-wedge-experiments"><span class="header-section-number">18.8</span> Stepped-wedge experiments</a>
  <ul class="collapse">
<li><a href="#when-to-use-a-stepped-wedge-experiment" id="toc-when-to-use-a-stepped-wedge-experiment" class="nav-link" data-scroll-target="#when-to-use-a-stepped-wedge-experiment"><span class="header-section-number">18.8.1</span> When to use a stepped-wedge experiment</a></li>
  <li><a href="#design-examples-7" id="toc-design-examples-7" class="nav-link" data-scroll-target="#design-examples-7"><span class="header-section-number">18.8.2</span> Design examples</a></li>
  </ul>
</li>
  <li>
<a href="#sec-ch18s9" id="toc-sec-ch18s9" class="nav-link" data-scroll-target="#sec-ch18s9"><span class="header-section-number">18.9</span> Randomized saturation experiments</a>
  <ul class="collapse">
<li><a href="#design-examples-8" id="toc-design-examples-8" class="nav-link" data-scroll-target="#design-examples-8"><span class="header-section-number">18.9.1</span> Design examples</a></li>
  </ul>
</li>
  <li>
<a href="#sec-ch18s10" id="toc-sec-ch18s10" class="nav-link" data-scroll-target="#sec-ch18s10"><span class="header-section-number">18.10</span> Experiments over networks</a>
  <ul class="collapse">
<li><a href="#design-examples-9" id="toc-design-examples-9" class="nav-link" data-scroll-target="#design-examples-9"><span class="header-section-number">18.10.1</span> Design examples</a></li>
  </ul>
</li>
  </ul><div class="quarto-code-links"><h2>Code Links</h2><ul><li><a href="https://doi.org/10.7910/DVN/HYVPO5"><i class="bi bi-database-fill"></i>Replication data and code</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body" style="text-align: center">
        <img width="400px" src="https://book.declaredesign.org/figures/cover.jpg" style="margin-bottom: 15px"><br>
        Available from Princeton University Press
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <!--<button type="button" class="btn btn-primary">Buy book</button>-->
        <a href="https://www.amazon.com/Research-Design-Social-Sciences-Declaration/dp/0691199574/?&amp;_encoding=UTF8&amp;tag=declaredesign-20&amp;linkCode=ur2&amp;linkId=84be1f952d1d7aaaa5be867eade93474&amp;camp=1789&amp;creative=9325" target="_blank" class="btn btn-info" role="button">Amazon</a>
        <a href="https://press.princeton.edu/books/paperback/9780691199573/research-design-in-the-social-sciences" target="_blank" class="btn btn-info" role="button">Princeton University Press</a>
      </div>
    </div>
  </div>
</div>

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../library/">Research design library</a></li><li class="breadcrumb-item"><a href="../library/experimental-causal.html"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Experimental : causal</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Experimental : causal</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>An inquiry is causal if it involves a comparison of counterfactual states of the world and a data strategy is experimental if it involves explicit assignment of units to treatment conditions. Experimental designs for causal inference combine these two elements. The designs in this section aim to estimate causal effects and the procedure for doing so involves actively allocating treatments.</p>
<p>Many experimental designs for causal inference in the social sciences take advantage of researcher control over the assignment of treatments to assign them <em>at random</em>. In the archetypal two-arm randomized trial, a group of <span class="math inline">\(N\)</span> subjects are recruited, <span class="math inline">\(m\)</span> of them are chosen at random to receive treatment and the remaining <span class="math inline">\(N-m\)</span> of them do not receive treatment and serve as controls. The inquiry is the average treatment effect, the answer strategy is the difference-in-means estimator. The strength of the design can be appreciated by analogy to random sampling. The <span class="math inline">\(m\)</span> outcomes in the treatment group represent a random sample from the treated potential outcomes among all <span class="math inline">\(N\)</span> subjects, so the sample mean in the treatment group is a good estimator of the true average treated potential outcome; an analogous claim holds for the control group.</p>
<p>The randomization of treatments to estimate average causal effects is a relatively recent human invention. While glimmers of the idea appeared earlier, it wasn’t until at least the 1920s that explicit randomization appeared in agricultural science, medicine, education, and political science <span class="citation" data-cites="Jamison2019">(<a href="../references.html#ref-Jamison2019" role="doc-biblioref">Jamison 2019</a>)</span>. Only a few generations of scientists have had access to this tool. Sometimes critics of experiments will charge “you can’t randomize [important causal variable].” There are of course practical constraints on what treatments researchers can control, be they ethical, financial, or otherwise. We think the main constraint is researcher creativity. The scientific history of randomized experiments is short – just because it hasn’t been randomized <em>yet</em> doesn’t mean it can’t be. (By the same token, just because it <em>can</em> be randomized doesn’t mean that it should be.)</p>
<p>Randomized experiments are rightly praised for their desirable inferential properties, but of course they can go wrong in many ways that designers of experiments should anticipate, and whose effects they should minimize. These problems include problems in the data strategy (randomization implementation failures, excludability violations, noncompliance, attrition, and interference between units), problems in the answer strategy (conditioning on posttreatment variables, failure to account for clustering, <span class="math inline">\(p\)</span>-hacking), and even problems in the inquiry (estimator-inquiry mismatches). Of course, all these problems apply <em>a fortiori</em> to nonexperimental studies, but they are important to emphasize for experimental studies since they are often characterized as being “unbiased” without qualification.</p>
<p>The designs in this chapter proceed from the simplest experimental design – the two-arm trial – up through very complex designs such as the randomized saturation design.</p>
<section id="sec-ch18s1" class="level2" data-number="18.1"><h2 data-number="18.1" class="anchored" data-anchor-id="sec-ch18s1">
<span class="header-section-number">18.1</span> Two-arm randomized experiments</h2>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>We declare a canonical two-arm trial, motivate key diagnosands for assessing the quality of the design, use diagnosis and redesign to explore the properties of two-arm trials, and discuss key risks to inference.</p>
</div>
</div>
</div>
<p>All two-arm randomized trials have in common that subjects are randomly assigned to one of two conditions. Canonically, the two conditions include one treatment condition and one control condition. Some two-arm trials eschew the pure control condition in favor of a placebo control condition, or even a second treatment condition. The uniting feature of all these designs is that the model includes two and only two potential outcomes for each unit and that the data strategy randomly assigns which of these potential outcomes will be revealed by each unit.</p>
<p>A key choice in the design of two-arm trials is the random assignment procedure. Will we use simple random assignment (coin flip, or Bernoulli) or will we use complete random assignment? Will the randomization be blocked or clustered? Will we “restrict” the randomization so that only randomizations that generate acceptable levels of balance on pretreatment characteristics are permitted? We will explore the implications of some of these choices in the coming sections, but for the moment, the main point is that saying “treatments were assigned at random” is insufficient. We need to describe the randomization procedure in detail in order to know how to analyze the resulting experiment. See <a href="../declaration-diagnosis-redesign/crafting-data-strategy.html#sec-ch8s1ss2" class="quarto-xref"><span>Section 8.1.2</span></a> for a description of many different random assignment procedures.</p>
<p>In this chapter, we’ll consider a canonical two-arm trial design, with complete random assignment in a fixed population, which uses difference-in-means to estimate the average treatment effect. We’ll now unpack this shorthand into the components of <em>M</em>, <em>I</em>, <em>D</em>, and <em>A</em>.</p>
<p>The model specifies a fixed sample of <span class="math inline">\(N\)</span> subjects. Here we aren’t imagining that we are first sampling from a larger population. We have in mind a fixed set of units from which we will conduct our experiment: we are conducting “finite sample inference.” Under the model, each unit is endowed with two latent potential outcomes: a treated potential outcome and an untreated potential outcome. The difference between them is the individual treatment effect. In the canonical design, we assume that potential outcomes are “stable,” in the sense that all <span class="math inline">\(N\)</span> units’ potential outcomes are defined with respect to the same treatment and that units’ potential outcomes do not depend on the treatment status of other units. This assumption is often referred to as the “stable unit treatment value assumption,” or SUTVA <span class="citation" data-cites="Rubin1980">(<a href="../references.html#ref-Rubin1980" role="doc-biblioref">Rubin 1980</a>)</span>.</p>
<p>Because the model specifies a fixed sample, the inquiries are also defined at the sample level. The most common inquiry for a two-arm trial is the sample average treatment effect, or SATE. It is equal to the average difference between the treated and untreated potential outcomes for the units in the sample: <span class="math inline">\(\mathbb{E}_{i\in N}[Y_i(1) - Y_i(0)]\)</span>. Two-arm trials can also support other inquiries like the SATE among a subgroup (called a conditional average treatment effect, or CATE), but we’ll leave those inquiries to the side for the moment.</p>
<p>The data strategy uses complete random assignment, in which exactly <span class="math inline">\(m\)</span> of <span class="math inline">\(N\)</span> units are assigned to treatment (<span class="math inline">\(Z_i = 1\)</span>) and the remainder are assigned to control (<span class="math inline">\(Z_i = 0\)</span>). We measure observed outcomes in such a way that we measure the treated potential outcome in the treatment group and untreated potential outcomes in the control group: <span class="math inline">\(Y_i = Y_i(1) \times Z_i + Y_i(0)\times(1 - Z_i)\)</span>. This expression is sometimes called the “switching equation” because of the way it “switches” which potential outcome is revealed by the treatment assignment. It also embeds the crucial assumption that units reveal the potential outcome they are assigned to reveal. If the experiment encounters noncompliance, this assumption is violated. It’s also violated if “excludability” is violated, i.e., if something other than treatment moves with assignment to treatment. For example, if the treatment group is measured differently from the control group, excludability would be violated.</p>
<p>The answer strategy is the difference-in-means estimator with so-called Neyman standard errors. In mathematical notation, if units are ordered with treated units first and control units after, we can write both as:</p>
<p><span id="eq-dim"><span class="math display">\[
\widehat{DIM} = \frac{\sum_1^mY_i}{m} - \frac{\sum_{m + 1}^NY_i}{N-m}
\tag{18.1}\]</span></span></p>
<p><span id="eq-neymanse"><span class="math display">\[
\widehat{\mathrm{se}(DIM)} = \sqrt{\frac{\mathbb{V}(Y_i(1))}{m} + \frac{\mathbb{V}(Y_i(0))}{N-m}}\\
\tag{18.2}\]</span></span></p>
<p>The estimated standard error can be used as an input for two other statistical procedures: null hypothesis significance testing via a <span class="math inline">\(t\)</span>-test and the construction of a 95% confidence interval.</p>
<p>The DAG corresponding to a two-arm randomized trial is very simple. An outcome <span class="math inline">\(Y\)</span> is affected by unknown factors <span class="math inline">\(U\)</span> and a treatment <span class="math inline">\(Z\)</span>. The measurement procedure <span class="math inline">\(Q\)</span> affects <span class="math inline">\(Y\)</span> in the sense that it measures a latent outcome and records the measurement in a dataset. No arrows lead into <span class="math inline">\(Z\)</span> because it is randomly assigned. No arrow leads from <span class="math inline">\(Z\)</span> to <span class="math inline">\(Q\)</span>, because we assume no excludability violations wherein the treatment changes how units are measured. This simple DAG confirms that the average causal effect of <span class="math inline">\(Z\)</span> on <span class="math inline">\(Y\)</span> is nonparametrically identified because no back-door paths lead from <span class="math inline">\(Z\)</span> to <span class="math inline">\(Y\)</span>.</p>
<div id="fig-ch18num1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-1.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;18.1: Directed acyclic graph of a two-arm randomized experiment"><img src="../figures/figure-18-1.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.1: Directed acyclic graph of a two-arm randomized experiment
</figcaption></figure>
</div>
<div id="def-ch18num1" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.1</strong></span> Canonical two-arm trial design.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">declaration_18.1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>                <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span><span class="va">N</span>, prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, inquiry <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Diagnosing this two-arm trial design, we see that, as expected, we encountered no bias, but encountered high variance. In the model, we set the ATE at 0.2 standard units, but the true standard deviation of the estimator (the true standard error) is nearly the same value, at 0.19 standard units. We have low statistical power, at 16%. Two approaches to increasing the precision of the estimate include increasing the sample size and including prognostic pretreatment covariates in the answer strategy. We explore both of these approaches in the next section.</p>
<div id="lem-ch18num1" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.1</strong></span> Two arm trial diagnosis</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diagnosis_18.1</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">declaration_18.1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div id="tbl-diagnosis181" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-diagnosis181-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;18.1: Bias, power, and true standard error for a two-arm randomized trial
</figcaption><div aria-describedby="tbl-diagnosis181-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: center;">Bias</th>
<th style="text-align: center;">Power</th>
<th style="text-align: center;">SD Estimate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">-0.01</td>
<td style="text-align: center;">0.17</td>
<td style="text-align: center;">0.20</td>
</tr>
<tr class="even">
<td style="text-align: center;">(0.00)</td>
<td style="text-align: center;">(0.01)</td>
<td style="text-align: center;">(0.00)</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
</div>
<section id="using-covariates-to-increase-precision" class="level3" data-number="18.1.1"><h3 data-number="18.1.1" class="anchored" data-anchor-id="using-covariates-to-increase-precision">
<span class="header-section-number">18.1.1</span> Using covariates to increase precision</h3>
<p>When treatments are randomized, whether we adjust for pretreatment covariates makes little difference for bias. By contrast, when treatments are not randomized, we often do need to adjust for covariates in order to account for the confounding introduced by “omitted variables” (see <a href="observational-causal.html#sec-ch16s2" class="quarto-xref"><span>Section 16.2</span></a>).</p>
<p>The purpose of adjusting for covariates in an experimental study is to increase precision. The more predictive the covariates are of the outcome, the more they improve the precision of the estimates.</p>
<p>One way to think about how much the inclusion of covariates will help precision is to summarize their predictive power in a statistic like <span class="math inline">\(R^2\)</span>. The <span class="math inline">\(R^2\)</span> value from a regression of the outcome on the covariates alone (i.e., without the treatment indicator) gives an understanding of how jointly predictive the covariates are. If <span class="math inline">\(R^2\)</span> is close to 0, including the covariates will make almost no difference for precision. If <span class="math inline">\(R^2\)</span> is close to 1, we can achieve dramatic increases in precision and statistical power.</p>
<p><a href="#def-ch18num2" class="quarto-xref">Declaration&nbsp;<span>18.2</span></a> draws a summary covariate <code>X</code> and unobserved heterogeneity <code>U</code> from a multivariate normal distribution with a specified covariance between the two variables. By redesigning over the values of that correlation, we can learn how covariate adjustment affects precision depending on the level of <span class="math inline">\(R^2\)</span>. The answer strategy uses the estimator proposed in <span class="citation" data-cites="lin2013agnostic">Lin (<a href="../references.html#ref-lin2013agnostic" role="doc-biblioref">2013</a>)</span> for reasons explained in the next section.</p>
<div id="def-ch18num2" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.2</strong></span> Two-arm trial with covariate adjustment.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">r_sq</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">declaration_18.2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N</span>,</span>
<span>                <span class="fu">draw_multivariate</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">U</span>, <span class="va">X</span><span class="op">)</span> <span class="op">~</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span><span class="op">(</span></span>
<span>                  n <span class="op">=</span> <span class="va">N</span>,</span>
<span>                  mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                  Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">r_sq</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">r_sq</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>                <span class="op">)</span><span class="op">)</span>, </span>
<span>                <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span></span>
<span>    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, covariates <span class="op">=</span> <span class="op">~</span><span class="va">X</span>, .method <span class="op">=</span> <span class="va">lm_lin</span>, inquiry <span class="op">=</span> <span class="st">"ATE"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="lem-ch18num2" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.2</strong></span> Two-arm trial diagnosis.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diagnosis_18.2</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">declaration_18.2</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">redesign</span><span class="op">(</span>r_sq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">0.9</span>, by <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">diagnose_designs</span><span class="op">(</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p><a href="#fig-ch18num2" class="quarto-xref">Figure&nbsp;<span>18.2</span></a> plots sample size on the horizontal axis and diagnosand estimates on the vertical axis. In the left-hand panel, we see that, as usual, statistical power increases with sample size. Different values of <span class="math inline">\(R^2\)</span> are distinguished by colored lines. Higher values of <span class="math inline">\(R^2\)</span> lead to higher statistical power. The gains can be dramatic. The no-adjustment benchmark is represented by the <span class="math inline">\(R^2 = 0\)</span> line. We achieve approximately the same statistical power as a 1,000 unit experiment with no adjustment when the pretreatment covariates yield an <span class="math inline">\(R^2\)</span> of 0.8 and we have just 200 units. The right panel tells a similar story, though it emphasizes that the marginal benefits of covariate adjustment get smaller as the sample size gets bigger. In any real experimental scenario, designers should take care to generate informed guesses about the probable <span class="math inline">\(R^2\)</span> of the covariates and then explore the trade-offs between pretreatment data collection and additional sample size.</p>
<div id="fig-ch18num2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-2.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;18.2: Power and precision increases from covariate adjustment"><img src="../figures/figure-18-2.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.2: Power and precision increases from covariate adjustment
</figcaption></figure>
</div>
</section><section id="can-controlling-for-covariates-hurt-precision" class="level3" data-number="18.1.2"><h3 data-number="18.1.2" class="anchored" data-anchor-id="can-controlling-for-covariates-hurt-precision">
<span class="header-section-number">18.1.2</span> Can controlling for covariates hurt precision?</h3>
<p><span class="citation" data-cites="freedman2008regression">Freedman (<a href="../references.html#ref-freedman2008regression" role="doc-biblioref">2008</a>)</span> critiques the practice of using covariates in an OLS regression to adjust experimental data. While the difference-in-means estimator is unbiased for the average treatment effect, the covariate-adjusted OLS estimator exhibits a small sample bias (sometimes called “Freedman bias”) that diminishes quickly as sample sizes increase. More worrying is the critique that covariate adjustment can even hurt precision.</p>
<p><span class="citation" data-cites="lin2013agnostic">Lin (<a href="../references.html#ref-lin2013agnostic" role="doc-biblioref">2013</a>)</span> unpacks the circumstances under which this precision loss occurs and offers an alternative estimator that is guaranteed to be at least as precise as the unadjusted estimator. The trouble occurs when the correlation of covariates with the outcome is quite different in the treatment condition from that in the control condition and when designs are strongly imbalanced in the sense of having large proportions of treated or untreated units. We refer the reader to this excellent paper for details and the connection between covariate adjustment in randomized experiments and covariate adjustment in random sampling designs. In sum, the Lin estimator deals with the problem by performing covariate adjustment in each arm of the experiment separately, which is equivalent to the inclusion of a full set of treatment-by-covariate interactions. In a clever bit of regression magic, Lin shows how first preprocessing the data by de-meaning the covariates renders the coefficient on the treatment regressor an estimate of the overall ATE. The <code>lm_lin</code> estimator in the <code>estimatr</code> package implements this pre-processing in one step.</p>
<p><a href="#def-ch18num3" class="quarto-xref">Declaration&nbsp;<span>18.3</span></a> will help us to explore the precision of three estimators under a variety of circumstances. We want to understand the performance of the difference-in-means, OLS, and Lin estimators depending on how different the correlation between <code>X</code> and the outcome is by treatment arm, and depending on the fraction of units assigned to treatment.</p>
<div id="def-ch18num3" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.3</strong></span> Lin estimator design.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">prob</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span><span class="va">control_slope</span> <span class="op">=</span> <span class="op">-</span><span class="fl">1</span></span>
<span></span>
<span><span class="va">declaration_18.3</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>                Y_Z_1 <span class="op">=</span> <span class="fl">1</span><span class="op">*</span><span class="va">X</span> <span class="op">+</span> <span class="va">U</span>,</span>
<span>                Y_Z_0 <span class="op">=</span> <span class="va">control_slope</span><span class="op">*</span><span class="va">X</span> <span class="op">+</span> <span class="va">U</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N</span>, prob <span class="op">=</span> <span class="va">prob</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, inquiry <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"DIM"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span>, .method <span class="op">=</span> <span class="va">lm_robust</span>, inquiry <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"OLS"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, covariates <span class="op">=</span> <span class="op">~</span><span class="va">X</span>, .method <span class="op">=</span> <span class="va">lm_lin</span>, inquiry <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"Lin"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="lem-ch18num3" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.3</strong></span> Lin estimator diagnosis.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diagnosis_18.3</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">declaration_18.3</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">redesign</span><span class="op">(</span></span>
<span>    control_slope <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>, </span>
<span>    prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">diagnose_designs</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-ch18num3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-3.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;18.3: Comparing the Lin estimator to OLS and difference-in-means, varying fraction assigned to treatment and correlation of potential outcomes with the covariate."><img src="../figures/figure-18-3.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.3: Comparing the Lin estimator to OLS and difference-in-means, varying fraction assigned to treatment and correlation of potential outcomes with the covariate.
</figcaption></figure>
</div>
<p><a href="#fig-ch18num3" class="quarto-xref">Figure&nbsp;<span>18.3</span></a> considers a range of designs under three possible models. The three models are described by the top row of facets. In all cases, the slope of the treated potential outcomes with respect to <span class="math inline">\(X\)</span> is set to 1. All the way to the left, the slope with respect to the control potential outcomes is set to -1, and all the way to the right is set to +1. The bottom row of facets shows the performance of three estimators along a range of treatment assignment probabilities.</p>
<p>When the control slope is -1, we can see Freedman’s precision critique. The standard error of the OLS is <em>larger</em> than difference-in-means for many designs, though they coincide when the fraction treated is 50%. This problem persists in some form until the slope of the control potential outcome with respect to <span class="math inline">\(X\)</span> gets close enough to the slope of the treated potential outcomes with respect to <span class="math inline">\(X\)</span>.</p>
<p>All along this range, however, the Lin estimator dominates OLS and difference-in-means. Regardless of the fraction assigned to treatment and the model of potential outcomes, the Lin estimator achieves equal or better precision than either difference-in-means or OLS. These results highlight the gains that can be made by including covariate controls in your ex ante design, as long as you use the right answer strategy. They do not provide support for the more worrying practice of selecting controls ex post based on how they affect your results.</p>
</div>
</section><section id="design-examples" class="level3" data-number="18.1.3"><h3 data-number="18.1.3" class="anchored" data-anchor-id="design-examples">
<span class="header-section-number">18.1.3</span> Design examples</h3>
<ul>
<li><p><span class="citation" data-cites="Peyton2019">Peyton, Sierra-Arévalo, and Rand (<a href="../references.html#ref-Peyton2019" role="doc-biblioref">2019</a>)</span> conduct a two-arm randomized experiment in which treatment households were assigned to receive a nonenforcement visit from police and control households were not. Outcomes were measured via a follow-up survey.</p></li>
<li><p><span class="citation" data-cites="balcells2022transitional">Balcells, Palanza, and Voytas (<a href="../references.html#ref-balcells2022transitional" role="doc-biblioref">2022</a>)</span> use a two-arm randomized experiment to study the effects of a visit to a transitional justice museum in Chile on support for democratic institutions.</p></li>
</ul></section></section><section id="block-randomized-experiments" class="level2" data-number="18.2"><h2 data-number="18.2" class="anchored" data-anchor-id="block-randomized-experiments">
<span class="header-section-number">18.2</span> Block-randomized experiments</h2>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>We declare a block-randomized trial in which subjects are assigned to treatment and control conditions within groups. We use design diagnosis to assess the variance reductions that can be achieved from block randomization.</p>
</div>
</div>
</div>
<p>In a block-randomized experimental design, homogeneous sets of units are grouped together into blocks on the basis of covariates. The ideal blocking would group together units with identical potential outcomes, but since we don’t have access to any outcome information at the moment of treatment assignment, let alone the full set of potential outcomes, we have to make do with grouping together units on the basis of covariates we hope are strongly correlated with potential outcomes. The stronger the correlation between a blocking variable and the potential outcomes, the more effective the blocking in terms of increasing precision.</p>
<p>Blocks can be formed in many ways. They can be constructed based on the levels of a single discrete covariate. We might be able to do better by blocking on the intersection of the levels of two discrete covariates. We could coarsen a continuous variable in order to create strata. We could even create matched quartets of units, partitioning the sample into sets of four units that are as similar as possible on many covariates. In any of these cases, we then randomize units <em>within</em> blocks to treatment. All of these procedures fall under the rubric of block random assignment. Methodologists have crafted many algorithms for creating blocks, each with their own trade-offs in terms of computational speed and efficiency guarantees.</p>
<p>In <a href="#def-ch18num4" class="quarto-xref">Declaration&nbsp;<span>18.4</span></a>, we block our assignment on a binary covariate <code>X</code>. We assign different fractions of each block to treatment to illustrate the notion that probabilities of assignment need not be constant across blocks, and if they aren’t, we need to weight units by the inverse of the probability of assignment to the condition that they are in. In the answer strategy, we adjust for blocks using the <span class="citation" data-cites="lin2013agnostic">Lin (<a href="../references.html#ref-lin2013agnostic" role="doc-biblioref">2013</a>)</span> regression adjustment estimator including IPW weights.</p>
<div id="def-ch18num4" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.4</strong></span> Block randomized two-arm trial design.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">declaration_18.4</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">N</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>,</span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span></span>
<span>    Z <span class="op">=</span> <span class="fu">block_ra</span><span class="op">(</span>blocks <span class="op">=</span> <span class="va">X</span>, block_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    probs <span class="op">=</span></span>
<span>      <span class="fu">obtain_condition_probabilities</span><span class="op">(</span>assignment <span class="op">=</span> <span class="va">Z</span>, </span>
<span>                                     blocks <span class="op">=</span> <span class="va">X</span>, </span>
<span>                                     block_prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    ipw <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">probs</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span></span>
<span>    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,</span>
<span>    covariates <span class="op">=</span> <span class="op">~</span> <span class="va">X</span>,</span>
<span>    .method <span class="op">=</span> <span class="va">lm_lin</span>,</span>
<span>    weights <span class="op">=</span> <span class="va">ipw</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"Lin"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<section id="why-does-blocking-help" class="level3" data-number="18.2.1"><h3 data-number="18.2.1" class="anchored" data-anchor-id="why-does-blocking-help">
<span class="header-section-number">18.2.1</span> Why does blocking help?</h3>
<p>Why does blocking increase the precision with which we estimate the ATE? One piece of intuition is that blocking rules out “bad” random assignments that exhibit imbalance on the blocking variable. If <span class="math inline">\(N\)</span> = 12 and <span class="math inline">\(m\)</span> = 6, complete random assignment allows <code>choose(12, 6) = 924</code> possible permutations. If we form two blocks of six units and conduct block random assignment, then there are <code>choose(6, 3) * choose(6, 3) = 400</code> remaining possible assignments. The assignments that are ruled are those in which too many or too few units in a block are assigned to treatment, because blocking requires that exactly <span class="math inline">\(m_B\)</span> units be treated in each block <span class="math inline">\(B\)</span>. When potential outcomes are correlated with the blocking variable, those “extreme” assignments produce estimates that are in the tails of the sampling distribution associated with complete random assignment.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div id="lem-ch18num4" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.4</strong></span> Diagnosis comparing block random assignment and complete random assignment.</p>
<p>This intuition behind blocking is illustrated in <a href="#fig-ch18num4" class="quarto-xref">Figure&nbsp;<span>18.4</span></a>, which shows the sampling distribution of the difference-in-means estimator under <em>complete</em> random assignment. The histogram is shaded according to whether the particular random assignment is permissible under a procedure that blocks on the binary covariate <span class="math inline">\(X\)</span>. The sampling distribution of the estimator among the set of assignments that are permissible under blocking is more tightly distributed around the true average treatment effect than the estimates associated with assignments that are not perfectly balanced. Here we can see the value of a blocking procedure – <em>it rules out by design</em> those assignments that are not perfectly balanced.</p>
<div id="fig-ch18num4" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-4.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;18.4: Sampling distribution under complete random assignment, by covariate balance"><img src="../figures/figure-18-4.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.4: Sampling distribution under complete random assignment, by covariate balance
</figcaption></figure>
</div>
</div>
</section><section id="design-examples-1" class="level3" data-number="18.2.2"><h3 data-number="18.2.2" class="anchored" data-anchor-id="design-examples-1">
<span class="header-section-number">18.2.2</span> Design examples</h3>
<ul>
<li><p><span class="citation" data-cites="Kalla2018">Kalla, Rosenbluth, and Teele (<a href="../references.html#ref-Kalla2018" role="doc-biblioref">2018</a>)</span> conduct an audit experiment among legislators in which the gender of a student asking for advice about starting a career in politics is randomized. Units are block-randomized into treatments on the basis of the legislators’ own gender and their state.</p></li>
<li><p><span class="citation" data-cites="lyall_zhou_imai_2020">Lyall, Zhou, and Imai (<a href="../references.html#ref-lyall_zhou_imai_2020" role="doc-biblioref">2020</a>)</span> use a block-randomized design to evaluate the effect of vocational training and cash transfers on support for combatants among youth in Afghanistan. Matched quartet blocks were created on the basis of district, gender, employment status, displacement status, and exposure to violence.</p></li>
</ul></section></section><section id="sec-ch18s3" class="level2" data-number="18.3"><h2 data-number="18.3" class="anchored" data-anchor-id="sec-ch18s3">
<span class="header-section-number">18.3</span> Cluster-randomized experiments</h2>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>We declare a cluster-randomized trial in which subjects are assigned to treatment and control conditions in groups. We use design diagnosis to quantify how the magnitude of the efficiency losses from clustering depends on the intra-cluster correlation.</p>
</div>
</div>
</div>
<p>When whole groups of units are assigned to treatment conditions together, we say that the assignment procedure is clustered. A common example is an education experiment in which the treatment is randomized at the classroom level. All students in a classroom are assigned to either treatment or control together; assignments do not vary within the classroom. Clusters can be localities, like villages, precincts, or neighborhoods. Clusters can be households if treatments are assigned at the household level.</p>
<p>Typically, cluster randomized trials exhibit higher variance than the equivalent individually randomized trial. How much higher variance depends on a statistic that can be hard to think about, the intra-cluster correlation (ICC) of the outcome. The total variance can be decomposed into the variance of the cluster means <span class="math inline">\(\sigma^2_{\textrm{between}}\)</span> plus the individual variance of the cluster-demeaned outcome <span class="math inline">\(\sigma^2_{\textrm{within}}\)</span>. The ICC is a number between 0 and 1 that describes the fraction of the total variance that is due to the between variance: <span class="math inline">\(ICC = \frac{\sigma^2_{\textrm{between}}}{\sigma^2_{\textrm{between}} + \sigma^2_{\textrm{within}}}\)</span>. If ICC equals 1, then all units within a cluster express the same outcome, and all of the variation in outcomes is due to cluster-level differences. If ICC equals zero, then the cluster means are all identical, but the individuals vary within each cluster. When ICC is 1, the effective sample size is equal to the number of clusters. When ICC is 0, the effective sample size is equal to the number of individuals. Since ICC is usually somewhere between these two values, we can see that clustering decreases the effective sample size from the number of individuals. The size of this decrease depends on how similar outcomes are within a cluster compared to how similar outcomes are across clusters.</p>
<p>For these reasons clustered random assignment is not usually a desirable feature of a design. Sometimes, however, it is useful or even <em>necessary</em> for logistical or ethical reasons for subjects to be assigned together in groups.</p>
<p>To demonstrate the consequences of clustering, <a href="#def-ch18num5" class="quarto-xref">Declaration&nbsp;<span>18.5</span></a> shows a design in which both the untreated outcome <code>Y_Z_0</code> and the treatment effect <code>tau_i</code> exhibit intra-cluster correlation. The inquiry is the average treatment effect over individuals, which can be defined without reference to the clustered structure of the data. The data strategy employs clustered random assignment. We highlight two features of the clustered assignment. First, the clustered nature of the data does not itself <em>require</em> clustered assignment. In principle, one could assign treatments at the individual level or subgroup level even if outcomes are correlated within groups. Second, surprisingly, random assignment of clusters to conditions does not guarantee unbiasedness of outcomes when clusters are of unequal size <span class="citation" data-cites="middleton2008bias imai2009essential">(<a href="../references.html#ref-middleton2008bias" role="doc-biblioref">Middleton 2008</a>; <a href="../references.html#ref-imai2009essential" role="doc-biblioref">Imai, King, and Nall 2009</a>)</span>. The bias stems from the possibility that potential outcomes could be correlated with cluster size. With uneven cluster sizes, the total number of units (the denominator in the mean estimation) in each group bounces around from assignment to assignment. Since the expectation of a ratio is not, in general, equal to the ratio of expectations, any dependence between cluster size and potential outcomes will cause bias. We can address this problem by blocking clusters into groups according to cluster size. If all clusters in a block are of the same size, then the overall size of the treatment group will remain stable from assignment to assignment. For this reason the design below uses clustered assignment blocked on cluster size.</p>
<div id="def-ch18num5" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.5</strong></span> Blocked and clustered randomized trial.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ICC</span> <span class="op">&lt;-</span> <span class="fl">0.9</span></span>
<span></span>
<span><span class="va">declaration_18.5</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    cluster <span class="op">=</span></span>
<span>      <span class="fu">add_level</span><span class="op">(</span></span>
<span>        N <span class="op">=</span> <span class="fl">10</span>,</span>
<span>        cluster_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>        cluster_shock <span class="op">=</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">cluster_size</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">ICC</span><span class="op">)</span>,</span>
<span>        cluster_tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">ICC</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>    individual <span class="op">=</span></span>
<span>      <span class="fu">add_level</span><span class="op">(</span></span>
<span>        N <span class="op">=</span> <span class="va">cluster_size</span>,</span>
<span>        individual_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">ICC</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        individual_tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">ICC</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        Y_Z_0 <span class="op">=</span> <span class="va">cluster_shock</span> <span class="op">+</span> <span class="va">individual_shock</span>,</span>
<span>        Y_Z_1 <span class="op">=</span> <span class="va">Y_Z_0</span> <span class="op">+</span> <span class="va">cluster_tau</span> <span class="op">+</span> <span class="va">individual_tau</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">block_and_cluster_ra</span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">cluster</span>, blocks <span class="op">=</span> <span class="va">cluster_size</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,</span>
<span>                    clusters <span class="op">=</span> <span class="va">cluster</span>,</span>
<span>                    inquiry <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="lem-ch18num5" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.5</strong></span> Redesigning over values of ICC</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diagnosis_18.5</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">declaration_18.5</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">redesign</span><span class="op">(</span>ICC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span>, by <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">diagnose_designs</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-ch18num5" class="quarto-xref">Figure&nbsp;<span>18.15</span></a> shows the sampling distribution of the difference-in-means estimator under cluster random assignment at three levels of intra-cluster correlation ranging from 0.1 to 0.9.</p>
<p>The top row of panels plot the treatment effect on the vertical axis and the untreated potential outcome on the horizontal axis. Clusters of units are circled. At low levels of ICC, the circles all overlap, because the differences across clusters are smaller than the differences within a cluster. At high levels of ICC, the differences across clusters are more pronounced than differences within a cluster. The bottom row of panels shows that the sampling distribution of the difference-in-means estimator spreads out as the ICC increases. At low levels of ICC, the standard error is small; at high levels the standard error is high.</p>
<div id="fig-ch18num5" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-5.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;18.5: Sampling distribution under differenct ICCs"><img src="../figures/figure-18-5.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.5: Sampling distribution under differenct ICCs
</figcaption></figure>
</div>
<p>This diagnosis clarifies the <em>costs</em> of cluster assignment. These costs are greatest when there are few clusters and when units within clusters have similar potential outcomes. Diagnosis can be further used to compare these costs to advantages and assess the merits of variations in the design that seek to alter the number or size of clusters.</p>
</div>
<section id="design-examples-2" class="level3" data-number="18.3.1"><h3 data-number="18.3.1" class="anchored" data-anchor-id="design-examples-2">
<span class="header-section-number">18.3.1</span> Design examples</h3>
<ul>
<li><p><span class="citation" data-cites="mousa2020building">Mousa (<a href="../references.html#ref-mousa2020building" role="doc-biblioref">2020</a>)</span> studies the effects of inter-group contact on tolerance by cluster assigning players in a Christian football league in Iraq to play with four new Muslim teammates or four new Christian teammates, where the clusters are the teams.</p></li>
<li><p><span class="citation" data-cites="paluck_green_2009">Paluck and Green (<a href="../references.html#ref-paluck_green_2009" role="doc-biblioref">2009</a>)</span> cluster-assigned communities in Rwanda to radio programs encouraging dissent and disobedience to authorities and measured individual-level outcomes via survey.</p></li>
</ul></section></section><section id="sec-ch18s4" class="level2" data-number="18.4"><h2 data-number="18.4" class="anchored" data-anchor-id="sec-ch18s4">
<span class="header-section-number">18.4</span> Subgroup designs</h2>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>We declare and diagnose a design that is targeted at understanding the difference in treatment effects between subgroups. The design combines a sampling strategy that ensures reasonable numbers within each group of interest and a blocking assignment strategy to minimize variance.</p>
</div>
</div>
</div>
<p>Subgroup designs are experimental designs that have been tailored to a specific inquiry, the difference-in-CATEs. A CATE is a “conditional average treatment effect,” or the average treatment effect conditional on membership in some group. A difference-in-CATEs is simply the difference between two CATEs.</p>
<p>For example, studies of political communication often have the <em>difference</em> in response to a party cue by subject partisanship as the main inquiry, since Republican subjects tend to respond positively to a Republican party cue, whereas Democratic subjects tend to respond negatively.</p>
<p>Subgroup designs share much in common with factorial designs, discussed in detail in <a href="#sec-ch18s5" class="quarto-xref"><span>Section 18.5</span></a>. The main source of commonality is the answer strategy for the difference-in-CATEs inquiry. In subgroup designs and factorial designs, the usual approach is to inspect the interaction term from an OLS regression. The two designs differ because in the subgroup design, the difference-in-CATEs is a descriptive difference. We don’t randomly assign partisanship, so we can’t attribute the difference in response to treatment to partisanship, which could just be a marker for the true causes of the difference in response. But this makes it no less important a quantity of interest. In the factorial design, we randomize the levels of all treatments, so the differences-in-CATEs carry with them a causal interpretation.</p>
<p>Since we don’t randomly assign membership in subgroups, how can we optimize the design to target the difference-in-CATEs? Our main data strategy choice comes in sampling. We need to obtain sufficient numbers of both groups in order to generate sharp enough estimates of each CATE, the better to estimate their difference. For example, at the time of this writing, many sources of convenience samples (Mechanical Turk, Lucid, Prolific, and many others) appear to under-represent Republicans, so researchers sometimes need to make special efforts to increase their numbers in the eventual sample.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p><a href="#def-ch18num6" class="quarto-xref">Declaration&nbsp;<span>18.6</span></a> describes a fixed population of 10,000 units, among whom people with <code>X = 1</code> are relatively rare (only 20%). In the <code>potential_outcomes</code> call, we build in both baseline differences in the outcome, and also responses to treatment that are oppositely signed across the two subgroups. Those with <code>X = 0</code> have a CATE of <code>0.1</code> and those with <code>X = 1</code> have a CATE of <code>0.1 - 0.2 = -0.1</code>. The true difference-in-CATEs is therefore 20 percentage points.</p>
<p>If we were to draw a sample of 1,000 at random, we would expect to yield only 200 people with <code>X = 1</code>. Here we improve upon that through stratified sampling. We deliberately sample 500 units with <code>X = 1</code> and 500 with <code>X = 0</code>, then block-random-assign the treatment within groups defined by <code>X</code>.</p>
<div id="def-ch18num6" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.6</strong></span> Subgroup design declaration.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">343</span><span class="op">)</span></span>
<span><span class="va">fixed_pop</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">fabricate</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>            X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>            <span class="fu">potential_outcomes</span><span class="op">(</span></span>
<span>              <span class="va">Y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>,</span>
<span>                         prob <span class="op">=</span> <span class="fl">0.7</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">Z</span>  <span class="op">-</span> <span class="fl">0.4</span> <span class="op">*</span> <span class="va">X</span> <span class="op">-</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">total_n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">n_x1</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="co"># Note: n_x2 = total_n - n_x1</span></span>
<span></span>
<span><span class="va">declaration_18.6</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span>data <span class="op">=</span> <span class="va">fixed_pop</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span></span>
<span>    CATE_X1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span><span class="op">[</span><span class="va">X</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">[</span><span class="va">X</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    CATE_X0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span><span class="op">[</span><span class="va">X</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">[</span><span class="va">X</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    diff_in_CATEs <span class="op">=</span> <span class="va">CATE_X1</span> <span class="op">-</span> <span class="va">CATE_X0</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_sampling</span><span class="op">(</span></span>
<span>    S <span class="op">=</span> <span class="fu">strata_rs</span><span class="op">(</span>strata <span class="op">=</span> <span class="va">X</span>, strata_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">total_n</span> <span class="op">-</span> <span class="va">n_x1</span>, <span class="va">n_x1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">block_ra</span><span class="op">(</span>blocks <span class="op">=</span> <span class="va">X</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span> <span class="op">+</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">X</span>, </span>
<span>                    term <span class="op">=</span> <span class="st">"Z:X"</span>, </span>
<span>                    inquiry <span class="op">=</span> <span class="st">"diff_in_CATEs"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="lem-ch18num6" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.6</strong></span> Subgroup design diagnosis.</p>
<p>To show the benefits of stratified sampling for experiments, we redesign over many values of under- and over-sampling units with <code>X = 1</code>, holding the total sample size fixed at <code>1000</code>. The top panel of <a href="#fig-ch18num6" class="quarto-xref">Figure&nbsp;<span>18.6</span></a> shows the distribution of difference-in-CATE estimates at each size of the <code>X = 1</code> group. When very small or very large fractions of the total sample have <code>X = 1</code>, the variance of the estimator is much larger than when the two groups have the same size.</p>
<p>The bottom panel of the figure shows how three diagnosands change over the oversampling design parameter. Bias is never a problem – even small subgroups will generate unbiased difference-in-CATE estimates. As suggested by the top panel, the standard error is minimized in the middle and is largest at the extremes. Likewise, statistical power is maximized in the middle, but drops off surprisingly quickly as we move away from evenly balanced recruitment.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diagnosis_18.6</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">declaration_18.6</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">redesign</span><span class="op">(</span>n_x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">980</span>, by <span class="op">=</span> <span class="fl">96</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">diagnose_designs</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-ch18num6" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-6.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;18.6: Performance of the subgroup depending on oversampling strategy."><img src="../figures/figure-18-6.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.6: Performance of the subgroup depending on oversampling strategy.
</figcaption></figure>
</div>
</div>
<section id="design-examples-3" class="level3" data-number="18.4.1"><h3 data-number="18.4.1" class="anchored" data-anchor-id="design-examples-3">
<span class="header-section-number">18.4.1</span> Design examples</h3>
<ul>
<li><p><span class="citation" data-cites="collins_2021">Collins (<a href="../references.html#ref-collins_2021" role="doc-biblioref">2021</a>)</span> conducts a survey experiment that measures the effects of school board meeting style (standard, participatory, or deliberative) on willingness to attend meetings. The author hypothesized that the effects of participatory and deliberative meeting styles would be larger for non-white subjects, which motivated an oversample of this type of respondent. The final sample included 1,061 non-White subjects and 1,122 White subjects, so the design was well poised to estimate the conditional average effects of the treatments for both groups, which ended up being quite similar.</p></li>
<li><p><span class="citation" data-cites="Swire2017">Swire et al. (<a href="../references.html#ref-Swire2017" role="doc-biblioref">2017</a>)</span> conduct an experimental study of misinformation and corrections that compares Republican and Democratic subjects beliefs in false statements. These authors oversampled Republicans from the Mechanical Turk platform, since usual samples from the platform underrepresent Republicans. Republicans believed false claims more when they were attributed to President Trump and Democrats believed them less; this difference-in-CATEs is especially precisely estimated because of the over-sample. Both partisan groups responded to <em>corrections</em> of false claims by believing them less, by similar amounts.</p></li>
</ul></section></section><section id="sec-ch18s5" class="level2" data-number="18.5"><h2 data-number="18.5" class="anchored" data-anchor-id="sec-ch18s5">
<span class="header-section-number">18.5</span> Factorial experiments</h2>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>We declare and diagnose a simple factorial design in which two different treatments are crossed. The design allows for unbiased estimation of a number of estimands, including conditional effects and interaction effects. We highlight the difficulty of achieving statistical power for interaction terms and the risks of treating a difference between a significant conditional effect and a nonsignificant effect as itself significant.</p>
</div>
</div>
</div>
<p>In factorial experiments, researchers randomly assign the level of not just one treatment, but multiple treatments. The prototypical factorial design is a “two-by-two” factorial design in which factor 1 has two levels and so does factor 2. Similarly, a “three-by-three” factorial design has two factors, each of which has three levels. We can entertain any number of factors with any number of levels. For example, a “two-by-three-by-two” factorial design has three factors, two of which have two levels and one of which has three levels. Conjoint experiments are highly factorial, often including six or more factors with two or more levels each (see <a href="experimental-descriptive.html#sec-ch17s3" class="quarto-xref"><span>Section 17.3</span></a>).</p>
<p>Factorial designs can help researchers answer many inquiries, so it is crucial to design factorials with a particular set in mind. Let’s consider the two-by-two case, which is complicated enough. Let’s call the first factor <code>Z1</code> and the second factor <code>Z2</code>, each of which can take on the value of 0 or 1. Considering only average effects, this design can support at least seven separate inquiries:</p>
<ol type="1">
<li>the average treatment effect (ATE) of <code>Z1</code>,</li>
<li>the ATE of <code>Z2</code>,</li>
<li>the conditional average treatment effect (CATE) of <code>Z1</code> given <code>Z2 = 0</code>,</li>
<li>the CATE of <code>Z1</code> given <code>Z2 = 1</code>,</li>
<li>the CATE of <code>Z2</code> given <code>Z1 = 0</code>,</li>
<li>the CATE of <code>Z2</code> given <code>Z1 = 1</code>, and</li>
<li>The difference-in-CATEs: the difference between inquiry (4) and inquiry (3), which is numerically equivalent to the difference between inquiry (6) and inquiry (5)</li>
</ol>
<p>The reason we distinguish between the ATE of <code>Z1</code> versus the CATEs of <code>Z1</code> depending on the level of <code>Z2</code> is that the two factors may “interact.” When factors interact, the effects of <code>Z1</code> are heterogeneous in the sense that they differ depending on the level of <code>Z2</code>. We often care about the difference-in-CATEs inquiry when we think the effects of one treatment will depend on the level of another treatment.</p>
<p>However, if we are not so interested in the difference-in-CATEs, then factorial experiments have another good justification – we can learn about the ATEs of each treatment for half price, in the sense that we apply treatments to the same subject pool using the same measurement strategy. Conjoint experiments are a kind of factorial design (discussed in <a href="experimental-descriptive.html#sec-ch17s3" class="quarto-xref"><span>Section 17.3</span></a>) that often target average treatment effects that average over the levels of the other factors.</p>
<p>Here we declare a factorial design with two treatments and a normally distributed outcome variable. We imagine that the CATE of <code>Z1</code> given <code>Z2 = 0</code> is 0.2 standard units, the CATE of <code>Z2</code> given <code>Z1 = 0</code> is equal to 0.1, and the interaction of the two treatments is 0.1.</p>
<div id="def-ch18num7" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.7</strong></span> Two-by-two factorial design.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">CATE_Z1_Z2_0</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">CATE_Z2_Z1_0</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">interaction</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="va">declaration_18.7</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="va">N</span>,</span>
<span>    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">CATE_Z1_Z2_0</span> <span class="op">*</span> <span class="va">Z1</span> <span class="op">+</span></span>
<span>                         <span class="va">CATE_Z2_Z1_0</span> <span class="op">*</span> <span class="va">Z2</span> <span class="op">+</span></span>
<span>                         <span class="va">interaction</span> <span class="op">*</span> <span class="va">Z1</span> <span class="op">*</span> <span class="va">Z2</span> <span class="op">+</span> <span class="va">U</span>,</span>
<span>                       conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                         Z2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span></span>
<span>    CATE_Z1_Z2_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z1_1_Z2_0</span> <span class="op">-</span> <span class="va">Y_Z1_0_Z2_0</span><span class="op">)</span>,</span>
<span>    CATE_Z1_Z2_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z1_1_Z2_1</span> <span class="op">-</span> <span class="va">Y_Z1_0_Z2_1</span><span class="op">)</span>,</span>
<span>    ATE_Z1 <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">CATE_Z1_Z2_0</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">CATE_Z1_Z2_1</span>,</span>
<span>    </span>
<span>    CATE_Z2_Z1_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z1_0_Z2_1</span> <span class="op">-</span> <span class="va">Y_Z1_0_Z2_0</span><span class="op">)</span>,</span>
<span>    CATE_Z2_Z1_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z1_1_Z2_1</span> <span class="op">-</span> <span class="va">Y_Z1_1_Z2_0</span><span class="op">)</span>,</span>
<span>    ATE_Z2 <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">CATE_Z2_Z1_0</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">CATE_Z2_Z1_1</span>,</span>
<span>    </span>
<span>    diff_in_CATEs_Z1 <span class="op">=</span> <span class="va">CATE_Z1_Z2_1</span> <span class="op">-</span> <span class="va">CATE_Z1_Z2_0</span>,</span>
<span>    <span class="co">#equivalently</span></span>
<span>    diff_in_CATEs_Z2 <span class="op">=</span> <span class="va">CATE_Z2_Z1_1</span> <span class="op">-</span> <span class="va">CATE_Z2_Z1_0</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z1 <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>                     Z2 <span class="op">=</span> <span class="fu">block_ra</span><span class="op">(</span><span class="va">Z1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z1</span> <span class="op">+</span> <span class="va">Z2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z1</span>, subset <span class="op">=</span> <span class="op">(</span><span class="va">Z2</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>                    inquiry <span class="op">=</span> <span class="st">"CATE_Z1_Z2_0"</span>, label <span class="op">=</span> <span class="st">"1"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z1</span>, subset <span class="op">=</span> <span class="op">(</span><span class="va">Z2</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>                    inquiry <span class="op">=</span> <span class="st">"CATE_Z1_Z2_1"</span>, label <span class="op">=</span> <span class="st">'2'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z2</span>, subset <span class="op">=</span> <span class="op">(</span><span class="va">Z1</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, </span>
<span>                    inquiry <span class="op">=</span> <span class="st">"CATE_Z2_Z1_0"</span>, label <span class="op">=</span> <span class="st">"3"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z2</span>, subset <span class="op">=</span> <span class="op">(</span><span class="va">Z1</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                    inquiry <span class="op">=</span> <span class="st">"CATE_Z2_Z1_1"</span>, label <span class="op">=</span> <span class="st">"4"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z1</span> <span class="op">+</span> <span class="va">Z2</span>, term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Z1"</span>, <span class="st">"Z2"</span><span class="op">)</span>, </span>
<span>                    inquiry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ATE_Z1"</span>, <span class="st">"ATE_Z2"</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"5"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z1</span> <span class="op">+</span> <span class="va">Z2</span> <span class="op">+</span> <span class="va">Z1</span><span class="op">*</span><span class="va">Z2</span>, term <span class="op">=</span> <span class="st">"Z1:Z2"</span>, </span>
<span>                    inquiry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"diff_in_CATEs_Z1"</span>, <span class="st">"diff_in_CATEs_Z2"</span><span class="op">)</span>, </span>
<span>                    label <span class="op">=</span> <span class="st">"6"</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="lem-ch18num7" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.7</strong></span> Two-by-two factorial diagnosis.</p>
<p>We now redesign this factorial over many sample sizes, considering the statistical power for each of the inquiries. <a href="#fig-ch18num7" class="quarto-xref">Figure&nbsp;<span>18.7</span></a> shows that depending on the inquiry, the statistical power of this design can vary dramatically. The average treatment effect of <code>Z1</code> is relatively large at 0.25 standard units, so power is above the 80% threshold at all the sample sizes we consider. The ATE of <code>Z2</code> is smaller, at 0.15 standard units, so power is lower, but not dramatically so. Both ATEs use all <span class="math inline">\(N\)</span> data points, so power is manageable for the average effects. The conditional average effects generally fare worse, mainly because each is estimated on only half the sample. The power for the 0.1 standard unit difference-in-CATEs is abysmal at all sample sizes considered here. This diagnosis underlines <a href="../introduction/research-design-principles.html#exm-designholistically" class="quarto-xref">Principle&nbsp;<span>3.1</span></a>: <em>Design holistically</em>. The power of a factorial design is not just one number – we have to calculate power for each inquiry separately, as they can differ dramatically.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diagnosis_18.7</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">declaration_18.7</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">redesign</span><span class="op">(</span>N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">3000</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">diagnose_designs</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-ch18num7" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-7.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;18.7: Power curves for factorial inquires"><img src="../figures/figure-18-7.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.7: Power curves for factorial inquires
</figcaption></figure>
</div>
</div>
<section id="avoiding-misleading-inferences" class="level3" data-number="18.5.1"><h3 data-number="18.5.1" class="anchored" data-anchor-id="avoiding-misleading-inferences">
<span class="header-section-number">18.5.1</span> Avoiding misleading inferences</h3>
<p>The very poor power for the difference-in-CATEs sometimes leads researchers to rely on a different answer strategy for considering whether the effects of <code>Z1</code> depend on the level of <code>Z2</code>. Sometimes, researchers will consider the statistical significance of each of <code>Z1</code>’s CATEs separately, then conclude the CATEs are “different” if the effect is significant for one CATE but not the other. This is a bad practice and we’ll show why.</p>
<p>Here we diagnose over the true values of the <code>Z1</code> ATE, setting the true interaction term to 0. Our diagnostic question will be, how frequently do we conclude the two CATEs are different, using two different strategies. The first is the usual approach, i.e., we consider the statistical significance of the interaction term. The second considers whether one, but not the other, of the two CATE estimates is significant.</p>
<div id="lem-ch18num8" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.8</strong></span> Redesign over models.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diagnosis_18.8</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">declaration_18.7</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">redesign</span><span class="op">(</span></span>
<span>    CATE_Z1_Z2_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    CATE_Z2_Z1_0 <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    interaction <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">diagnose_designs</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-ch18num8" class="quarto-xref">Figure&nbsp;<span>18.8</span></a> shows that the error rate when we consider the statistical significance of the interaction term is nominal. Only 5% of the time do we falsely reject the null that the difference-in-CATEs is zero, which is what we expect when we adopt an <span class="math inline">\(\alpha = 0.05\)</span> threshold. But when we claim “treatment effect heterogeneity!” when one CATE is significant but not the other, we make egregious errors. When the true (constant) average effect of <code>Z1</code> approaches 0.2, we falsely conclude that the treatment has heterogeneous effects nearly 50% of the time!</p>
<div id="fig-ch18num8" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-8.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Figure&nbsp;18.8: Comparing the significance of CATE estimates generates misleading inferences."><img src="../figures/figure-18-8.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.8: Comparing the significance of CATE estimates generates misleading inferences.
</figcaption></figure>
</div>
</div>
</section><section id="design-examples-4" class="level3" data-number="18.5.2"><h3 data-number="18.5.2" class="anchored" data-anchor-id="design-examples-4">
<span class="header-section-number">18.5.2</span> Design examples</h3>
<ul>
<li><p><span class="citation" data-cites="karpowitz2017elect">Karpowitz, Monson, and Preece (<a href="../references.html#ref-karpowitz2017elect" role="doc-biblioref">2017</a>)</span> use a two-by-two factorial design in their experimental study of interventions to increase the number of women elected officials. The first factor is a “demand” treatment in which caucus meetings of party members are read a letter encouraging them to vote for women. The second factor is a “supply” treatment in which caucus leaders encourage specific women to stand for election. Caucus meetings could be assigned to the demand treatment, the supply treatment, both, or neither. Both treatments increase the number of women elected. The difference-in-CATEs (the interaction term) is negative, suggesting diminishing marginal returns to the interventions, though it is imprecisely estimated.</p></li>
<li><p><span class="citation" data-cites="wilke2021does">Wilke (<a href="../references.html#ref-wilke2021does" role="doc-biblioref">2021</a>)</span> conducts a field experiment in South Africa in which treated households are assigned to receive an alarm that directly alerts police to criminal activity, in order to understand how increased access to formal policing channels may discourage mob violence. Outcomes are measured via survey, and embedded in the survey were two additional information treatments about how the police fight crime or fight mob violence. The design is therefore a 2x2x2 design, and indeed the author finds that the mob violence information treatment is more effective among those assigned an alarm in the field experiment.</p></li>
</ul></section></section><section id="sec-ch18s6" class="level2" data-number="18.6"><h2 data-number="18.6" class="anchored" data-anchor-id="sec-ch18s6">
<span class="header-section-number">18.6</span> Encouragement designs</h2>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>We declare an encouragement design in which units are assigned to be encouraged to take up a treatment and the average treatment effect is measured among those who comply with the encouragement. The declaration highlights the many changes to the design that are needed to consider noncompliance and what inquiries can be estimated with the design.</p>
</div>
</div>
</div>
<p>In many experimental settings, we cannot require units we <em>assign</em> to take treatment to actually <em>take</em> treatment. Nor can we require units assigned to the control group not to take treatment. Instead, we have to content ourselves with “encouraging” units assigned to the treatment group to take treatment and “encouraging” units assigned to the control group not to.</p>
<p>Encouragements are often only partially successful. Some units assigned to treatment refuse treatment and some units assigned to control find a way to obtain treatment after all. In these settings, we say that experiments encounter “noncompliance.” This section will describe the most common approach to the design and analysis of encouragement trials, and will point out potential pitfalls along the way.</p>
<p>Any time a data strategy entails contacting subjects in order to deliver a treatment like a bundle of information or some good, noncompliance is a potential problem. Emails go undelivered, unopened, and unread. Letters get lost in the mail. Phone calls are screened, text messages get blocked, direct messages on social media are ignored. People don’t come to the door when you knock, either because they aren’t home or because they don’t trust strangers. Noncompliance can affect non-informational treatments as well: goods may be difficult to deliver to remote locations, subjects may refuse to participate in assigned experimental activities, or research staff might simply fail to respect the realized treatment schedule.</p>
<p>Experimenters who anticipate noncompliance should make compensating adjustments to their research designs (relative to the canonical two-arm design). These adjustments ripple through <em>M</em>, <em>I</em>, <em>D</em>, and <em>A</em>.</p>
<section id="changes-to-the-model" class="level3" data-number="18.6.1"><h3 data-number="18.6.1" class="anchored" data-anchor-id="changes-to-the-model">
<span class="header-section-number">18.6.1</span> Changes to the model</h3>
<p>The biggest difference in <em>M</em> relative to the two arm trial is that we now need to provide beliefs about compliance types, also called “principal strata” <span class="citation" data-cites="frangakis2002principal">(<a href="../references.html#ref-frangakis2002principal" role="doc-biblioref">Frangakis and Rubin 2002</a>)</span>. In a two-arm trial, subjects can be one of four compliance types, depending on how their treatment status responds to their treatment assignment. The four types are described in <a href="#tbl-compliancetypes2" class="quarto-xref">Table&nbsp;<span>18.2</span></a>. <span class="math inline">\(D_i(Z_i = 0)\)</span> is a potential outcome – it is the treatment status that unit <span class="math inline">\(i\)</span> would express if assigned to control. Likewise, <span class="math inline">\(D_i(Z_i = 1)\)</span> is the treatment status that unit <span class="math inline">\(i\)</span> would express if assigned to treatment. These potential outcomes can each take on a value of 0 or 1, so their intersection allows for four types. For always-takers, <span class="math inline">\(D_i\)</span> is equal to 1 regardless of the value of <span class="math inline">\(Z\)</span> – they always take treatment. Never-takers are the opposite – <span class="math inline">\(D_i\)</span> is equal to 0 regardless of the value of <span class="math inline">\(Z_i\)</span>. For always-takers and never-takers, assignment to treatment <em>does not change</em> whether they take treatment.</p>
<p>Compliers are units that take treatment if assigned to treatment and do not take treatment if assigned to control. Their name “compliers” connotes that something about their disposition as subjects makes them “compliant” or otherwise docile, but this connotation is misleading. Compliance types are generated by the confluence of subject behavior and data strategy choices. Whether or not a subject answers the door when the canvasser comes calling is a function of many things, including whether the subject is at home and whether they open the door to canvassers. Data strategies that attempt to deliver treatments in the evenings or on weekends might generate more (or different) compliers than those that attempt treatment during working hours.</p>
<div id="tbl-compliancetypes2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-compliancetypes2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;18.2: Compliance types
</figcaption><div aria-describedby="tbl-compliancetypes2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<thead><tr class="header">
<th>Compliance Type</th>
<th><span class="math inline">\(D_i(Z_i = 0)\)</span></th>
<th><span class="math inline">\(D_i(Z_i = 1)\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Never-taker</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>Complier</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td>Defier</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<td>Always-taker</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The last compliance type to describe are defiers. These strange birds refuse treatment when assigned to treatment, but find a way to obtain treatment when assigned to control. Whether or not “defiers” exist turns out to be a consequential assumption that must be made in the model.</p>
<p>A unit’s compliance type is usually not possible to observe directly. Subjects assigned to the control group who take take treatment (<span class="math inline">\(D_i(0) = 1\)</span>) could be defiers or always-takers. Subjects assigned to the treatment group who do not take treatment (<span class="math inline">\(D_i(1) = 0\)</span>) could be defiers or never-takers. Our inability to be sure of compliance types is another facet of the fundamental problem of causal inference. Even though a subject’s compliance type (with respect to a given design) is a stable trait, it is defined by how the subject would act in multiple counterfactual worlds. We can’t tell what type a unit is because we would need to see whether they take treatment when assigned to treatment and also when assigned to control.</p>
</section><section id="changes-to-the-inquiry" class="level3" data-number="18.6.2"><h3 data-number="18.6.2" class="anchored" data-anchor-id="changes-to-the-inquiry">
<span class="header-section-number">18.6.2</span> Changes to the inquiry</h3>
<p>The inclusion of compliance types in the model accompanies changes to the inquiry. Always-takers and never-takers present a real problem for causal inference. Even with the power to randomly assign, we can’t change what treatments these units take. As a result, <em>we don’t get to learn</em> about the effects of treatment among these groups. Even if our inquiry were the average effect of treatment among the never-takers, the experiment (as designed) would not be able to generate empirical estimates of it.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> Our inquiry has to fall back to the average effects among those units whose treatment status we can affect: the compliers.</p>
<p>This inquiry is called the complier average causal effect (the CACE). It is defined as <span class="math inline">\(\mathbb{E}[Y_i(1) - Y_i(0) | d_i(1) &gt; d_i(0)]\)</span>. Just like the average treatment effect, it refers to an average over individual causal effects, but this average is taken over a specific subset of units, the compliers. Compliers are the only units for whom <span class="math inline">\(d_i(1) &gt; d_i(0)\)</span>, because for compliers, <span class="math inline">\(d_i(1) = 1\)</span> and <span class="math inline">\(d_i(0) = 0\)</span>. When assignments and treatments are binary, the CACE is mathematically identical to the local average treatment effect (LATE) described in <a href="observational-causal.html#sec-ch16s4" class="quarto-xref"><span>Section 16.4</span></a>. Whether we write CACE or LATE sometimes depends on academic discipline, with LATE being more common among economists and CATE more common among political scientists. An advantage of “CACE” over “LATE” is that it is specific about which units the effect is “local” to – it is local to the compliers.</p>
<p>When experiments encounter noncompliance, the CACE may well be the most important inquiry for theory, since it refers to an average effect of the causal variable, at least for a subset of the units in the study. However, two other common inquiries are important to address here as well.</p>
<p>The first is the intention-to-treat (ITT) inquiry, which is defined as <span class="math inline">\(\mathbb{E}[Y_i(D_i(Z = 1), Z = 1) - Y_i(D_i(Z = 0), Z = 0)]\)</span>. The encouragement itself <span class="math inline">\(Z\)</span> has a total effect on <span class="math inline">\(Y\)</span> that is mediated in whole or in part by the treatment status. Sometimes the ITT is the policy-relevant inquiry, since it describes what would happen if a policy maker implemented the policy in the same way as the experiment, <em>inclusive</em> of noncompliance. Consider an encouragement design to study the effectiveness of a tax webinar on tax compliance. Even if the webinar is very effective among people willing to watch it (the CACE is large), the main trouble faced by the policy maker will be getting people to sit through the webinar. The ITT describes the average effect of <em>inviting</em> people to the webinar, which could be quite small if very few people are willing to join.</p>
<p>The second additional inquiry is the compliance rate, sometimes referred to as the <span class="math inline">\(\mathrm{ITT}_{\textrm{D}}\)</span>. It describes the average effect of assignment on treatment, and is written <span class="math inline">\(\mathbb{E}[(D_i(Z = 1) - D_i(Z = 0)]\)</span>. A small bit of algebra shows that the <span class="math inline">\(\mathrm{ITT}_{\textrm{D}}\)</span> is equal to the fraction of the sample that are compliers minus the fraction that are defiers.</p>
<p>These three inquiries are tightly related. Under five very important assumptions discussed in <a href="observational-causal.html#sec-ch16s4" class="quarto-xref"><span>Section 16.4</span></a> on instrumental variables (see also <span class="citation" data-cites="angrist1996">Angrist, Imbens, and Rubin (<a href="../references.html#ref-angrist1996" role="doc-biblioref">1996</a>)</span>), we can write:</p>
<p><span class="math display">\[\begin{align*}
\mathrm{CACE} = \frac{\mathrm{ITT}}{\mathrm{ITT}_{\mathrm{D}}}
\end{align*}\]</span></p>
<p>In an experimental setting, the “exogeneity of the instrument” assumption is guaranteed by features of the data strategy. Since we use random assignment, we know for sure that the “instrument” (the encouragement) is exogenous. Excludability of the instrument refers to the idea that the effect of the encouragement on the outcome is fully mediated by the treatment. This assumption could be violated if the mere act of encouragement changes outcomes. Stated differently, if never-takers or always-takers reveal <em>different</em> potential outcomes in treatment and control (<span class="math inline">\(Y_i(D_i(Z = 1), Z = 1) \neq Y_i(D_i(Z = 0), Z = 0)\)</span>), it must be because encouragement itself changes outcomes. Noninterference in this setting means that units’ treatment status and outcomes do not depend on the assignment or treatment status of other units. In an experimental context, the assumption of monotonicity rules out the existence of defiers. This assumption is often made plausible by features of the data strategy (perhaps it is impossible for those who are not assigned to treatment to obtain treatment) or by theoretical considerations (“defiant” responses to encouragement are behaviorally unlikely). The final assumption – nonzero effect of the instrument on the treatment – can also be bolstered by features of the data strategy. In order to learn about the effects of treatment, data strategies must successfully encourage at least some units to take treatment.</p>
</section><section id="changes-to-the-data-strategy" class="level3" data-number="18.6.3"><h3 data-number="18.6.3" class="anchored" data-anchor-id="changes-to-the-data-strategy">
<span class="header-section-number">18.6.3</span> Changes to the data strategy</h3>
<p>When experimenters expect that noncompliance will be a problem, they should take steps to mitigate that problem in the data strategy. Sometimes doing so just means trying harder: investigating the patterns of noncompliance, attempting to deliver treatment on multiple occasions, or offering subjects incentives for participation. “Trying harder” is about turning more subjects into compliers by choosing a data strategy that encounters less noncompliance.</p>
<p>A second important change to the data strategy is the explicit measurement of treatment status as distinct from treatment assignment. For some designs, measuring treatment status is easy. We just record which units were treated and which were untreated. But in some settings, measuring compliance is trickier. For example, if treatments are emailed, we might never know if subjects read the email. Perhaps our email service will track read receipts, in which case one facet of this measurement problem is solved. We won’t know, however, how many subjects read the subject line – and if the subject line contains any treatment information, then even subjects who don’t click on the email may be “partially” treated. One approach is to measure compliance in the most conservative way: if treatment emails bounce altogether, then subjects are not treated.</p>
<p>In multi-arm trials or with continuous rather than binary instruments, noncompliance becomes a more complex problem to define and address through the data strategy and answer strategy. We must define complier types according to all of the possible treatment conditions. For multi-arm trials, the complier types for the first treatment may not be the same for the second treatment; in other words, units will comply at different rates to different treatments. Apparent differences in complier average treatment effects and intent-to-treat effects, as a result, may reflect not differences in treatment effects but different rates of compliance.</p>
</section><section id="changes-to-the-answer-strategy" class="level3" data-number="18.6.4"><h3 data-number="18.6.4" class="anchored" data-anchor-id="changes-to-the-answer-strategy">
<span class="header-section-number">18.6.4</span> Changes to the answer strategy</h3>
<p>Estimation of the CACE is not as straightforward subsetting the analysis to compliers (since we cannot observe who they are!). A plug-in estimator of the CACE with good properties takes the ratio of the <span class="math inline">\(ITT\)</span> estimate to the <span class="math inline">\(ITT_d\)</span> estimate. Since the <span class="math inline">\(ITT_d\)</span> must be a number between 0 and 1, this estimator “inflates” the <span class="math inline">\(ITT\)</span> by the compliance rate. Another way of thinking about this is that the <span class="math inline">\(ITT\)</span> is deflated by all the never-takers and always-takers, among whom the <span class="math inline">\(ITT\)</span> is by construction 0, so instead of “inflating”, we are “re-inflating” the ITT to the level of the CACE. Two-stage least squares in which we instrument the treatment with the random assignment is a numerically equivalent procedure when treatment and assignments are binary. Two-stage least squares has the further advantage of being able to seamlessly incorporate covariate information to increase precision.</p>
<p>Two alternative answer strategies are biased and should be avoided. An “as-treated” analysis ignores the encouragement <span class="math inline">\(Z\)</span> and instead compares units by their revealed treatment status <span class="math inline">\(D\)</span>. This procedure is prone to bias because those who come to be treated may differ systematically from those who do not. The “per protocol” analysis is similarly biased. It drops any unit that fails to comply with its assignment, but those who take treatment in the treatment group (compliers and always-takers) may differ systematically from those who do not take treatment in the control group (compliers and never-takers). Both the “as-treated” and “per-protocol” answer strategies suffer from a special case of posttreatment bias, wherein conditioning on a post-assignment variable (treatment status) essentially de-randomizes the study.</p>
<p><a href="#def-ch18num9" class="quarto-xref">Declaration&nbsp;<span>18.9</span></a> elaborates the model to include the four compliance types, setting the share of defiers to zero to match the assumption of monotonicity. It imagines that the potential outcomes of the outcomes <span class="math inline">\(Y\)</span> with respect to the treatment <span class="math inline">\(D\)</span> are different for each compliance type, reflecting the idea that compliance type could be correlated with potential outcomes. The declaration also links compliance type to the potential outcomes of the treatment <span class="math inline">\(D\)</span> with respect to the randomized encouragement <span class="math inline">\(Z\)</span>. We then move on to declaring two inquiries (the CACE and the ATE) and three answer strategies (two-stage least squares, as-treated analysis, and per-protocol analysis).</p>
<div id="def-ch18num8" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.8</strong></span> Encouragement design.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">declaration_18.8</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    type <span class="op">=</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Never-Taker"</span>, <span class="st">"Complier"</span>, <span class="st">"Defier"</span><span class="op">)</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.6</span>, <span class="fl">0.0</span><span class="op">)</span><span class="op">*</span><span class="va">N</span><span class="op">)</span>,</span>
<span>    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>    <span class="co"># potential outcomes of Y with respect to D</span></span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span></span>
<span>      <span class="va">Y</span> <span class="op">~</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>        <span class="va">type</span> <span class="op">==</span> <span class="st">"Always-Taker"</span> <span class="op">~</span> <span class="op">-</span><span class="fl">0.25</span> <span class="op">-</span> <span class="fl">0.50</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span> <span class="va">U</span>,</span>
<span>        <span class="va">type</span> <span class="op">==</span> <span class="st">"Never-Taker"</span> <span class="op">~</span> <span class="fl">0.75</span> <span class="op">-</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span> <span class="va">U</span>,</span>
<span>        <span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span> <span class="op">~</span> <span class="fl">0.25</span> <span class="op">+</span> <span class="fl">0.50</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span> <span class="va">U</span>,</span>
<span>        <span class="va">type</span> <span class="op">==</span> <span class="st">"Defier"</span> <span class="op">~</span> <span class="op">-</span><span class="fl">0.25</span> <span class="op">-</span> <span class="fl">0.50</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span> <span class="va">U</span></span>
<span>      <span class="op">)</span>,</span>
<span>      conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># potential outcomes of D with respect to Z</span></span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span></span>
<span>      <span class="va">D</span> <span class="op">~</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>        <span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Complier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>        <span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Never-Taker"</span>, <span class="st">"Defier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>        <span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Never-Taker"</span>, <span class="st">"Complier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>        <span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Always-Taker"</span>, <span class="st">"Defier"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span></span>
<span>      <span class="op">)</span>,</span>
<span>      conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span></span>
<span>    ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_D_1</span> <span class="op">-</span> <span class="va">Y_D_0</span><span class="op">)</span>,</span>
<span>    CACE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_D_1</span><span class="op">[</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span><span class="op">]</span> <span class="op">-</span> <span class="va">Y_D_0</span><span class="op">[</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">conduct_ra</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>D <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">D</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span>,</span>
<span>                      Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">D</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span></span>
<span>    <span class="va">Y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">|</span> <span class="va">Z</span>,</span>
<span>    .method <span class="op">=</span> <span class="va">iv_robust</span>,</span>
<span>    inquiry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ATE"</span>, <span class="st">"CACE"</span><span class="op">)</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"Two stage least squares"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span></span>
<span>    <span class="va">Y</span> <span class="op">~</span> <span class="va">D</span>,</span>
<span>    .method <span class="op">=</span> <span class="va">lm_robust</span>,</span>
<span>    inquiry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ATE"</span>, <span class="st">"CACE"</span><span class="op">)</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"As treated"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span></span>
<span>    <span class="va">Y</span> <span class="op">~</span> <span class="va">D</span>,</span>
<span>    .method <span class="op">=</span> <span class="va">lm_robust</span>,</span>
<span>    inquiry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ATE"</span>, <span class="st">"CACE"</span><span class="op">)</span>,</span>
<span>    subset <span class="op">=</span> <span class="va">D</span> <span class="op">==</span> <span class="va">Z</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"Per protocol"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p><a href="#fig-ch18num9" class="quarto-xref">Figure&nbsp;<span>18.9</span></a> represents the encouragement design as a DAG. No arrows lead into <span class="math inline">\(Z\)</span>, because the treatment was randomly assigned. The compliance type <span class="math inline">\(C\)</span>, the assignment <span class="math inline">\(Z\)</span>, and unobserved heterogeneity <span class="math inline">\(U\)</span> conspire to set the level of <span class="math inline">\(D\)</span>. The outcome <span class="math inline">\(Y\)</span> is affected by the treatment <span class="math inline">\(D\)</span> of course, but also by compliance type <span class="math inline">\(C\)</span> and unobserved heterogeneity <span class="math inline">\(U\)</span>. The required exclusion restriction that <span class="math inline">\(Z\)</span> only affect <span class="math inline">\(Y\)</span> through <span class="math inline">\(D\)</span> is represented by the <em>lack</em> of an arrow from <span class="math inline">\(Z\)</span> to <span class="math inline">\(Y\)</span>. The deficiencies of the as-treated and per-protocol analysis strategies can be learned from the DAG as well. <span class="math inline">\(D\)</span> is a collider, so conditioning on it would open up backdoor paths between <span class="math inline">\(Z\)</span>, <span class="math inline">\(C\)</span>, and <span class="math inline">\(U\)</span>, leading to bias of unknown direction and magnitude.</p>
<div id="fig-ch18num9" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-9.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="Figure&nbsp;18.9: Directed acyclic graph of the encouragement design"><img src="../figures/figure-18-9.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.9: Directed acyclic graph of the encouragement design
</figcaption></figure>
</div>
<div id="lem-ch18num9" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.9</strong></span> Diagnosis of encouragement design.</p>
<p>The design diagnosis shows the sampling distribution of the three answer strategies and compares it to two potential inquiries: the complier average causal effect and the average treatment effect. Our preferred method, two-stage least squares, is <em>biased</em> for the ATE. Because we can’t learn about the effects of treatment among never-takers or always-takers, any estimate of the true ATE will be necessarily be prone to bias, except in the happy circumstance that never-takers and always-takers happen to be just like compliers in terms of their potential outcomes.</p>
<p>Two-stage least squares does a much better job of estimating the complier average causal effect. Even though the sampling distribution is wider than those for the per-protocol and as-treated analysis, it is at least centered on a well-defined inquiry. By contrast, the other two answer strategies are biased for either target.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diagnosis_18.9</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">declaration_18.8</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-ch18num10" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-10.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Figure&nbsp;18.10: Sampling distributions of the two-stage least squares, per protocol, and as-treated answer strategies."><img src="../figures/figure-18-10.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num10-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.10: Sampling distributions of the two-stage least squares, per protocol, and as-treated answer strategies.
</figcaption></figure>
</div>
</div>
</section><section id="design-examples-5" class="level3" data-number="18.6.5"><h3 data-number="18.6.5" class="anchored" data-anchor-id="design-examples-5">
<span class="header-section-number">18.6.5</span> Design examples</h3>
<ul>
<li><p><span class="citation" data-cites="scacco_warren_2018">Scacco and Warren (<a href="../references.html#ref-scacco_warren_2018" role="doc-biblioref">2018</a>)</span> randomize young men in Nigeria to participate in a vocational training program – 84% of subjects assigned to the training participated, but the remainder did not. The authors attempted to measure outcomes for all subjects, regardless of treatment or compliance status and estimated intention-to-treat effects in all cases.</p></li>
<li><p><span class="citation" data-cites="blair_2022">Blair et al. (<a href="../references.html#ref-blair_2022" role="doc-biblioref">2022</a>)</span> randomize communities in Colombia to receive a program aimed at improving local governance through enhanced cooperation between state and local agencies. Some communities assigned to participate in the program did not participate, or did not participate fully. The authors present the intention-to-treat estimates of treatment effects as well as complier average causal effect estimates, varying the definition of compliance to include or exclude partial compliance. (Defining compliance as “any compliance including partial compliance” is the conservative choice, as defining partial compliers as noncompliers could violate excludability.)</p></li>
</ul></section></section><section id="sec-ch18s7" class="level2" data-number="18.7"><h2 data-number="18.7" class="anchored" data-anchor-id="sec-ch18s7">
<span class="header-section-number">18.7</span> Placebo-controlled experiments</h2>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>We compare an encouragement design to a placebo-controlled trial in which units are selected into treatment based on whether they receive <em>either</em> treatment or a placebo treatment with a similar deployment method. At low levels of compliance, the diagnosis reveals the placebo-controlled design is preferred, but then the encouragement design is preferred as compliance increases.</p>
</div>
</div>
</div>
<p>In common usage, the notion of a placebo is a treatment that carries with it everything about the bona fide treatment – except the active ingredient. We’re used to thinking about placebos in terms of the “placebo effect” in medical trials. Some portion of the total effect of the actual treatment is due to the mere act of <em>getting treated</em>, so the administration of placebo treatments can difference this portion off. Placebo-controlled designs abound in the social sciences, too; for similar purposes <span class="citation" data-cites="porter2021">(see <a href="../references.html#ref-porter2021" role="doc-biblioref">Porter and Velez 2021</a>)</span>. Media treatments often work through a bundle of priming effects and new information; a placebo treatment might include only the prime but not the information. The main use of placebos is to difference off the many small excludability violations involved in bundled treatments to better understand the main causal variable of interest.</p>
<p>In this chapter, we study the use of placebos for a different purpose: to combat the negative design consequences of noncompliance in experiments. As described in the previous chapter, a challenge for experiments that encounter noncompliance is that we do not know for sure who the compliers are. Compliers are units that would take treatment if assigned to treatment, but would not do so if assigned to control. Compliers are different from always-takers and never-takers in that assignment to treatment actually changes which potential outcome they reveal.</p>
<p>In the placebo-controlled design, we attempt to deliver a real treatment to the treatment group and a placebo treatment to the placebo group, then conduct our analysis among those units that accept either treatment. This design solves two problems at once. First, it lets us answer a <em>descriptive</em> question: “Who are the compliers?” Second, it lets answer a <em>causal</em> question: “What is the average effect of treatment among compliers?”</p>
<p>Employing a placebo control can seem like an odd design choice – you go through the effort of contacting a unit but at the very moment you get in touch, you deliver a placebo message instead of the treatment message. It turns out that despite this apparent waste, the placebo-controlled design can often lead to more precise estimates than the standard encouragement design. Whether it does or not depends in large part on the underlying compliance rate.</p>
<p><a href="#def-ch18num9" class="quarto-xref">Declaration&nbsp;<span>18.9</span></a> actually includes two separate designs. Here we’ll directly compare the standard encouragement design to the placebo-controlled design. They have identical models and inquiries, so we’ll just declare those once, before declaring the specifics of the empirical strategies for each design. The model has no always takers, which is a reasonable assumption if the treatment can only be provided through the researchers. When we use this model for the placebo design we will also assume that the compliance types are the same for both the treatment and the placebo conditions—that is, there is no differential selection conditional on contact.</p>
<div id="def-ch18num9" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.9</strong></span> Comparing the encouragement and placebo-controlled designs.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">compliance_rate</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span></span>
<span><span class="va">MI</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fl">400</span>,</span>
<span>    type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Never-Taker"</span>, <span class="st">"Complier"</span><span class="op">)</span>, </span>
<span>                  size <span class="op">=</span> <span class="va">N</span>,</span>
<span>                  prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">compliance_rate</span>, <span class="va">compliance_rate</span><span class="op">)</span>,</span>
<span>                  replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>    <span class="co"># potential outcomes of Y with respect to D</span></span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span></span>
<span>      <span class="va">Y</span> <span class="op">~</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>        <span class="va">type</span> <span class="op">==</span> <span class="st">"Never-Taker"</span> <span class="op">~</span> <span class="fl">0.75</span> <span class="op">-</span> <span class="fl">0.25</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span> <span class="va">U</span>,</span>
<span>        <span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span> <span class="op">~</span> <span class="fl">0.25</span> <span class="op">+</span> <span class="fl">0.50</span> <span class="op">*</span> <span class="va">D</span> <span class="op">+</span> <span class="va">U</span></span>
<span>      <span class="op">)</span>,</span>
<span>      conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># potential outcomes of D with respect to Z</span></span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span></span>
<span>      <span class="va">D</span> <span class="op">~</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>      conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span></span>
<span>    CACE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_D_1</span><span class="op">[</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span><span class="op">]</span> <span class="op">-</span> </span>
<span>                  <span class="va">Y_D_0</span><span class="op">[</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, again, are the data and answer strategies for the encouragement design (simplified from the previous chapter to focus on the one-sided compliance case, in which units can fail to take treatment but cannot take treatment if assigned to control). We conduct a random assignment among all units, then reveal treatment statuses and outcomes according to the potential outcomes declared in the model. The two-stage least squares estimator operates on all <span class="math inline">\(N\)</span> units to generate estimates of the CACE.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">declaration_18.9_encouragement</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">MI</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>D <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">D</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span>,</span>
<span>                      Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">D</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span></span>
<span>    <span class="va">Y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">|</span> <span class="va">Z</span>,</span>
<span>    .method <span class="op">=</span> <span class="va">iv_robust</span>,</span>
<span>    inquiry <span class="op">=</span> <span class="st">"CACE"</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"2SLS among all units"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By contrast, here are the data and answer strategies for the placebo-controlled design. In a typical canvassing experiment setting, the expensive part is sending canvassing teams to each household, regardless of whether a treatment or a placebo message is delivered when the door opens. So in order to keep things “fair” across the placebo-controlled and encouragement designs, we’re going to hold fixed the number of treatment attempts by sampling 200 of the 400 individuals to participate. Then among that subset, we conduct a random assignment to treatment or placebo. When we attempt to deliver the placebo or the treatment, we will either succeed or fail, which gives us a direct measure of whether a unit is a complier—made possible by the assumption that there are no always takers and that compliance types are the same in the treatment and placebo condition. This measurement is represented in the <code>declare_measurement</code> step, where an observable <code>X</code> now corresponds to compliance type. We conduct our estimation directly conditioning on the subset of the sample we have measured to be compliers.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">declaration_18.9_placebo</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">MI</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_sampling</span><span class="op">(</span>S <span class="op">=</span> <span class="fu">complete_rs</span><span class="op">(</span><span class="va">N</span>, n <span class="op">=</span> <span class="fl">200</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>X <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Complier"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                      D <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">D</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span>,</span>
<span>                      Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">D</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span></span>
<span>    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,</span>
<span>    subset <span class="op">=</span> <span class="va">X</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>    .method <span class="op">=</span> <span class="va">lm_robust</span>,</span>
<span>    inquiry <span class="op">=</span> <span class="st">"CACE"</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"OLS among compliers"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="lem-ch18num10" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.10</strong></span> Diagnosing the encouragement and placebo-controlled designs.</p>
<p>We diagnose both the encouragement design and the placebo-controlled design over a range of possible levels of noncompliance, focusing on the standard deviation of the estimates (the standard error) as our main diagnosand. <a href="#fig-ch18num11" class="quarto-xref">Figure&nbsp;<span>18.11</span></a> shows the results of the diagnosis. At high levels of compliance, the standard encouragement design actually outperforms the placebo-controlled design. But when compliance is low, the placebo-controlled design is preferred. Which design is preferable in any particular scenario will depend on the compliance rate as well as other design features like the total number of attempts and the fraction treated <span class="citation" data-cites="broockman_kalla_sekhon_2017">(see <a href="../references.html#ref-broockman_kalla_sekhon_2017" role="doc-biblioref">D. E. Broockman, Kalla, and Sekhon 2017</a>)</span>.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diagnosis_18.10_encouragment</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">declaration_18.9_encouragment</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">redesign</span><span class="op">(</span>compliance_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">diagnose_designs</span><span class="op">(</span>sims <span class="op">=</span> <span class="va">sims</span>, bootstrap_sims <span class="op">=</span> <span class="va">bootstrap_sims</span><span class="op">)</span></span>
<span></span>
<span><span class="va">diagnosis_18.10_placebo</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">declaration_18.9_placebo</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">redesign</span><span class="op">(</span>compliance_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">diagnose_designs</span><span class="op">(</span>sims <span class="op">=</span> <span class="va">sims</span>, bootstrap_sims <span class="op">=</span> <span class="va">bootstrap_sims</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-ch18num11" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-11.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Figure&nbsp;18.11: Comparison of the placebo-controlled design to a standard encouragment design"><img src="../figures/figure-18-11.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.11: Comparison of the placebo-controlled design to a standard encouragment design
</figcaption></figure>
</div>
</div>
<section id="design-examples-6" class="level3" data-number="18.7.1"><h3 data-number="18.7.1" class="anchored" data-anchor-id="design-examples-6">
<span class="header-section-number">18.7.1</span> Design examples</h3>
<ul>
<li><p><span class="citation" data-cites="broockman2016durably">D. Broockman and Kalla (<a href="../references.html#ref-broockman2016durably" role="doc-biblioref">2016</a>)</span> use a placebo-controlled design in their study of a transphobia-reduction canvassing treatment. Households were assigned either a placebo (a conversation about recycling) or the treatment; analysis was conducted among those who opened the door to the canvasser.</p></li>
<li><p><span class="citation" data-cites="wilke2020placebo">Wilke, Green, and Cooper (<a href="../references.html#ref-wilke2020placebo" role="doc-biblioref">2020</a>)</span> extend the placebo-controlled design in a media experiment in Uganda. Film festival attendees were assigned to watch public service announcements on one or two of three topics; posttreatment attitudes about all three topics were measured for all subjects. Subjects who saw the treatment on a given topic served as placebo controls for subjects who saw treatments on other topics. Under the maintained placebo assumption that treatments on one topic won’t affect attitudes on other topics, this design allows for efficient, unbiased inference for the effects of multiple treatments on their targeted outcomes.</p></li>
</ul></section></section><section id="stepped-wedge-experiments" class="level2" data-number="18.8"><h2 data-number="18.8" class="anchored" data-anchor-id="stepped-wedge-experiments">
<span class="header-section-number">18.8</span> Stepped-wedge experiments</h2>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>We declare a stepped-wedge design in which units are assigned a <em>sequence</em> of treatments across multiple periods. In each period, one third are treated successively. Diagnosis of this design and of similar-cost standard two-arm trials suggests that a double-sized two-arm trial is preferable in terms of power but that the stepped-wedge experiment is useful when the number of study units is limited.</p>
</div>
</div>
</div>
<p>We often face an ethical dilemma in allocating treatments to some units but not others, since we would rather not withhold treatment from anyone. However, practical constraints often make it impossible to allocate treatments to everyone at the same time. In these circumstances, a stepped-wedge experiment, also known as a waitlist design, can help. Under a stepped-wedge design, we follow an allocation rule that randomly assigns a portion of units to treatment in each of one or more periods, and then in a final period everyone is allocated treatment. We conduct posttreatment measurement after each period except for the last one. <a href="#fig-ch18num12" class="quarto-xref">Figure&nbsp;<span>18.12</span></a> illustrates the allocation procedure. A common design is allocating one third to treatment in the first period, an additional third in the second period, and the remaining third in the final period.</p>
<div id="fig-ch18num12" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-12.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Figure&nbsp;18.12: Illustration of random assignment in a stepped-wedge design."><img src="../figures/figure-18-12.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.12: Illustration of random assignment in a stepped-wedge design.
</figcaption></figure>
</div>
<p>Our model describes unit-specific effects, time-specific effects, and time trends in the potential outcomes. Our inquiry is the average treatment effect among time periods <em>before</em> the last period, since in the stepped-wedge design, we don’t obtain information about the control potential outcome in the final period. In the data strategy, we assign treatment by randomly assigning the wave in which each unit will receive treatment. We use cluster assignment at the unit level because the data is at the unit-period level. We then transform this treatment variable into a unit-period treatment indicator if the time period is at or after the treatment wave. The answer strategy also only uses the data from the first two periods (we probably would not collect outcome data after the last period for this reason). We fit a two-way fixed effects regression model by periods and units, with standard errors clustered at the unit level.</p>
<p>The stepped-wedge experimental design, described in <a href="#def-ch18num10" class="quarto-xref">Declaration&nbsp;<span>18.10</span></a>, shares much in common with the observational difference-in-differences design. We show in <a href="observational-causal.html#sec-ch16s3" class="quarto-xref"><span>Section 16.3</span></a> that the two-way fixed effects estimator is biased for the average treatment effect on the treated in the presence of treatment effect by time interactions. However, in the stepped-wedge design, we randomize treatment, so we do not need to make a parallel trends assumption. Our diagnosis below shows no bias when estimating the average treatment effect with the two-way fixed effects estimator in the stepped-wedge design even when treatment effects vary by period. A regression with only period effects would also return unbiased answers as would a design with inverse assignment probability weights described in <span class="citation" data-cites="Gerber2012">Gerber and Green (<a href="../references.html#ref-Gerber2012" role="doc-biblioref">2012</a>, ch.&nbsp;8)</span>, but if there are large unit differences the two-way design will be more efficient. Only including unit fixed effects, by contrast, without period effects, will yield biased answers, because the probabilities of assignment vary by round.</p>
<div id="def-ch18num10" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.10</strong></span> Stepped-wedge design.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">effect_size</span> <span class="op">&lt;-</span> <span class="fl">0.35</span></span>
<span></span>
<span><span class="va">declaration_18.10</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    units <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="fl">100</span>, </span>
<span>      U_unit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    periods <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="fl">3</span>,</span>
<span>      time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">periods</span><span class="op">)</span>,</span>
<span>      U_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>      nest <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span>,</span>
<span>    unit_period <span class="op">=</span> <span class="fu">cross_levels</span><span class="op">(</span></span>
<span>      by <span class="op">=</span> <span class="fu">join_using</span><span class="op">(</span><span class="va">units</span>, <span class="va">periods</span><span class="op">)</span>,</span>
<span>      U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>      <span class="fu">potential_outcomes</span><span class="op">(</span></span>
<span>        <span class="va">Y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">U_unit</span> <span class="op">+</span> <span class="va">U_time</span> <span class="op">+</span> <span class="va">time</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span> <span class="op">+</span> <span class="va">effect_size</span> <span class="op">*</span> <span class="va">Z</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span></span>
<span>    wave <span class="op">=</span> <span class="fu">cluster_ra</span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">units</span>, conditions <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">periods</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Z <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;=</span> <span class="va">wave</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span>, subset <span class="op">=</span> <span class="va">time</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, fixed_effects <span class="op">=</span> <span class="op">~</span> <span class="va">periods</span> <span class="op">+</span> <span class="va">units</span>, </span>
<span>                    clusters <span class="op">=</span> <span class="va">units</span>, </span>
<span>                    subset <span class="op">=</span> <span class="va">time</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>,</span>
<span>                    inquiry <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"TWFE"</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<section id="when-to-use-a-stepped-wedge-experiment" class="level3" data-number="18.8.1"><h3 data-number="18.8.1" class="anchored" data-anchor-id="when-to-use-a-stepped-wedge-experiment">
<span class="header-section-number">18.8.1</span> When to use a stepped-wedge experiment</h3>
<p>Compared to the equivalent two-arm randomized experiment, a stepped-wedge experiment involves the same number of units, but more treatment (all versus half) and more measurement (all units are measured at least twice). The decision of whether to adopt the stepped-wedge design, then, rides on budget, the relative costs of measurement and treatment, ethical and logistical constraints such as the imperative to treat all units, and beliefs about effect sizes and outcome variances.</p>
<p>We compare the stepped-wedge design to a two-arm randomized experiment with varying sample sizes to assess these trade-offs. First we compare designs with the same number of units, which would be the relevant comparison if the number of units is fixed. The second comparison is a two-arm experiment with double the number of units, which would be the right comparison if the number of units can be increased at some cost. We summarize each design in terms of the number of study units, the number that are treated, and the number of unit measurements taken.</p>
<div id="tbl-steppedwedgedesigns" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-steppedwedgedesigns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;18.3: Design parameters in the comparison between stepped-wedge and two-arm experimental designs.
</figcaption><div aria-describedby="tbl-steppedwedgedesigns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<thead><tr class="header">
<th>Design</th>
<th>N</th>
<th>m treated</th>
<th>n measurements</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Stepped-wedge</td>
<td>100</td>
<td>100</td>
<td>200</td>
</tr>
<tr class="even">
<td>Two-arm v1</td>
<td>100</td>
<td>50</td>
<td>100</td>
</tr>
<tr class="odd">
<td>Two-arm v2</td>
<td>200</td>
<td>100</td>
<td>200</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>We declare a comparable two-arm experimental design in <a href="#def-ch18num11" class="quarto-xref">Declaration&nbsp;<span>18.11</span></a>, with the wrinkle being that the estimand is slightly different by necessity. In the stepped-wedge design, we target the average treatment effect averaging over all periods up to the penultimate one, because there is no information about the control group from the last period. In a single period design, by its nature, we cannot average over time. We would obtain a biased answer if we targeted an out-of-sample time period. The average treatment effect we target is the current-period ATE for the period that is chosen. We cannot extrapolate beyond that if treatment effects vary over time. If we expect time heterogeneity in effects, we may <em>not</em> want to use a stepped-wedge design but instead to design a new experiment that efficiently targets the conditional average treatment effects within each period. Then we could describe both the average effect and how effects vary over time.</p>
<div id="def-ch18num11" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.11</strong></span> Comparison single-period two arm trial design.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">declaration_18.11</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="va">n_units</span>, </span>
<span>    U_unit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>    U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>    effect_size <span class="op">=</span> <span class="va">effect_size</span>,</span>
<span>    <span class="fu">potential_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">U_unit</span> <span class="op">+</span> <span class="va">U</span><span class="op">)</span> <span class="op">+</span> <span class="va">effect_size</span> <span class="op">*</span> <span class="va">Z</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span>Z <span class="op">=</span> <span class="fu">complete_ra</span><span class="op">(</span><span class="va">N</span>, m <span class="op">=</span> <span class="va">n_units</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span>ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1</span> <span class="op">-</span> <span class="va">Y_Z_0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, inquiry <span class="op">=</span> <span class="st">"ATE"</span>, label <span class="op">=</span> <span class="st">"DIM"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="lem-ch18num11" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.11</strong></span> Diagnosis of stepped-wedge design compared to two single-period two arm trial designs.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">design_stepped_wedge</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">declaration_18.11</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">redesign</span><span class="op">(</span>n_units <span class="op">=</span> <span class="fl">100</span>, effect_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">0.75</span>, by <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">design_single_period_100</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">declaration_18.11</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">redesign</span><span class="op">(</span>n_units <span class="op">=</span> <span class="fl">100</span>, effect_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">0.75</span>, by <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">design_single_period_200</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">declaration_18.11</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">redesign</span><span class="op">(</span>n_units <span class="op">=</span> <span class="fl">200</span>, effect_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="fl">0.75</span>, by <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">designs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">design_stepped_wedge</span>, <span class="va">design_single_period_100</span>, <span class="va">design_single_period_200</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">designs</span>, <span class="st">"names"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"design_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">designs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">diagnosis_18.11</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">designs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-ch18num13" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-13.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-13" title="Figure&nbsp;18.13: Power analysis of three designs: stepped wedge with 100 units and 1/3-1/3-1/3 allocation, two-arm experiment with 100 units, and two-arm experiment with 200 units."><img src="../figures/figure-18-13.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.13: Power analysis of three designs: stepped wedge with 100 units and 1/3-1/3-1/3 allocation, two-arm experiment with 100 units, and two-arm experiment with 200 units.
</figcaption></figure>
</div>
<p>We plot power curves for the three comparison designs in <a href="#fig-ch18num13" class="quarto-xref">Figure&nbsp;<span>18.13</span></a>. The top line (purple) is the 200-unit study, which is preferred in terms of power, and by a considerable margin. That design involves the same amount of measurement and treatment as the stepped-wedge design, so may have the same cost. However, if only 100 units are available for study, then the relevant comparison is between the stepped-wedge and the 100-unit two-arm study. Here, the stepped-wedge design is preferable in terms of power and may satisfy ethical requirements to eventually treat all subjects.</p>
</div>
</section><section id="design-examples-7" class="level3" data-number="18.8.2"><h3 data-number="18.8.2" class="anchored" data-anchor-id="design-examples-7">
<span class="header-section-number">18.8.2</span> Design examples</h3>
<ul>
<li><p><span class="citation" data-cites="gerber2011large">Gerber et al. (<a href="../references.html#ref-gerber2011large" role="doc-biblioref">2011</a>)</span> use a stepped-wedge design to randomize the timing of political television ads in 18 media markets in Texas in advance of a primary election.</p></li>
<li><p><span class="citation" data-cites="Pennycook:2021uk">Pennycook et al. (<a href="../references.html#ref-Pennycook:2021uk" role="doc-biblioref">2021</a>)</span> conduct an online field experiment with Twitter users who had shared links to untrustworthy Web sites. The authors randomized the timing of direct messages to those users, asking them to rate the accuracy of a nonpolitical headline, then observed the quality of the news articles they subsequently shared.</p></li>
</ul></section></section><section id="sec-ch18s9" class="level2" data-number="18.9"><h2 data-number="18.9" class="anchored" data-anchor-id="sec-ch18s9">
<span class="header-section-number">18.9</span> Randomized saturation experiments</h2>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>We declare a multilevel design in which we randomize first the “saturation” or probability of assignment with clusters and then randomly assign within the clusters based on that saturation probability. The diagnosis highlights that the efficiency for estimating the causal effect of the saturation level is low, because assignment is clustered, and is higher for estimating the individual treatment effect within clusters of a given saturation.</p>
</div>
</div>
</div>
<p>We study most treatments at an isolated, atomized, individualistic level. We define potential outcomes with respect to a unit’s own treatment status, ignoring the treatment status of all other units in the study. Accordingly, our inquiries tend to be averages of individual-level causal effects, and our data strategies tend to assign treatments at the individual level as well. All of the experimental designs we have considered to this point have been of this flavor.</p>
<p>However, when the potential outcome revealed by a unit depends on the treatment status of other units, then we have to make adjustments to every part of the design. We have to redefine the model <em>M</em> to specify what potential outcomes are possible. Under a no-spillover model, we might only have the treated and untreated potential outcomes, <span class="math inline">\(Y_i(1)\)</span> and <span class="math inline">\(Y_i(0)\)</span>. But under spillover models, we have to expand the set of possibilities. For example, we might imagine that unit <span class="math inline">\(i\)</span>’s potential outcomes can be written as a function of their own treatment status and that of their housemate, unit <span class="math inline">\(j\)</span>: <span class="math inline">\(Y_i(Z_i, Z_j)\)</span>. We have to redefine our inquiry <em>I</em> with respect to those reimagined potential outcomes. The average treatment effect is typically defined as <span class="math inline">\(\mathbb{E}[Y_i(1) - Y_i(0)]\)</span>, but if <span class="math inline">\(Y_i(1)\)</span> and <span class="math inline">\(Y_i(0)\)</span> are no longer well-defined, we need to choose a new inquiry, like the average direct effect of treatment when unit <span class="math inline">\(j\)</span> is not treated: <span class="math inline">\(\mathbb{E}[Y_i(1, 0) - Y_i(0, 0)]\)</span>. We have to alter our data strategy <em>D</em> so that the randomization procedure produces healthy samples of all of the potential outcomes involved in the inquiries, and we have to amend our answer strategy <em>A</em> to account for the important features of the new randomization protocol.</p>
<p>We divide up our investigation of experimental designs to learn about spillovers into two sets. This chapter addresses randomized saturation designs, which are appropriate when we can exploit a hierarchical clustering of subjects into groups within which spillover can occur but across which spillover can’t occur. The next chapter addresses experiments over networks, which are appropriate when spillover occurs over geographic, temporal, or social networks.</p>
<p>The randomized saturation design <span class="citation" data-cites="bairdetal2018">(sometimes called the partial population design, as in <a href="../references.html#ref-bairdetal2018" role="doc-biblioref">Baird et al. 2018</a>)</span> is purpose-built for scenarios in which we have good reason to imagine that a unit’s potential outcomes depend on the fraction of treated units within the same cluster. For example, we might want to consider the fraction of people within a neighborhood assigned to receive a vaccine: a person’s health outcomes could easily depend on whether two thirds or one third of neighbors have been treated.</p>
<p>In the model, we now have to define potential outcomes with respect to both the individual level treatment and also the saturation level. We can imagine a variety of different kinds of potential outcomes functions. Consider the vaccine example, imagining a 100% effective vaccine against infection. Directly treated individuals never contract the illness, but the probability of infection for untreated units depends on the fraction who are treated nearby. If the treatment is a persuasive message to vote for a particular candidate, we might imagine that direct treatment is ineffective when only a few people around you hear the message, but becomes much more effective when many people hear the message at the same time. The main challenge in developing intuitions about complex interactions like this is articulating the discrete potential outcomes that each subject could express, then reasoning about the plausible values for each potential outcome.</p>
<p>The randomized saturation design is a factorial design of sorts, and like any factorial design can support a number of different inquiries. We can describe the average effect of direct treatment at low saturation, at high saturation, the average of the two, or the difference between the two. Similarly, we could describe the average effect of high versus low saturation among the untreated, among the treated, the average of the two, or the difference between the two. In some settings, all eight of these inquiries might be appropriate to report, in others just a subset.</p>
<p>The design employs a two-stage data strategy. First, predefined clusters of units are randomly assigned to treatment saturation levels, for example, 25% or 75%. Then, in each cluster, individual units are assigned to treatment or control with probabilities determined by their clusters’ saturation level. The main answer strategy complication is that now there are two levels of randomization that must be respected. The saturation of treatment varies at the cluster level, so whenever we are estimating saturation effects, we have to cluster standard errors at the level saturation was assigned. The direct treatments are assigned at the individual level, so we do not need to cluster.</p>
<p><a href="#def-ch18num12" class="quarto-xref">Declaration&nbsp;<span>18.12</span></a> describes 50 groups of 20 individuals each. We imagine one source of unobserved variation at the group level (the <code>group_shock</code>) and another at the individual level (the <code>individual shock</code>). We build potential outcomes in which the individual and saturation treatment assignments each have additive (noninteracting) effects, though more complex potential outcomes functions are of course possible. We choose two inquiries in particular: the conditional average effect of saturation among the untreated and the conditional average effect of treatment when saturation is low.</p>
<p>We can learn about the effects of the dosage of indirect treatment by comparing units with the same individual treatment status across the levels of dosage. For example, we could compare untreated units across the 25% and 75% saturation clusters. We can also learn about the direct effects of treatment at either saturation level, e.g., the effect of treatment when saturation is low. We use difference-in-means estimators of both inquiries, subsetted and clustered appropriately.</p>
<div id="def-ch18num12" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.12</strong></span> Randomized saturation design.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">declaration_18.12</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    group <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">50</span>, group_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    individual <span class="op">=</span> <span class="fu">add_level</span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="fl">20</span>,</span>
<span>      individual_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,</span>
<span>      <span class="fu">potential_outcomes</span><span class="op">(</span></span>
<span>        <span class="va">Y</span> <span class="op">~</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="op">(</span><span class="va">S</span> <span class="op">==</span> <span class="st">"low"</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span><span class="va">S</span> <span class="op">==</span> <span class="st">"high"</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="va">group_shock</span> <span class="op">+</span> <span class="va">individual_shock</span>,</span>
<span>        conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                          S <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"low"</span>, <span class="st">"high"</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span></span>
<span>    CATE_S_Z_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_0_S_high</span> <span class="op">-</span> <span class="va">Y_Z_0_S_low</span><span class="op">)</span>,</span>
<span>    CATE_Z_S_low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_Z_1_S_low</span> <span class="op">-</span> <span class="va">Y_Z_0_S_low</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span></span>
<span>    S <span class="op">=</span> <span class="fu">cluster_ra</span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">group</span>, </span>
<span>                   conditions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"low"</span>, <span class="st">"high"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Z <span class="op">=</span> <span class="fu">block_ra</span><span class="op">(</span>blocks <span class="op">=</span> <span class="va">group</span>, </span>
<span>                 prob_unit <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="va">S</span> <span class="op">==</span> <span class="st">"low"</span>, <span class="fl">0.25</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span>Y <span class="op">=</span> <span class="fu">reveal_outcomes</span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">S</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span></span>
<span>    <span class="va">Y</span> <span class="op">~</span> <span class="va">S</span>,</span>
<span>    .method <span class="op">=</span> <span class="va">difference_in_means</span>,</span>
<span>    subset <span class="op">=</span> <span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>    term <span class="op">=</span> <span class="st">"Shigh"</span>,</span>
<span>    clusters <span class="op">=</span> <span class="va">group</span>,</span>
<span>    inquiry <span class="op">=</span> <span class="st">"CATE_S_Z_0"</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"Effect of high saturation among untreated"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span></span>
<span>    <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,</span>
<span>    .method <span class="op">=</span> <span class="va">difference_in_means</span>,</span>
<span>    subset <span class="op">=</span> <span class="va">S</span> <span class="op">==</span> <span class="st">"low"</span>,</span>
<span>    blocks <span class="op">=</span> <span class="va">group</span>,</span>
<span>    inquiry <span class="op">=</span> <span class="st">"CATE_Z_S_low"</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"Effect of treatment at low saturation"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="lem-ch18num12" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.12</strong></span> Randomized saturation diagnosis.</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diagnosis_18.12</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">declaration_18.12</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The diagnosis plot in <a href="#fig-ch18num14" class="quarto-xref">Figure&nbsp;<span>18.14</span></a> shows the sampling distribution of the two estimators with the value of the relevant inquiry overlaid. Both estimators are unbiased for their targets, but the thing to notice from this plot is that the estimator of the saturation inquiry is far more variable than the estimator of the direct treatment inquiry. Saturation is by its nature a group-level treatment, so must be assigned at a group level. The clustered nature of the assignment to saturation level brings extra uncertainty. When designing randomized saturation experiments, researchers should be aware that we typically have much better precision for individually randomized treatments than cluster-randomized treatments, and should plan accordingly.</p>
<div id="fig-ch18num14" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-14.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-14" title="Figure&nbsp;18.14: Sampling distributions of indirect and direct treatment effect estimators"><img src="../figures/figure-18-14.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.14: Sampling distributions of indirect and direct treatment effect estimators
</figcaption></figure>
</div>
</div>
<section id="design-examples-8" class="level3" data-number="18.9.1"><h3 data-number="18.9.1" class="anchored" data-anchor-id="design-examples-8">
<span class="header-section-number">18.9.1</span> Design examples</h3>
<ul>
<li><p><span class="citation" data-cites="cheema_khan_liaqat_mohmand_2022">Cheema et al. (<a href="../references.html#ref-cheema_khan_liaqat_mohmand_2022" role="doc-biblioref">2022</a>)</span> used a randomized saturation design in their study of a get-out-the-vote campaign in Pakistan. Wards could be assigned to one of three treatment conditions or to a control condition; within treated wards, four of five study households received the assigned condition but the fifth was assigned to control. A comparison of untreated households in treated wards to untreated households in untreated wards generates an estimate of the spillover effect (small and nonsignificant in this case).</p></li>
<li><p><span class="citation" data-cites="Egger2019">Egger et al. (<a href="../references.html#ref-Egger2019" role="doc-biblioref">2019</a>)</span> study how a cash transfer program implemented in one locality may affect outcomes in neighboring localities. In Kenya, the authors grouped villages into “saturation groups” and randomized the saturation groups to have one third or two thirds of their constituent villages assigned to treatment. A comparison of the untreated villages in the one third and two thirds saturation groups yields an estimate of the spillover effect.</p></li>
</ul></section></section><section id="sec-ch18s10" class="level2" data-number="18.10"><h2 data-number="18.10" class="anchored" data-anchor-id="sec-ch18s10">
<span class="header-section-number">18.10</span> Experiments over networks</h2>
<div class="callout callout-style-simple callout-note no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>We declare a design for a randomized trial in which the researcher controls the assignment of direct treatment, but then assesses the effects of direct treatment <em>and</em> of being indirectly treated by being geographically proximate to a unit directly treated. The diagnosis demonstrates both can be estimated without bias if the probability of indirect treatment is estimated through simulation, but that common estimators differ greatly in efficiency.</p>
</div>
</div>
</div>
<p>When experimental subjects are embedded in a network, units’ outcomes may depend on the treatment statuses of nearby units. In other words, treatments map spillover across the network. For example, in a geographic network, vote margin in one precinct may depend on outdoor advertisements in neighboring precincts. In a social network, information delivered to a treated subject might be shared with friends or followers. In a temporal network, treatments in the past might affect outcomes in the future.</p>
<p>This chapter describes the special challenges associated with experiments over networks. In the previous chapter, we discussed randomized saturation designs, which are appropriate when we can describe a hierarchy of units embedded in clusters, within which spillovers can occur but across which spillovers cannot occur. In other words, the randomized saturation design is appropriate when the network is composed of many disconnected network components (the clusters). But most networks are not disconnected. Instead, all or almost all units are typically connected in a vast web. This chapter describes how we need to modify the model, inquiry, data strategy, and answer strategy to learn from experiments over networks.</p>
<p>In the model, our main challenge is to define how far apart (in social, geographic, or temporal space) units have to be in order for unit <span class="math inline">\(i\)</span>’s potential outcomes not to depend on unit <span class="math inline">\(j\)</span>. We might say units within 5km matter, but units further away do not. We might say that units within two friendship links matter, but more distal connections do not. We might allow the treatment statuses of three, two, or one period ago to impact present outcomes differently from one another. For example, we might stipulate that each unit has only four potential outcomes that depend on whether a unit is directly treated or indirectly treated by virtue of being adjacent to a directly treated unit as in <a href="#tbl-networksconditions" class="quarto-xref">Table&nbsp;<span>18.4</span></a>.</p>
<div id="tbl-networksconditions" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-networksconditions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;18.4: Example treatment conditions for an experiment over a network.
</figcaption><div aria-describedby="tbl-networksconditions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 29%">
<col style="width: 70%">
</colgroup>
<thead><tr class="header">
<th>Condition</th>
<th>Potential outcomes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Pure control</td>
<td><span class="math inline">\(Y_i(\mathrm{direct} = 0, \mathrm{indirect} = 0)\)</span></td>
</tr>
<tr class="even">
<td>Direct only</td>
<td><span class="math inline">\(Y_i(\mathrm{direct} = 1, \mathrm{indirect} = 0)\)</span></td>
</tr>
<tr class="odd">
<td>Indirect only</td>
<td><span class="math inline">\(Y_i(\mathrm{direct} = 0, \mathrm{indirect} = 1)\)</span></td>
</tr>
<tr class="even">
<td>Direct and indirect</td>
<td><span class="math inline">\(Y_i(\mathrm{direct} = 1, \mathrm{indirect} = 1)\)</span></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>With potential outcomes defined, we can define inquiries. With four potential outcomes, there are six pairwise contrasts that we could contemplate. For example, the direct effect in the absence of indirect treatment is defined as <span class="math inline">\(\mathbb{E}[Y_i(\mathrm{direct} = 1, \mathrm{indirect} = 0) - Y_i(\mathrm{direct} = 0, \mathrm{indirect} = 0)]\)</span> and the direct effect in the presence of indirect treatment is <span class="math inline">\(\mathbb{E}[Y_i(\mathrm{direct} = 1, \mathrm{indirect} = 1) - Y_i(\mathrm{direct} = 0, \mathrm{indirect} = 1)]\)</span>. We could similarly define indirect effects as <span class="math inline">\(\mathbb{E}[Y_i(\mathrm{direct} = 0, \mathrm{indirect} = 1) - Y_i(\mathrm{direct} = 0, \mathrm{indirect} = 0)]\)</span> or <span class="math inline">\(\mathbb{E}[Y_i(\mathrm{direct} = 1, \mathrm{indirect} = 1) - Y_i(\mathrm{direct} = 1, \mathrm{indirect} = 0)]\)</span>. We may be interested in how direct and indirect treatments interact, which would require taking the difference between the two direct effect inquiries or taking the difference between the two indirect effect inquiries. Which inquiry is most appropriate will depend on the theoretical setting.</p>
<p>The data strategy for an experiment over networks still involves random assignment. Typically, however, experimenters are only in control of the direct treatment application, and exposure to indirect treatment results from the natural channels through which spillovers occur. The mapping from a direct treatment vector to the assumed set of treatment conditions is described by <span class="citation" data-cites="aronow2017estimating">Aronow and Samii (<a href="../references.html#ref-aronow2017estimating" role="doc-biblioref">2017</a>)</span> as an “exposure mapping.” The exposure mapping defines how the randomized treatment results in the exposures that reveal each potential outcome. The probabilities of assignment to each of the four conditions are importantly <em>not constant</em> across units, for the main reason that units with more neighbors are more likely to receive indirect treatment. Furthermore, exposures are dependent across units: if one unit is directly treated, then all adjacent units must be indirectly treated.</p>
<p>We need to adjust our answer strategy to compensate for the differential probabilities generated by this complex data strategy. As usual, we need to weight units by the inverse of the probability of assignment to the condition that they are in. In the networked setting we have to further account for dependence in treatment assignment probabilities. This dependence tends to increase sampling variability. For intuition, consider how clustering (an extreme form of across-unit dependence in treatment conditions) similarly tends to increase sampling variability. <span class="citation" data-cites="aronow2017estimating">Aronow and Samii (<a href="../references.html#ref-aronow2017estimating" role="doc-biblioref">2017</a>)</span> propose Hajek- and Horvitz-Thompson-style point and variance estimators that account for these complex joint probabilities of assignment, which are themselves estimated by simulating the exposures that would result from many thousands of possible random assignments.</p>
<p>To illustrate these ideas, we declare a hypothetical experimental design to estimate the effects of lawn signs <span class="citation" data-cites="green2016lawnsigns">(modeled after <a href="../references.html#ref-green2016lawnsigns" role="doc-biblioref">Green et al. 2016</a>)</span>. The units are the lowest level at which we can observe vote margin, the voting precinct. In our model, we define four potential outcomes. Precincts can be both directly and indirectly treated, only directly treated, only indirectly treated, or neither. Indirect treatment occurs when a neighboring precinct is treated. This model could support many possible inquiries, but here we will focus on three: the direct effect of treatment when the precinct is not indirectly treated, the effect of indirect treatment when the precinct is not directly treated, and the total effect of direct and indirect treatment versus pure control. The data strategy will involve randomly assigning some units to direct treatment, which will in turn cause other units to be indirectly treated. We will need to learn via simulation the probabilities of assignments to conditions that this procedure produces. We’ll make use of two answer strategies: the Horvitz-Thompson and Hajek estimators proposed by <span class="citation" data-cites="aronow2017estimating">Aronow and Samii (<a href="../references.html#ref-aronow2017estimating" role="doc-biblioref">2017</a>)</span>, along with their associated variance estimators, as implemented in the <code>interference</code> package.</p>
<p>To do this, we load the Fairfax County, Virginia, voting precincts shapefile, and remove the state capital which is not part of the county. We plot the precincts in <a href="#fig-ch18num5" class="quarto-xref">Figure&nbsp;<span>18.15</span></a>.</p>
<div id="fig-ch18num5" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-5.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-15" title="Figure&nbsp;18.15: Voting Precincts in Fairfax County, Virginia"><img src="../figures/figure-18-5.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.15: Voting Precincts in Fairfax County, Virginia
</figcaption></figure>
</div>
<p>To declare the full design, shown in <a href="#def-ch18num13" class="quarto-xref">Declaration&nbsp;<span>18.13</span></a>, we first need to obtain the adjacency matrix of precincts in Fairfax. Second, we obtain a permutation matrix of possible random assignments, from which probabilities of assignment to each condition can be calculated. The <code>declare_model</code> call builds in a dependence of potential outcomes on the length of each precinct’s perimeter to reflect the idea that outcomes are correlated with geography in some way. The <code>declare_inquiry</code> call describes the three inquiries in terms of potential outcomes. The <code>declare_assignment</code> call first conducts a random assignment according to the procedure described by <code>declare_ra</code> earlier in the code, then obtains the exposures that the assignment generates. Finally, all the relevant information is fed into the Aronow and Samii estimation functions via <code>estimator_AS</code> (the <code>get_exposure_AS</code> and <code>estimator_AS</code> helper functions are available in the <code>rdss</code> package).</p>
<div id="def-ch18num13" class="declaration theorem definition">
<p><span class="theorem-title"><strong>Declaration 18.13</strong></span> Experiments over spatial networks design.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">rdss</span><span class="op">)</span> <span class="co"># for helper functions</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/">spdep</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">interference</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Here we obtain the adjacency matrix</span></span>
<span><span class="va">adj_matrix</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">fairfax</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="st">"Spatial"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html">poly2nb</a></span><span class="op">(</span>queen <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2mat.html">nb2mat</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"B"</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Here we create a permutation matrix of possible random assignments</span></span>
<span><span class="va">ra_declaration</span> <span class="op">&lt;-</span> <span class="fu">declare_ra</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">238</span>, prob <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">permutatation_matrix</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">ra_declaration</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">obtain_permutation_matrix</span><span class="op">(</span>maximum_permutations <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">declaration_18.13</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">declare_model</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu">select</span><span class="op">(</span><span class="fu">as_tibble</span><span class="op">(</span><span class="va">fairfax</span><span class="op">)</span>, <span class="op">-</span><span class="va">geometry</span><span class="op">)</span>,</span>
<span>    Y_0_0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">SHAPE_LEN</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>    Y_1_0 <span class="op">=</span> <span class="va">Y_0_0</span> <span class="op">+</span> <span class="fl">0.02</span>,</span>
<span>    Y_0_1 <span class="op">=</span> <span class="va">Y_0_0</span> <span class="op">+</span> <span class="fl">0.01</span>,</span>
<span>    Y_1_1 <span class="op">=</span> <span class="va">Y_0_0</span> <span class="op">+</span> <span class="fl">0.03</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_inquiry</span><span class="op">(</span></span>
<span>    total_ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_1_1</span> <span class="op">-</span> <span class="va">Y_0_0</span><span class="op">)</span>,</span>
<span>    direct_ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_1_0</span> <span class="op">-</span> <span class="va">Y_0_0</span><span class="op">)</span>,</span>
<span>    indirect_ATE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Y_0_1</span> <span class="op">-</span> <span class="va">Y_0_0</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_assignment</span><span class="op">(</span></span>
<span>    Z <span class="op">=</span> <span class="fu">conduct_ra</span><span class="op">(</span><span class="va">ra_declaration</span><span class="op">)</span>,</span>
<span>    exposure <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rdss/man/get_exposure_AS.html">get_exposure_AS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/interference/man/make_exposure_map_AS.html">make_exposure_map_AS</a></span><span class="op">(</span><span class="va">adj_matrix</span>, <span class="va">Z</span>, hop <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_measurement</span><span class="op">(</span></span>
<span>    Y <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>      <span class="va">exposure</span> <span class="op">==</span> <span class="st">"dir_ind1"</span> <span class="op">~</span> <span class="va">Y_1_1</span>,</span>
<span>      <span class="va">exposure</span> <span class="op">==</span> <span class="st">"isol_dir"</span> <span class="op">~</span> <span class="va">Y_1_0</span>,</span>
<span>      <span class="va">exposure</span> <span class="op">==</span> <span class="st">"ind1"</span> <span class="op">~</span> <span class="va">Y_0_1</span>,</span>
<span>      <span class="va">exposure</span> <span class="op">==</span> <span class="st">"no"</span> <span class="op">~</span> <span class="va">Y_0_0</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">declare_estimator</span><span class="op">(</span>handler <span class="op">=</span> <span class="va">estimator_AS_tidy</span>, </span>
<span>                    permutatation_matrix <span class="op">=</span> <span class="va">permutatation_matrix</span>, </span>
<span>                    adj_matrix <span class="op">=</span> <span class="va">adj_matrix</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The maps in <a href="#fig-ch18num16" class="quarto-xref">Figure&nbsp;<span>18.16</span></a> show how this procedure generates differential probabilities of assignment to each exposure condition. Units that are in denser areas of the county are more likely to be in the <code>Indirect Exposure Only</code> and <code>Direct and Indirect Exposure</code> conditions than those in less dense areas.</p>
<div id="fig-ch18num16" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num16-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-16.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-16" title="Figure&nbsp;18.16: Probabilities of assignment to each of four conditions depend on position in geographic space."><img src="../figures/figure-18-16.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num16-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.16: Probabilities of assignment to each of four conditions depend on position in geographic space.
</figcaption></figure>
</div>
<div id="lem-ch18num13" class="theorem lemma">
<p><span class="theorem-title"><strong>Diagnosis 18.13</strong></span> Experiments over spatial networks diagnosis.</p>
<p><a href="#fig-ch18num17" class="quarto-xref">Figure&nbsp;<span>18.17</span></a> compares the performance of the Hajek and Horvitz-Thompson estimators. Both are approximately unbiased for their targets, but the Horvitz-Thompson estimator exhibits much higher variance, suggesting that in many design settings, researchers will want to opt for the Hajek estimator.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diagnosis_18.13</span> <span class="op">&lt;-</span> <span class="fu">diagnose_design</span><span class="op">(</span><span class="va">declaration_18.13</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-ch18num17" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ch18num17-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../figures/figure-18-17.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-17" title="Figure&nbsp;18.17: Sampling distribution of the Hajek and Horvitz-Thompson estimators of direct, indirect, and direct plus indirect effects. The vertical lines refer to the true values of the inquiries."><img src="../figures/figure-18-17.svg" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ch18num17-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18.17: Sampling distribution of the Hajek and Horvitz-Thompson estimators of direct, indirect, and direct plus indirect effects. The vertical lines refer to the true values of the inquiries.
</figcaption></figure>
</div>
</div>
<section id="design-examples-9" class="level3" data-number="18.10.1"><h3 data-number="18.10.1" class="anchored" data-anchor-id="design-examples-9">
<span class="header-section-number">18.10.1</span> Design examples</h3>
<ul>
<li><p><span class="citation" data-cites="zelizer_2019">Zelizer (<a href="../references.html#ref-zelizer_2019" role="doc-biblioref">2019</a>)</span> conducts experiments within a legislative network defined by office-sharing. Legislators were randomly assigned briefings on a subset of bills and their decision to cosponsor the bill (or not) was recorded. The design was able to estimate spillover effects bill by comparing legislators whose office mates were and were not assigned to treatment on various bills.</p></li>
<li><p><span class="citation" data-cites="green2016lawnsigns">Green et al. (<a href="../references.html#ref-green2016lawnsigns" role="doc-biblioref">2016</a>)</span> conducts a randomized experiment within a geographic network of adjacent voting precincts. Treated units were assigned many lawn signs supporting a candidate. The design supported inference on the direct effects (treated units relative to untreated units surrounded by untreated units) and the indirect effects (untreated units adjacent to treated units relative to untreated units surrounded by untreated units). The answer strategy accounted for the different probabilities of assignment to each of these conditions depending on geographic network position.</p></li>
</ul>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-angrist1996" class="csl-entry" role="listitem">
Angrist, Joshua D., Guido W. Imbens, and Donald B. Rubin. 1996. <span>“Identification of Causal Effects Using Instrumental Variables.”</span> <em>Journal of the American Statistical Association</em> 91 (434): 444–55.
</div>
<div id="ref-aronow2017estimating" class="csl-entry" role="listitem">
Aronow, Peter M., and Cyrus Samii. 2017. <span>“Estimating Average Causal Effects Under General Interference, with Application to a Social Network Experiment.”</span> <em>The Annals of Applied Statistics</em> 11 (4): 1912–47.
</div>
<div id="ref-bairdetal2018" class="csl-entry" role="listitem">
Baird, Sarah, J. Aislinn Bohren, Craig McIntosh, and Berk Ozler. 2018. <span>“<span class="nocase">Optimal Design of Experiments in the Presence of Interference</span>.”</span> <em><span>Review of Economics &amp; Statistics</span></em> 5 (100): 844–60.
</div>
<div id="ref-balcells2022transitional" class="csl-entry" role="listitem">
Balcells, Laia, Valeria Palanza, and Elsa Voytas. 2022. <span>“Do Transitional Justice Museums Persuade Visitors? Evidence from a Field Experiment.”</span> <em>The Journal of Politics</em> 84 (1).
</div>
<div id="ref-blair_2022" class="csl-entry" role="listitem">
Blair, Robert A., Manuel Moscoso-Rojas, Andres Vargas Castillo, and Michael Weintraub. 2022. <span>“Preventing Rebel Resurgence After Civil War: A Field Experiment in Security and Justice Provision in Rural Colombia.”</span> <em>American Political Science Review</em>, 1–20.
</div>
<div id="ref-broockman_kalla_sekhon_2017" class="csl-entry" role="listitem">
Broockman, David E., Joshua L. Kalla, and Jasjeet S. Sekhon. 2017. <span>“The Design of Field Experiments with Survey Outcomes: A Framework for Selecting More Efficient, Robust, and Ethical Designs.”</span> <em>Political Analysis</em> 25 (4): 435–64.
</div>
<div id="ref-broockman2016durably" class="csl-entry" role="listitem">
Broockman, David, and Joshua Kalla. 2016. <span>“Durably Reducing Transphobia: A Field Experiment on Door-to-Door Canvassing.”</span> <em>Science</em> 352 (6282): 220–24.
</div>
<div id="ref-cheema_khan_liaqat_mohmand_2022" class="csl-entry" role="listitem">
Cheema, Ali, Sarah Khan, Asad Liaqat, and Shandana Khan Mohmand. 2022. <span>“Canvassing the Gatekeepers: A Field Experiment to Increase Women Voters’ Turnout in Pakistan.”</span> <em>American Political Science Review</em>, 1–21.
</div>
<div id="ref-collins_2021" class="csl-entry" role="listitem">
Collins, Jonathan E. 2021. <span>“Does the Meeting Style Matter? The Effects of Exposure to Participatory and Deliberative School Board Meetings.”</span> <em>American Political Science Review</em> 115 (3): 790–804.
</div>
<div id="ref-Egger2019" class="csl-entry" role="listitem">
Egger, Dennis, Johannes Haushofer, Edward Miguel, Paul Niehaus, and Michael W Walker. 2019. <span>“General Equilibrium Effects of Cash Transfers: Experimental Evidence from Kenya.”</span> Working Paper 26600. National Bureau of Economic Research.
</div>
<div id="ref-frangakis2002principal" class="csl-entry" role="listitem">
Frangakis, Constantine E., and Donald B Rubin. 2002. <span>“Principal Stratification in Causal Inference.”</span> <em>Biometrics</em> 58 (1): 21–29.
</div>
<div id="ref-freedman2008regression" class="csl-entry" role="listitem">
Freedman, David A. 2008. <span>“On Regression Adjustments to Experimental Data.”</span> <em>Advances in Applied Mathematics</em> 40 (2): 180–93.
</div>
<div id="ref-gerber2011large" class="csl-entry" role="listitem">
Gerber, Alan S., James G. Gimpel, Donald P. Green, and Daron R. Shaw. 2011. <span>“How Large and Long-Lasting Are the Persuasive Effects of Televised Campaign Ads? Results from a Randomized Field Experiment.”</span> <em>American Political Science Review</em> 105 (1): 135–50.
</div>
<div id="ref-Gerber2012" class="csl-entry" role="listitem">
Gerber, Alan S., and Donald P. Green. 2012. <em><span class="nocase">Field Experiments: Design, Analysis, and Interpretation</span></em>. New York: W.W. Norton.
</div>
<div id="ref-green2016lawnsigns" class="csl-entry" role="listitem">
Green, Donald P., Jonathan S. Krasno, Alexander Coppock, Benjamin D. Farrer, Brandon Lenoir, and Joshua N. Zingher. 2016. <span>“The Effects of Lawn Signs on Vote Outcomes: Results from Four Randomized Field Experiments.”</span> <em>Electoral Studies</em> 41: 143–50.
</div>
<div id="ref-imai2009essential" class="csl-entry" role="listitem">
Imai, Kosuke, Gary King, and Clayton Nall. 2009. <span>“The Essential Role of Pair Matching in Cluster-Randomized Experiments, with Application to the Mexican Universal Health Insurance Evaluation.”</span> <em>Statistical Science</em> 24 (1): 29–53.
</div>
<div id="ref-Jamison2019" class="csl-entry" role="listitem">
Jamison, Julian C. 2019. <span>“The Entry of Randomized Assignment into the Social Sciences.”</span> <em>Journal of Causal Inference</em> 7 (1): 1–16.
</div>
<div id="ref-Kalla2018" class="csl-entry" role="listitem">
Kalla, Joshua, Frances Rosenbluth, and Dawn Langan Teele. 2018. <span>“Are You My Mentor? A Field Experiment on Gender, Ethnicity, and Political Self-Starters.”</span> <em>The Journal of Politics</em> 80 (1): 337–41.
</div>
<div id="ref-karpowitz2017elect" class="csl-entry" role="listitem">
Karpowitz, Christopher F., J. Quin Monson, and Jessica Robinson Preece. 2017. <span>“How to Elect More Women: Gender and Candidate Success in a Field Experiment.”</span> <em>American Journal of Political Science</em> 61 (4): 927–43.
</div>
<div id="ref-klar2019identities" class="csl-entry" role="listitem">
Klar, Samara, and Thomas J Leeper. 2019. <span>“Identities and Intersectionality: A Case for Purposive Sampling in Survey-Experimental Research.”</span> <em>Experimental Methods in Survey Research: Techniques That Combine Random Sampling with Random Assignment</em>, 419–33.
</div>
<div id="ref-lin2013agnostic" class="csl-entry" role="listitem">
Lin, Winston. 2013. <span>“Agnostic Notes on Regression Adjustments to Experimental Data: Reexamining Freedman’s Critique.”</span> <em>Annals of Applied Statistics</em> 7 (1): 295–318.
</div>
<div id="ref-lyall_zhou_imai_2020" class="csl-entry" role="listitem">
Lyall, Jason, Yang-Yang Zhou, and Kosuke Imai. 2020. <span>“Can Economic Assistance Shape Combatant Support in Wartime? Experimental Evidence from Afghanistan.”</span> <em>American Political Science Review</em> 114 (1): 126–43.
</div>
<div id="ref-middleton2008bias" class="csl-entry" role="listitem">
Middleton, Joel A. 2008. <span>“Bias of the Regression Estimator for Experiments Using Clustered Random Assignment.”</span> <em>Statistics &amp; Probability Letters</em> 78 (16): 2654–59.
</div>
<div id="ref-mousa2020building" class="csl-entry" role="listitem">
Mousa, Salma. 2020. <span>“Building Social Cohesion Between Christians and Muslims Through Soccer in Post-ISIS Iraq.”</span> <em>Science</em> 369 (6505): 866–70.
</div>
<div id="ref-paluck_green_2009" class="csl-entry" role="listitem">
Paluck, Elizabeth Levy, and Donald P. Green. 2009. <span>“Deference, Dissent, and Dispute Resolution: An Experimental Intervention Using Mass Media to Change Norms and Behavior in Rwanda.”</span> <em>American Political Science Review</em> 103 (4): 622–44.
</div>
<div id="ref-Pennycook:2021uk" class="csl-entry" role="listitem">
Pennycook, Gordon, Ziv Epstein, Mohsen Mosleh, Antonio A. Arechar, Dean Eckles, and David G. Rand. 2021. <span>“Shifting Attention to Accuracy Can Reduce Misinformation Online.”</span> <em>Nature</em> 592 (7855): 590–95.
</div>
<div id="ref-Peyton2019" class="csl-entry" role="listitem">
Peyton, Kyle, Michael Sierra-Arévalo, and David G. Rand. 2019. <span>“A Field Experiment on Community Policing and Police Legitimacy.”</span> <em>Proceedings of the National Academy of Sciences</em> 116 (40): 19894–98.
</div>
<div id="ref-porter2021" class="csl-entry" role="listitem">
Porter, Ethan, and Yamil Velez. 2021. <span>“Placebo Selection in Survey Experiments: An Agnostic Approach.”</span> <em>Political Analysis</em>, 1–14.
</div>
<div id="ref-Rubin1980" class="csl-entry" role="listitem">
Rubin, Donald B. 1980. <span>“Randomization Analysis of Experimental Data: The Fisher Randomization Test Comment.”</span> <em>Journal of the American Statistical Association</em> 75 (371): 591–93.
</div>
<div id="ref-scacco_warren_2018" class="csl-entry" role="listitem">
Scacco, Alexandra, and Shana S. Warren. 2018. <span>“Can Social Contact Reduce Prejudice and Discrimination? Evidence from a Field Experiment in Nigeria.”</span> <em>American Political Science Review</em> 112 (3): 654–77.
</div>
<div id="ref-Swire2017" class="csl-entry" role="listitem">
Swire, Briony, Adam J. Berinsky, Stephan Lewandowsky, and Ullrich K. H. Ecker. 2017. <span>“Processing Political Misinformation: Comprehending the Trump Phenomenon.”</span> <em>Royal Society Open Science</em> 4 (3): 1–21.
</div>
<div id="ref-wilke2021does" class="csl-entry" role="listitem">
Wilke, Anna M. 2021. <span>“How Does the State Replace the Community? Experimental Evidence on Crime Control from South Africa.”</span> <em>Unpublished Manuscript</em>.
</div>
<div id="ref-wilke2020placebo" class="csl-entry" role="listitem">
Wilke, Anna M., Donald P. Green, and Jasper Cooper. 2020. <span>“A Placebo Design to Detect Spillovers from an Education–Entertainment Experiment in Uganda.”</span> <em>Journal of the Royal Statistical Society: Series A (Statistics in Society)</em> 183 (3): 1075–96.
</div>
<div id="ref-zelizer_2019" class="csl-entry" role="listitem">
Zelizer, Adam. 2019. <span>“Is Position-Taking Contagious? Evidence of Cue-Taking from Two Field Experiments in a State Legislature.”</span> <em>American Political Science Review</em> 113 (2): 340–52.
</div>
</div>
</section></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>One mistake sometimes made by new experimenters is to conduct <em>simple</em> random assignment within each block. None of the gains from blocking described here apply if simple random assignment is conducted in each block, because that procedure produces the identical randomization distribution as a simple random assignment procedure without any blocking (provided that the probability of assignment is the same in each block).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><span class="citation" data-cites="klar2019identities">Klar and Leeper (<a href="../references.html#ref-klar2019identities" role="doc-biblioref">2019</a>)</span> make a similar point when specifically advocating for oversampling minority groups in experimental studies of intersectionality.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>We write “as designed” because compliance types are defined with respect to a particular design. If it were possible to induce the never-takers to take treatment (i.e., under a different data strategy, these units might be compliers), this inquiry would not necessarily be out of reach.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../library/experimental-descriptive.html" class="pagination-link" aria-label="Experimental : descriptive">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Experimental : descriptive</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../library/complex.html" class="pagination-link" aria-label="Complex designs">
        <span class="nav-page-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Complex designs</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>


</body></html>